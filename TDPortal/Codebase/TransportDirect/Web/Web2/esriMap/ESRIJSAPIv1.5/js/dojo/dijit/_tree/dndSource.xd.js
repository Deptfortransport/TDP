/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dijit._tree.dndSource"],["require","dijit._tree.dndSelector"],["require","dojo.dnd.Manager"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dijit._tree.dndSource"]){_4._hasResource["dijit._tree.dndSource"]=true;_4.provide("dijit._tree.dndSource");_4.require("dijit._tree.dndSelector");_4.require("dojo.dnd.Manager");_4.declare("dijit._tree.dndSource",_5._tree.dndSelector,{isSource:true,accept:["text"],copyOnly:false,dragThreshold:0,betweenThreshold:0,skipForm:false,constructor:function(_7,_8){if(!_8){_8={};}_4.mixin(this,_8);this.isSource=typeof _8.isSource=="undefined"?true:_8.isSource;var _9=_8.accept instanceof Array?_8.accept:["text"];this.accept=null;if(_9.length){this.accept={};for(var i=0;i<_9.length;++i){this.accept[_9[i]]=1;}}this.isDragging=false;this.mouseDown=false;this.targetAnchor=null;this.targetBox=null;this.dropPosition="";this._lastX=0;this._lastY=0;this.sourceState="";if(this.isSource){_4.addClass(this.node,"dojoDndSource");}this.targetState="";if(this.accept){_4.addClass(this.node,"dojoDndTarget");}this.topics=[_4.subscribe("/dnd/source/over",this,"onDndSourceOver"),_4.subscribe("/dnd/start",this,"onDndStart"),_4.subscribe("/dnd/drop",this,"onDndDrop"),_4.subscribe("/dnd/cancel",this,"onDndCancel")];this.events.push(_4.connect(this.node,"onmousemove",this,"onMouseMove"));},startup:function(){},checkAcceptance:function(_b,_c){return true;},copyState:function(_d){return this.copyOnly||_d;},destroy:function(){this.inherited("destroy",arguments);_4.forEach(this.topics,_4.unsubscribe);this.targetAnchor=null;},_onDragMouse:function(e){var m=_4.dnd.manager(),_10=this.targetAnchor,_11=this.current,_12=this.currentWidget,_13=this.dropPosition;var _14="Over";if(_11&&this.betweenThreshold>0){if(!this.targetBox||_10!=_11){this.targetBox={xy:_4.coords(_11,true),w:_11.offsetWidth,h:_11.offsetHeight};}if((e.pageY-this.targetBox.xy.y)<=this.betweenThreshold){_14="Before";}else{if((e.pageY-this.targetBox.xy.y)>=(this.targetBox.h-this.betweenThreshold)){_14="After";}}}if(_11!=_10||_14!=_13){if(_10){this._removeItemClass(_10,_13);}if(_11){this._addItemClass(_11,_14);}if(!_11){m.canDrop(false);}else{if(_12==this.tree.rootNode&&_14!="Over"){m.canDrop(false);}else{if(m.source==this&&(_11.id in this.selection)){m.canDrop(false);}else{if(this.checkItemAcceptance(_11,m.source,_14.toLowerCase())){m.canDrop(true);}else{m.canDrop(false);}}}}this.targetAnchor=_11;this.dropPosition=_14;}},onMouseMove:function(e){if(this.isDragging&&this.targetState=="Disabled"){return;}var m=_4.dnd.manager();if(this.isDragging){if(this.betweenThreshold>0){this._onDragMouse(e);}}else{if(this.mouseDown&&this.isSource&&(Math.abs(e.pageX-this._lastX)>=this.dragThreshold||Math.abs(e.pageY-this._lastY)>=this.dragThreshold)){var n=this.getSelectedNodes();var _18=[];for(var i in n){_18.push(n[i]);}if(_18.length){m.startDrag(this,_18,this.copyState(_4.dnd.getCopyKeyState(e)));}}}},onMouseDown:function(e){this.mouseDown=true;this.mouseButton=e.button;this._lastX=e.pageX;this._lastY=e.pageY;this.inherited("onMouseDown",arguments);},onMouseUp:function(e){if(this.mouseDown){this.mouseDown=false;this.inherited("onMouseUp",arguments);}},onMouseOver:function(_1c,e){this.inherited(arguments);if(this.isDragging){this._onDragMouse(e);}},onMouseOut:function(){this.inherited(arguments);this._unmarkTargetAnchor();},checkItemAcceptance:function(_1e,_1f,_20){return true;},onDndSourceOver:function(_21){if(this!=_21){this.mouseDown=false;this._unmarkTargetAnchor();}else{if(this.isDragging){var m=_4.dnd.manager();m.canDrop(false);}}},onDndStart:function(_23,_24,_25){if(this.isSource){this._changeState("Source",this==_23?(_25?"Copied":"Moved"):"");}var _26=this.checkAcceptance(_23,_24);this._changeState("Target",_26?"":"Disabled");if(_26){_4.dnd.manager().overSource(this);}this.isDragging=true;},itemCreator:function(_27){return _4.map(_27,function(_28){return {"id":_28.id,"name":_28.textContent||_28.innerText||""};});},onDndDrop:function(_29,_2a,_2b){if(this.containerState=="Over"){var _2c=this.tree,_2d=_2c.model,_2e=this.targetAnchor,_2f=false;this.isDragging=false;var _30=_5.getEnclosingWidget(_2e);var _31;var _32;_31=(_30&&_30.item)||_2c.item;if(this.dropPosition=="Before"||this.dropPosition=="After"){_31=(_30.getParent()&&_30.getParent().item)||_2c.item;_32=_30.getIndexInParent();if(this.dropPosition=="After"){_32=_30.getIndexInParent()+1;}}else{_31=(_30&&_30.item)||_2c.item;}var _33;if(_29!=this){_33=this.itemCreator(_2a,_2e);}_4.forEach(_2a,function(_34,idx){if(_29==this){var _36=_5.getEnclosingWidget(_34),_37=_36.item,_38=_36.getParent().item;if(typeof _32=="number"){if(_31==_38&&_36.getIndexInParent()<_32){_32-=1;}}_2d.pasteItem(_37,_38,_31,_2b,_32);}else{_2d.newItem(_33[idx],_31);}},this);this.tree._expandNode(_30);}this.onDndCancel();},onDndCancel:function(){this._unmarkTargetAnchor();this.isDragging=false;this.mouseDown=false;delete this.mouseButton;this._changeState("Source","");this._changeState("Target","");},onOverEvent:function(){this.inherited(arguments);_4.dnd.manager().overSource(this);},onOutEvent:function(){this._unmarkTargetAnchor();var m=_4.dnd.manager();if(this.isDragging){m.canDrop(false);}m.outSource(this);this.inherited(arguments);},_unmarkTargetAnchor:function(){if(!this.targetAnchor){return;}this._removeItemClass(this.targetAnchor,this.dropPosition);this.targetAnchor=null;this.targetBox=null;this.dropPosition=null;},_markDndStatus:function(_3a){this._changeState("Source",_3a?"Copied":"Moved");}});_4.declare("dijit._tree.dndTarget",_5._tree.dndSource,{constructor:function(_3b,_3c){this.isSource=false;_4.removeClass(this.node,"dojoDndSource");}});}}};});