/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.off.sync"],["require","dojox.storage.GearsStorageProvider"],["require","dojox.off._common"],["require","dojox.off.files"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.off.sync"]){_4._hasResource["dojox.off.sync"]=true;_4.provide("dojox.off.sync");_4.require("dojox.storage.GearsStorageProvider");_4.require("dojox.off._common");_4.require("dojox.off.files");_4.mixin(_6.off.sync,{isSyncing:false,cancelled:false,successful:true,details:[],error:false,actions:null,autoSync:true,onSync:function(_7){},synchronize:function(){if(this.isSyncing||_6.off.goingOnline||(!_6.off.isOnline)){return;}this.isSyncing=true;this.successful=false;this.details=[];this.cancelled=false;this.start();},cancel:function(){if(!this.isSyncing){return;}this.cancelled=true;if(_6.off.files.refreshing){_6.off.files.abortRefresh();}this.onSync("cancel");},finishedDownloading:function(_8,_9){if(typeof _8=="undefined"){_8=true;}if(!_8){this.successful=false;this.details.push(_9);this.error=true;}this.finished();},start:function(){if(this.cancelled){this.finished();return;}this.onSync("start");this.refreshFiles();},refreshFiles:function(){if(this.cancelled){this.finished();return;}this.onSync("refreshFiles");_6.off.files.refresh(_4.hitch(this,function(_a,_b){if(_a){this.error=true;this.successful=false;for(var i=0;i<_b.length;i++){this.details.push(_b[i]);}}this.upload();}));},upload:function(){if(this.cancelled){this.finished();return;}this.onSync("upload");_4.connect(this.actions,"onReplayFinished",this,this.download);this.actions.replay();},download:function(){if(this.cancelled){this.finished();return;}this.onSync("download");},finished:function(){this.isSyncing=false;this.successful=(!this.cancelled&&!this.error);this.onSync("finished");},_save:function(_d){this.actions._save(function(){_d();});},_load:function(_e){this.actions._load(function(){_e();});}});_4.declare("dojox.off.sync.ActionLog",null,{entries:[],reasonHalted:null,isReplaying:false,autoSave:true,add:function(_f){if(this.isReplaying){throw "Programming error: you can not call "+"dojox.off.sync.actions.add() while "+"we are replaying an action log";}this.entries.push(_f);if(this.autoSave){this._save();}},onReplay:function(_10,_11){},length:function(){return this.entries.length;},haltReplay:function(_12){if(!this.isReplaying){return;}if(_12){this.reasonHalted=_12.toString();}if(this.autoSave){var _13=this;this._save(function(){_13.isReplaying=false;_13.onReplayFinished();});}else{this.isReplaying=false;this.onReplayFinished();}},continueReplay:function(){if(!this.isReplaying){return;}this.entries.shift();if(!this.entries.length){if(this.autoSave){var _14=this;this._save(function(){_14.isReplaying=false;_14.onReplayFinished();});return;}else{this.isReplaying=false;this.onReplayFinished();return;}}var _15=this.entries[0];this.onReplay(_15,this);},clear:function(){if(this.isReplaying){return;}this.entries=[];if(this.autoSave){this._save();}},replay:function(){if(this.isReplaying){return;}this.reasonHalted=null;if(!this.entries.length){this.onReplayFinished();return;}this.isReplaying=true;var _16=this.entries[0];this.onReplay(_16,this);},onReplayFinished:function(){},toString:function(){var _17="";_17+="[";for(var i=0;i<this.entries.length;i++){_17+="{";for(var j in this.entries[i]){_17+=j+": \""+this.entries[i][j]+"\"";_17+=", ";}_17+="}, ";}_17+="]";return _17;},_save:function(_1a){if(!_1a){_1a=function(){};}try{var _1b=this;var _1c=function(_1d,key,_1f){if(_1d==_6.storage.FAILED){_6.off.onFrameworkEvent("save",{status:_6.storage.FAILED,isCoreSave:true,key:key,value:_1f,namespace:_6.off.STORAGE_NAMESPACE});_1a();}else{if(_1d==_6.storage.SUCCESS){_1a();}}};_6.storage.put("actionlog",this.entries,_1c,_6.off.STORAGE_NAMESPACE);}catch(exp){console.debug("dojox.off.sync._save: "+exp.message||exp);_6.off.onFrameworkEvent("save",{status:_6.storage.FAILED,isCoreSave:true,key:"actionlog",value:this.entries,namespace:_6.off.STORAGE_NAMESPACE});_1a();}},_load:function(_20){var _21=_6.storage.get("actionlog",_6.off.STORAGE_NAMESPACE);if(!_21){_21=[];}this.entries=_21;_20();}});_6.off.sync.actions=new _6.off.sync.ActionLog();}}};});