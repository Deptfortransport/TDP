/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.rpc.JsonRest"],["require","dojox.json.ref"],["require","dojox.rpc.Rest"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.rpc.JsonRest"]){_4._hasResource["dojox.rpc.JsonRest"]=true;_4.provide("dojox.rpc.JsonRest");_4.require("dojox.json.ref");_4.require("dojox.rpc.Rest");(function(){var _7=[];var _8=_6.rpc.Rest;var jr;function _a(_b,_c,_d,_e){var _f=_c.ioArgs&&_c.ioArgs.xhr&&_c.ioArgs.xhr.getResponseHeader("Last-Modified");if(_f&&_8._timeStamps){_8._timeStamps[_e]=_f;}return _d&&_6.json.ref.resolveJson(_d,{defaultId:_e,index:_8._index,timeStamps:_f&&_8._timeStamps,time:_f,idPrefix:_b.servicePath,idAttribute:jr.getIdAttribute(_b),schemas:jr.schemas,loader:jr._loader,assignAbsoluteIds:true});};jr=_6.rpc.JsonRest={conflictDateHeader:"If-Unmodified-Since",commit:function(_10){_10=_10||{};var _11=[];var _12={};var _13=[];for(var i=0;i<_7.length;i++){var _15=_7[i];var _16=_15.object;var old=_15.old;var _18=false;if(!(_10.service&&(_16||old)&&(_16||old).__id.indexOf(_10.service.servicePath))&&_15.save){delete _16.__isDirty;if(_16){if(old){var _19;if((_19=_16.__id.match(/(.*)#.*/))){_16=_8._index[_19[1]];}if(!(_16.__id in _12)){_12[_16.__id]=_16;_11.push({method:"put",target:_16,content:_16});}}else{_11.push({method:"post",target:{__id:jr.getServiceAndId(_16.__id).service.servicePath},content:_16});}}else{if(old){_11.push({method:"delete",target:old});}}_13.push(_15);_7.splice(i--,1);}}_4.connect(_10,"onError",function(){var _1a=_7;_7=_13;var _1b=0;jr.revert();_7=_1a;});jr.sendToServer(_11,_10);return _11;},sendToServer:function(_1c,_1d){var _1e;var _1f=_4.xhr;var _20=_1c.length;var i,_22;var _23;var _24=this.conflictDateHeader;_4.xhr=function(_25,_26){_26.headers=_26.headers||{};_26.headers["Transaction"]=_1c.length-1==i?"commit":"open";if(_24&&_23){_26.headers[_24]=_23;}if(_22){_26.headers["Content-ID"]="<"+_22+">";}return _1f.apply(_4,arguments);};for(i=0;i<_1c.length;i++){var _27=_1c[i];_6.rpc.JsonRest._contentId=_27.content&&_27.content.__id;var _28=_27.method=="post";_23=_27.method=="put"&&_8._timeStamps[_27.content.__id];if(_23){_8._timeStamps[_27.content.__id]=(new Date())+"";}_22=_28&&_6.rpc.JsonRest._contentId;var _29=jr.getServiceAndId(_27.target.__id);var _2a=_29.service;var dfd=_27.deferred=_2a[_27.method](_29.id.replace(/#/,""),_6.json.ref.toJson(_27.content,false,_2a.servicePath,true));(function(_2c,dfd,_2e){dfd.addCallback(function(_2f){try{var _30=dfd.ioArgs.xhr&&dfd.ioArgs.xhr.getResponseHeader("Location");if(_30){var _31=_30.match(/(^\w+:\/\/)/)&&_30.indexOf(_2e.servicePath);_30=_31>0?_30.substring(_31):(_2e.servicePath+_30).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3");_2c.__id=_30;_8._index[_30]=_2c;}_2f=_a(_2e,dfd,_2f,_2c&&_2c.__id);}catch(e){}if(!(--_20)){if(_1d.onComplete){_1d.onComplete.call(_1d.scope);}}return _2f;});})(_27.content,dfd,_2a);dfd.addErrback(function(_32){_20=-1;_1d.onError.call(_1d.scope,_32);});}_4.xhr=_1f;},getDirtyObjects:function(){return _7;},revert:function(_33){for(var i=_7.length;i>0;){i--;var _35=_7[i];var _36=_35.object;var old=_35.old;if(!(_33&&(_36||old)&&(_36||old).__id.indexOf(_33.servicePath))){if(_36&&old){for(var j in old){if(old.hasOwnProperty(j)){_36[j]=old[j];}}for(j in _36){if(!old.hasOwnProperty(j)){delete _36[j];}}}_7.splice(i,1);}}},changing:function(_39,_3a){if(!_39.__id){return;}_39.__isDirty=true;for(var i=0;i<_7.length;i++){var _3c=_7[i];if(_39==_3c.object){if(_3a){_3c.object=false;if(!this._saveNotNeeded){_3c.save=true;}}return;}}var old=_39 instanceof Array?[]:{};for(i in _39){if(_39.hasOwnProperty(i)){old[i]=_39[i];}}_7.push({object:!_3a&&_39,old:old,save:!this._saveNotNeeded});},deleteObject:function(_3e){this.changing(_3e,true);},getConstructor:function(_3f,_40){if(typeof _3f=="string"){var _41=_3f;_3f=new _6.rpc.Rest(_3f,true);this.registerService(_3f,_41,_40);}if(_3f._constructor){return _3f._constructor;}_3f._constructor=function(_42){var _43=this;var _44=arguments;var _45;function _46(_47){if(_47){_46(_47["extends"]);_45=_47.properties;for(var i in _45){var _49=_45[i];if(_49&&(typeof _49=="object")&&("default" in _49)){_43[i]=_49["default"];}}}if(_42){_4.mixin(_43,_42);}if(_47&&_47.prototype&&_47.prototype.initialize){_47.prototype.initialize.apply(_43,_44);}};_46(_3f._schema);var _4a=jr.getIdAttribute(_3f);_8._index[this.__id=this.__clientId=_3f.servicePath+(this[_4a]||Math.random().toString(16).substring(2,14)+"@"+((_6.rpc.Client&&_6.rpc.Client.clientId)||"client"))]=this;if(_6.json.schema&&_45){_6.json.schema.mustBeValid(_6.json.schema.validate(this,_3f._schema));}_7.push({object:this,save:true});};return _4.mixin(_3f._constructor,_3f._schema,{load:_3f});},fetch:function(_4b){var _4c=jr.getServiceAndId(_4b);return this.byId(_4c.service,_4c.id);},getIdAttribute:function(_4d){var _4e=_4d._schema;var _4f;if(_4e){if(!(_4f=_4e._idAttr)){for(var i in _4e.properties){if(_4e.properties[i].identity){_4e._idAttr=_4f=i;}}}}return _4f||"id";},getServiceAndId:function(_51){var _52=_51.match(/^(.*\/)([^\/]*)$/);var svc=jr.services[_52[1]]||new _6.rpc.Rest(_52[1],true);return {service:svc,id:_52[2]};},services:{},schemas:{},registerService:function(_54,_55,_56){_55=_55||_54.servicePath;_55=_54.servicePath=_55.match(/\/$/)?_55:(_55+"/");_54._schema=jr.schemas[_55]=_56||_54._schema||{};jr.services[_55]=_54;},byId:function(_57,id){var _59,_5a=_8._index[(_57.servicePath||"")+id];if(_5a&&!_5a._loadObject){_59=new _4.Deferred();_59.callback(_5a);return _59;}return this.query(_57,id);},query:function(_5b,id,_5d){var _5e=_5b(id,_5d);_5e.addCallback(function(_5f){if(_5f.nodeType&&_5f.cloneNode){return _5f;}return _a(_5b,_5e,_5f,typeof id!="string"||(_5d&&(_5d.start||_5d.count))?undefined:id);});return _5e;},_loader:function(_60){var _61=jr.getServiceAndId(this.__id);var _62=this;jr.query(_61.service,_61.id).addBoth(function(_63){if(_63==_62){delete _63.$ref;delete _63._loadObject;}else{_62._loadObject=function(_64){_64(_63);};}_60(_63);});},isDirty:function(_65){if(!_65){return !!_7.length;}return _65.__isDirty;}};})();}}};});