/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.cometd.RestChannels"],["require","dojox.rpc.Client"],["requireIf",_3.data&&!!_3.data.JsonRestStore,"dojox.data.restListener"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.cometd.RestChannels"]){_4._hasResource["dojox.cometd.RestChannels"]=true;_4.provide("dojox.cometd.RestChannels");_4.require("dojox.rpc.Client");_4.requireIf(_6.data&&!!_6.data.JsonRestStore,"dojox.data.restListener");(function(){_4.declare("dojox.cometd.RestChannels",null,{constructor:function(_7){_4.mixin(this,_7);if(_6.rpc.Rest&&this.autoSubscribeRoot){var _8=_6.rpc.Rest._get;var _9=this;_6.rpc.Rest._get=function(_a,id){var _c=_4.xhrGet;_4.xhrGet=function(r){var _e=_9.autoSubscribeRoot;return (_e&&r.url.substring(0,_e.length)==_e)?_9.get(r.url,r):_c(r);};var _f=_8.apply(this,arguments);_4.xhrGet=_c;return _f;};}if(_6.data&&_6.data.restListener){this.receive=_6.data.restListener;}},absoluteUrl:function(_10,_11){return new _4._Url(_10,_11)+"";},acceptType:"application/rest+json,application/http;q=0.9,*/*;q=0.7",subscriptions:{},subCallbacks:{},autoReconnectTime:3000,reloadDataOnReconnect:true,sendAsJson:false,url:"/channels",autoSubscribeRoot:"/",open:function(){this.started=true;if(!this.connected){this.connectionId=_6.rpc.Client.clientId;var _12=this.createdClientId?"Client-Id":"Create-Client-Id";this.createdClientId=true;var _13={Accept:this.acceptType};_13[_12]=this.connectionId;var dfd=_4.xhrPost({headers:_13,url:this.url,noStatus:true});var _15=this;this.lastIndex=0;var _16,_17=function(_18){if(typeof _4=="undefined"){return null;}if(xhr&&xhr.status>400){return _16(true);}if(typeof _18=="string"){_18=_18.substring(_15.lastIndex);}var _1a=xhr&&(xhr.contentType||xhr.getResponseHeader("Content-Type"))||(typeof _18!="string"&&"already json");var _1b=_15.onprogress(xhr,_18,_1a);if(_1b){if(_16()){return new Error(_1b);}}if(!xhr||xhr.readyState==4){xhr=null;if(_15.connected){_15.connected=false;_15.open();}}return _18;};_16=function(_1c){if(xhr&&xhr.status==409){console.log("multiple tabs/windows open, polling");_15.disconnected();return null;}_15.createdClientId=false;_15.disconnected();return _1c;};dfd.addCallbacks(_17,_16);var xhr=dfd.ioArgs.xhr;if(xhr){xhr.onreadystatechange=function(){var _1d;try{if(xhr.readyState==3){_15.readyState=3;_1d=xhr.responseText;}}catch(e){}if(typeof _1d=="string"){_17(_1d);}};}if(window.attachEvent){window.attachEvent("onunload",function(){_15.connected=false;if(xhr){xhr.abort();}});}this.connected=true;}},_send:function(_1e,_1f,_20){if(this.sendAsJson){_1f.postBody=_4.toJson({target:_1f.url,method:_1e,content:_20,params:_1f.content,subscribe:_1f.headers["Subscribe"]});_1f.url=this.url;_1e="POST";}else{_1f.postData=_4.toJson(_20);}return _4.xhr(_1e,_1f,_1f.postBody);},subscribe:function(_21,_22){_22=_22||{};_22.url=this.absoluteUrl(this.url,_21);if(_22.headers){delete _22.headers.Range;}var _23=this.subscriptions[_21];var _24=_22.method||"HEAD";var _25=_22.since;var _26=_22.callback;var _27=_22.headers||(_22.headers={});this.subscriptions[_21]=_25||_23||0;var _28=this.subCallbacks[_21];if(_26){this.subCallbacks[_21]=_28?function(m){_28(m);_26(m);}:_26;}if(!this.connected){this.open();}if(_23===undefined||_23!=_25){_27["Cache-Control"]="max-age=0";_25=typeof _25=="number"?new Date(_25).toUTCString():_25;if(_25){_27["Subscribe-Since"]=_25;}_27["Subscribe"]=_22.unsubscribe?"none":"*";var dfd=this._send(_24,_22);var _2b=this;dfd.addBoth(function(_2c){var xhr=dfd.ioArgs.xhr;if(!(_2c instanceof Error)){if(_22.confirmation){_22.confirmation();}}if(xhr&&xhr.getResponseHeader("Subscribed")=="OK"){var _2e=xhr.getResponseHeader("Last-Modified");if(xhr.responseText){_2b.subscriptions[_21]=_2e||new Date().toUTCString();}else{return null;}}else{if(xhr&&!(_2c instanceof Error)){delete _2b.subscriptions[_21];}}if(!(_2c instanceof Error)){var _2f={responseText:xhr&&xhr.responseText,channel:_21,getResponseHeader:function(_30){return xhr.getResponseHeader(_30);},getAllResponseHeaders:function(){return xhr.getAllResponseHeaders();},result:_2c};if(_2b.subCallbacks[_21]){_2b.subCallbacks[_21](_2f);}}else{if(_2b.subCallbacks[_21]){_2b.subCallbacks[_21](xhr);}}return _2c;});return dfd;}return null;},publish:function(_31,_32){return this._send("POST",{url:_31,contentType:"application/json"},_32);},_processMessage:function(_33){_33.event=_33.event||_33.getResponseHeader("Event");if(_33.event=="connection-conflict"){return "conflict";}try{_33.result=_33.result||_4.fromJson(_33.responseText);}catch(e){}var _34=this;var loc=_33.channel=new _4._Url(this.url,_33.source||_33.getResponseHeader("Content-Location"))+"";if(loc in this.subscriptions&&_33.getResponseHeader){this.subscriptions[loc]=_33.getResponseHeader("Last-Modified");}if(this.subCallbacks[loc]){setTimeout(function(){_34.subCallbacks[loc](_33);},0);}this.receive(_33);return null;},onprogress:function(xhr,_37,_38){if(!_38||_38.match(/application\/rest\+json/)){var _39=_37.length;_37=_37.replace(/^\s*[,\[]?/,"[").replace(/[,\]]?\s*$/,"]");try{var _3a=_4.fromJson(_37);this.lastIndex+=_39;}catch(e){}}else{if(_6.io&&_6.io.httpParse&&_38.match(/application\/http/)){var _3b="";if(xhr&&xhr.getAllResponseHeaders){_3b=xhr.getAllResponseHeaders();}_3a=_6.io.httpParse(_37,_3b,xhr.readyState!=4);}else{if(typeof _37=="object"){_3a=_37;}}}if(_3a){for(var i=0;i<_3a.length;i++){if(this._processMessage(_3a[i])){return "conflict";}}return null;}if(!xhr){return "error";}if(xhr.readyState!=4){return null;}if(xhr.__proto__){xhr={channel:"channel",__proto__:xhr};}return this._processMessage(xhr);},get:function(_3d,_3e){(_3e=_3e||{}).method="GET";return this.subscribe(_3d,_3e);},receive:function(_3f){},disconnected:function(){var _40=this;if(this.connected){this.connected=false;if(this.started){setTimeout(function(){var _41=_40.subscriptions;_40.subscriptions={};for(var i in _41){if(_40.reloadDataOnReconnect&&_6.rpc.JsonRest){delete _6.rpc.Rest._index[i];_6.rpc.JsonRest.fetch(i);}else{_40.subscribe(i,{since:_41[i]});}}_40.open();},this.autoReconnectTime);}}},unsubscribe:function(_43,_44){_44=_44||{};_44.unsubscribe=true;this.subscribe(_43,_44);},disconnect:function(){this.started=false;this.xhr.abort();}});var _45=_6.cometd.RestChannels.defaultInstance=new _6.cometd.RestChannels();if(_6.cometd.connectionTypes){_45.startup=function(_46){_45.open();this._cometd._deliver({channel:"/meta/connect",successful:true});};_45.check=function(_47,_48,_49){for(var i=0;i<_47.length;i++){if(_47[i]=="rest-channels"){return !_49;}}return false;};_45.deliver=function(_4b){};_4.connect(this,"receive",null,function(_4c){_4c.data=_4c.result;this._cometd._deliver(_4c);});_45.sendMessages=function(_4d){for(var i=0;i<_4d.length;i++){var _4f=_4d[i];var _50=_4f.channel;var _51=this._cometd;var _52={confirmation:function(){_51._deliver({channel:_50,successful:true});}};if(_50=="/meta/subscribe"){this.subscribe(_4f.subscription,_52);}else{if(_50=="/meta/unsubscribe"){this.unsubscribe(_4f.subscription,_52);}else{if(_50=="/meta/connect"){_52.confirmation();}else{if(_50=="/meta/disconnect"){_45.disconnect();_52.confirmation();}else{if(_50.substring(0,6)!="/meta/"){this.publish(_50,_4f.data);}}}}}}};_6.cometd.connectionTypes.register("rest-channels",_45.check,_45,false,true);}})();}}};});