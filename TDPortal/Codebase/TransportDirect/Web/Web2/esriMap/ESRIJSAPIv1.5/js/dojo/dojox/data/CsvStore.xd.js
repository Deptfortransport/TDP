/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.CsvStore"],["require","dojo.data.util.filter"],["require","dojo.data.util.simpleFetch"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.CsvStore"]){_4._hasResource["dojox.data.CsvStore"]=true;_4.provide("dojox.data.CsvStore");_4.require("dojo.data.util.filter");_4.require("dojo.data.util.simpleFetch");_4.declare("dojox.data.CsvStore",null,{constructor:function(_7){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=false;if(_7.url){this.url=_7.url;}this._csvData=_7.data;if(_7.label){this.label=_7.label;}else{if(this.label===""){this.label=undefined;}}this._storeProp="_csvStore";this._idProp="_csvId";this._features={"dojo.data.api.Read":true,"dojo.data.api.Identity":true};this._loadInProgress=false;this._queuedFetches=[];this.identifier=_7.identifier;if(this.identifier===""){delete this.identifier;}else{this._idMap={};}},url:"",label:"",identifier:"",_assertIsItem:function(_8){if(!this.isItem(_8)){throw new Error(this.declaredClass+": a function was passed an item argument that was not an item");}},_assertIsAttribute:function(_9){if(!_4.isString(_9)){throw new Error(this.declaredClass+": a function was passed an attribute argument that was not an attribute object nor an attribute name string");}},_getIndex:function(_a){var _b=this.getIdentity(_a);if(this.identifier){_b=this._idMap[_b];}return _b;},getValue:function(_c,_d,_e){this._assertIsItem(_c);this._assertIsAttribute(_d);var _f=_e;if(this.hasAttribute(_c,_d)){var _10=this._dataArray[this._getIndex(_c)];_f=_10[this._attributeIndexes[_d]];}return _f;},getValues:function(_11,_12){var _13=this.getValue(_11,_12);return (_13?[_13]:[]);},getAttributes:function(_14){this._assertIsItem(_14);var _15=[];var _16=this._dataArray[this._getIndex(_14)];for(var i=0;i<_16.length;i++){if(_16[i]!==""){_15.push(this._attributes[i]);}}return _15;},hasAttribute:function(_18,_19){this._assertIsItem(_18);this._assertIsAttribute(_19);var _1a=this._attributeIndexes[_19];var _1b=this._dataArray[this._getIndex(_18)];return (typeof _1a!=="undefined"&&_1a<_1b.length&&_1b[_1a]!=="");},containsValue:function(_1c,_1d,_1e){var _1f=undefined;if(typeof _1e==="string"){_1f=_4.data.util.filter.patternToRegExp(_1e,false);}return this._containsValue(_1c,_1d,_1e,_1f);},_containsValue:function(_20,_21,_22,_23){var _24=this.getValues(_20,_21);for(var i=0;i<_24.length;++i){var _26=_24[i];if(typeof _26==="string"&&_23){return (_26.match(_23)!==null);}else{if(_22===_26){return true;}}}return false;},isItem:function(_27){if(_27&&_27[this._storeProp]===this){var _28=_27[this._idProp];if(this.identifier){var _29=this._dataArray[this._idMap[_28]];if(_29){return true;}}else{if(_28>=0&&_28<this._dataArray.length){return true;}}}return false;},isItemLoaded:function(_2a){return this.isItem(_2a);},loadItem:function(_2b){},getFeatures:function(){return this._features;},getLabel:function(_2c){if(this.label&&this.isItem(_2c)){return this.getValue(_2c,this.label);}return undefined;},getLabelAttributes:function(_2d){if(this.label){return [this.label];}return null;},_fetchItems:function(_2e,_2f,_30){var _31=this;var _32=function(_33,_34){var _35=null;if(_33.query){var key,_37;_35=[];var _38=_33.queryOptions?_33.queryOptions.ignoreCase:false;var _39={};for(key in _33.query){_37=_33.query[key];if(typeof _37==="string"){_39[key]=_4.data.util.filter.patternToRegExp(_37,_38);}}for(var i=0;i<_34.length;++i){var _3b=true;var _3c=_34[i];for(key in _33.query){_37=_33.query[key];if(!_31._containsValue(_3c,key,_37,_39[key])){_3b=false;}}if(_3b){_35.push(_3c);}}}else{if(_34.length>0){_35=_34.slice(0,_34.length);}}_2f(_35,_33);};if(this._loadFinished){_32(_2e,this._arrayOfAllItems);}else{if(this.url!==""){if(this._loadInProgress){this._queuedFetches.push({args:_2e,filter:_32});}else{this._loadInProgress=true;var _3d={url:_31.url,handleAs:"text"};var _3e=_4.xhrGet(_3d);_3e.addCallback(function(_3f){try{_31._processData(_3f);_32(_2e,_31._arrayOfAllItems);_31._handleQueuedFetches();}catch(e){_30(e,_2e);}});_3e.addErrback(function(_40){_31._loadInProgress=false;if(_30){_30(_40,_2e);}else{throw _40;}});}}else{if(this._csvData){try{this._processData(this._csvData);this._csvData=null;_32(_2e,this._arrayOfAllItems);}catch(e){_30(e,_2e);}}else{var _41=new Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(_30){_30(_41,_2e);}else{throw _41;}}}}},close:function(_42){},_getArrayOfArraysFromCsvFileContents:function(_43){if(_4.isString(_43)){var _44=new RegExp("\r\n|\n|\r");var _45=new RegExp("^\\s+","g");var _46=new RegExp("\\s+$","g");var _47=new RegExp("\"\"","g");var _48=[];var i;var _4a=this._splitLines(_43);for(i=0;i<_4a.length;++i){var _4b=_4a[i];if(_4b.length>0){var _4c=_4b.split(",");var j=0;while(j<_4c.length){var _4e=_4c[j];var _4f=_4e.replace(_45,"");var _50=_4f.replace(_46,"");var _51=_50.charAt(0);var _52=_50.charAt(_50.length-1);var _53=_50.charAt(_50.length-2);var _54=_50.charAt(_50.length-3);if(_50.length===2&&_50=="\"\""){_4c[j]="";}else{if((_51=="\"")&&((_52!="\"")||((_52=="\"")&&(_53=="\"")&&(_54!="\"")))){if(j+1===_4c.length){return null;}var _55=_4c[j+1];_4c[j]=_4f+","+_55;_4c.splice(j+1,1);}else{if((_51=="\"")&&(_52=="\"")){_50=_50.slice(1,(_50.length-1));_50=_50.replace(_47,"\"");}_4c[j]=_50;j+=1;}}}_48.push(_4c);}}this._attributes=_48.shift();for(i=0;i<this._attributes.length;i++){this._attributeIndexes[this._attributes[i]]=i;}this._dataArray=_48;}},_splitLines:function(_56){var _57=[];var i;var _59="";var _5a=false;for(i=0;i<_56.length;i++){var c=_56.charAt(i);switch(c){case "\"":_5a=!_5a;_59+=c;break;case "\r":if(_5a){_59+=c;}else{_57.push(_59);_59="";if(i<(_56.length-1)&&_56.charAt(i+1)=="\n"){i++;}}break;case "\n":if(_5a){_59+=c;}else{_57.push(_59);_59="";}break;default:_59+=c;}}if(_59!==""){_57.push(_59);}return _57;},_processData:function(_5c){this._getArrayOfArraysFromCsvFileContents(_5c);this._arrayOfAllItems=[];if(this.identifier){if(this._attributeIndexes[this.identifier]===undefined){throw new Error(this.declaredClass+": Identity specified is not a column header in the data set.");}}for(var i=0;i<this._dataArray.length;i++){var id=i;if(this.identifier){var _5f=this._dataArray[i];id=_5f[this._attributeIndexes[this.identifier]];this._idMap[id]=i;}this._arrayOfAllItems.push(this._createItemFromIdentity(id));}this._loadFinished=true;this._loadInProgress=false;},_createItemFromIdentity:function(_60){var _61={};_61[this._storeProp]=this;_61[this._idProp]=_60;return _61;},getIdentity:function(_62){if(this.isItem(_62)){return _62[this._idProp];}return null;},fetchItemByIdentity:function(_63){var _64;var _65=_63.scope?_63.scope:_4.global;if(!this._loadFinished){var _66=this;if(this.url!==""){if(this._loadInProgress){this._queuedFetches.push({args:_63});}else{this._loadInProgress=true;var _67={url:_66.url,handleAs:"text"};var _68=_4.xhrGet(_67);_68.addCallback(function(_69){try{_66._processData(_69);var _6a=_66._createItemFromIdentity(_63.identity);if(!_66.isItem(_6a)){_6a=null;}if(_63.onItem){_63.onItem.call(_65,_6a);}_66._handleQueuedFetches();}catch(error){if(_63.onError){_63.onError.call(_65,error);}}});_68.addErrback(function(_6b){this._loadInProgress=false;if(_63.onError){_63.onError.call(_65,_6b);}});}}else{if(this._csvData){try{_66._processData(_66._csvData);_66._csvData=null;_64=_66._createItemFromIdentity(_63.identity);if(!_66.isItem(_64)){_64=null;}if(_63.onItem){_63.onItem.call(_65,_64);}}catch(e){if(_63.onError){_63.onError.call(_65,e);}}}}}else{_64=this._createItemFromIdentity(_63.identity);if(!this.isItem(_64)){_64=null;}if(_63.onItem){_63.onItem.call(_65,_64);}}},getIdentityAttributes:function(_6c){if(this.identifier){return [this.identifier];}else{return null;}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var i=0;i<this._queuedFetches.length;i++){var _6e=this._queuedFetches[i];var _6f=_6e.filter;var _70=_6e.args;if(_6f){_6f(_70,this._arrayOfAllItems);}else{this.fetchItemByIdentity(_6e.args);}}this._queuedFetches=[];}}});_4.extend(_6.data.CsvStore,_4.data.util.simpleFetch);}}};});