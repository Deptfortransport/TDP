/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.sketch.Figure"],["require","dojox.gfx"],["require","dojox.sketch.UndoStack"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.sketch.Figure"]){_4._hasResource["dojox.sketch.Figure"]=true;_4.provide("dojox.sketch.Figure");_4.experimental("dojox.sketch");_4.require("dojox.gfx");_4.require("dojox.sketch.UndoStack");(function(){var ta=_6.sketch;ta.tools={};ta.registerTool=function(_8,fn){ta.tools[_8]=fn;};ta.Figure=function(_a){var _b=this;this.annCounter=1;this.shapes=[];this.image=null;this.imageSrc=null;this.size={w:0,h:0};this.surface=null;this.group=null;this.node=null;this.zoomFactor=1;this.tools=null;this.obj={};_4.mixin(this,_a);this.selected=[];this.hasSelections=function(){return this.selected.length>0;};this.isSelected=function(_c){for(var i=0;i<_b.selected.length;i++){if(_b.selected[i]==_c){return true;}}return false;};this.select=function(_e){if(!_b.isSelected(_e)){_b.clearSelections();_b.selected=[_e];}_e.setMode(ta.Annotation.Modes.View);_e.setMode(ta.Annotation.Modes.Edit);};this.deselect=function(_f){var idx=-1;for(var i=0;i<_b.selected.length;i++){if(_b.selected[i]==_f){idx=i;break;}}if(idx>-1){_f.setMode(ta.Annotation.Modes.View);_b.selected.splice(idx,1);}return _f;};this.clearSelections=function(){for(var i=0;i<_b.selected.length;i++){_b.selected[i].setMode(ta.Annotation.Modes.View);}_b.selected=[];};this.replaceSelection=function(n,o){if(!_b.isSelected(o)){_b.select(n);return;}var idx=-1;for(var i=0;i<_b.selected.length;i++){if(_b.selected[i]==o){idx=i;break;}}if(idx>-1){_b.selected.splice(idx,1,n);}};this._c=null;this._ctr=null;this._lp=null;this._action=null;this._prevState=null;this._startPoint=null;this._ctool=null;this._start=null;this._end=null;this._absEnd=null;this._cshape=null;this._dblclick=function(e){var o=_b._fromEvt(e);if(o){_b.onDblClickShape(o,e);}};this._keydown=function(e){var _1a=false;if(e.ctrlKey){if(e.keyCode===90){_b.undo();_1a=true;}else{if(e.keyCode===89){_b.redo();_1a=true;}}}if(e.keyCode===46||e.keyCode===8){_b._delete(_b.selected);_1a=true;}if(_1a){_4.stopEvent(e);}};this._md=function(e){var o=_b._fromEvt(e);_b._startPoint={x:e.pageX,y:e.pageY};_b._ctr=_4._abs(_b.node);_b._ctr={x:_b._ctr.x,y:_b._ctr.y};var X=e.clientX-_b._ctr.x,Y=e.clientY-_b._ctr.y;_b._lp={x:X,y:Y};_b._start={x:X,y:Y};_b._end={x:X,y:Y};_b._absEnd={x:X,y:Y};if(!o){_b.clearSelections();_b._ctool.onMouseDown(e);}else{if(o.type&&o.type()!="Anchor"){if(!_b.isSelected(o)){_b.select(o);_b._sameShapeSelected=false;}else{_b._sameShapeSelected=true;}}o.beginEdit();_b._c=o;}};this._mm=function(e){if(!_b._ctr){return;}var x=e.clientX-_b._ctr.x;var y=e.clientY-_b._ctr.y;var dx=x-_b._lp.x;var dy=y-_b._lp.y;_b._absEnd={x:x,y:y};if(_b._c){_b._c.setBinding({dx:dx/_b.zoomFactor,dy:dy/_b.zoomFactor});_b._lp={x:x,y:y};}else{_b._end={x:dx,y:dy};var _24={x:Math.min(_b._start.x,_b._absEnd.x),y:Math.min(_b._start.y,_b._absEnd.y),width:Math.abs(_b._start.x-_b._absEnd.x),height:Math.abs(_b._start.y-_b._absEnd.y)};if(_24.width&&_24.height){_b._ctool.onMouseMove(e,_24);}}};this._mu=function(e){if(_b._c){_b._c.endEdit();}else{_b._ctool.onMouseUp(e);}_b._c=_b._ctr=_b._lp=_b._action=_b._prevState=_b._startPoint=null;_b._cshape=_b._start=_b._end=_b._absEnd=null;};this.initUndoStack();};var p=ta.Figure.prototype;p.initUndoStack=function(){this.history=new ta.UndoStack(this);};p.setTool=function(t){this._ctool=t;};p._delete=function(arr,_29){for(var i=0;i<arr.length;i++){arr[i].setMode(ta.Annotation.Modes.View);arr[i].destroy(_29);this.remove(arr[i]);this._remove(arr[i]);if(!_29){arr[i].onRemove();}}arr.splice(0,arr.length);};p.onDblClickShape=function(_2b,e){if(_2b["onDblClick"]){_2b.onDblClick(e);}};p.onCreateShape=function(_2d){};p.onBeforeCreateShape=function(_2e){};p.initialize=function(_2f){this.node=_2f;this.surface=_6.gfx.createSurface(_2f,this.size.w,this.size.h);this.group=this.surface.createGroup();this._cons=[];var es=this.surface.getEventSource();this._cons.push(_4.connect(es,"ondraggesture",_4.stopEvent),_4.connect(es,"ondragenter",_4.stopEvent),_4.connect(es,"ondragover",_4.stopEvent),_4.connect(es,"ondragexit",_4.stopEvent),_4.connect(es,"ondragstart",_4.stopEvent),_4.connect(es,"onselectstart",_4.stopEvent),_4.connect(es,"onmousedown",this._md),_4.connect(es,"onmousemove",this._mm),_4.connect(es,"onmouseup",this._mu),_4.connect(es,"onclick",this,"onClick"),_4.connect(es,"ondblclick",this._dblclick),_4.connect(es.ownerDocument,"onkeydown",this._keydown));this.image=this.group.createImage({width:this.size.w,height:this.size.h,src:this.imageSrc});};p.destroy=function(_31){if(!this.node){return;}if(!_31){if(this.history){this.history.destroy();}if(this._subscribed){_4.unsubscribe(this._subscribed);delete this._subscribed;}}_4.forEach(this._cons,_4.disconnect);this._cons=[];_4.empty(this.node);this.group=this.surface=null;this.obj={};this.shapes=[];};p.nextKey=function(){return "annotation-"+this.annCounter++;};p.draw=function(){};p.zoom=function(pct){this.zoomFactor=pct/100;var w=this.size.w*this.zoomFactor;var h=this.size.h*this.zoomFactor;this.surface.setDimensions(w,h);this.group.setTransform(_6.gfx.matrix.scale(this.zoomFactor,this.zoomFactor));for(var i=0;i<this.shapes.length;i++){this.shapes[i].zoom(this.zoomFactor);}};p.getFit=function(){var wF=(this.node.parentNode.clientWidth-5)/this.size.w;var hF=(this.node.parentNode.clientHeight-5)/this.size.h;return Math.min(wF,hF)*100;};p.unzoom=function(){this.zoomFactor=1;this.surface.setDimensions(this.size.w,this.size.h);this.group.setTransform();};p._add=function(obj){this.obj[obj._key]=obj;};p._remove=function(obj){if(this.obj[obj._key]){delete this.obj[obj._key];}};p._get=function(key){if(key&&key.indexOf("bounding")>-1){key=key.replace("-boundingBox","");}else{if(key&&key.indexOf("-labelShape")>-1){key=key.replace("-labelShape","");}}return this.obj[key];};p._keyFromEvt=function(e){var key=e.target.id+"";if(key.length==0){var p=e.target.parentNode;var _3e=this.surface.getEventSource();while(p&&p.id.length==0&&p!=_3e){p=p.parentNode;}key=p.id;}return key;};p._fromEvt=function(e){return this._get(this._keyFromEvt(e));};p.add=function(_40){for(var i=0;i<this.shapes.length;i++){if(this.shapes[i]==_40){return true;}}this.shapes.push(_40);return true;};p.remove=function(_42){var idx=-1;for(var i=0;i<this.shapes.length;i++){if(this.shapes[i]==_42){idx=i;break;}}if(idx>-1){this.shapes.splice(idx,1);}return _42;};p.get=function(id){for(var i=0;i<this.shapes.length;i++){if(this.shapes[i].id==id){return this.shapes[i];}}return null;};p.convert=function(ann,t){var _49=t+"Annotation";if(!ta[_49]){return;}var _4a=ann.type(),id=ann.id,_4c=ann.label,_4d=ann.mode,_4e=ann.tokenId;var _4f,end,_51,_52;switch(_4a){case "Preexisting":case "Lead":_52={dx:ann.transform.dx,dy:ann.transform.dy};_4f={x:ann.start.x,y:ann.start.y};end={x:ann.end.x,y:ann.end.y};var cx=end.x-((end.x-_4f.x)/2);var cy=end.y-((end.y-_4f.y)/2);_51={x:cx,y:cy};break;case "SingleArrow":case "DoubleArrow":_52={dx:ann.transform.dx,dy:ann.transform.dy};_4f={x:ann.start.x,y:ann.start.y};end={x:ann.end.x,y:ann.end.y};_51={x:ann.control.x,y:ann.control.y};break;case "Underline":_52={dx:ann.transform.dx,dy:ann.transform.dy};_4f={x:ann.start.x,y:ann.start.y};_51={x:_4f.x+50,y:_4f.y+50};end={x:_4f.x+100,y:_4f.y+100};break;case "Brace":}var n=new ta[_49](this,id);if(n.type()=="Underline"){n.transform={dx:_52.dx+_4f.x,dy:_52.dy+_4f.y};}else{if(n.transform){n.transform=_52;}if(n.start){n.start=_4f;}}if(n.end){n.end=end;}if(n.control){n.control=_51;}n.label=_4c;n.token=_4.lang.shallowCopy(ann.token);n.initialize();this.replaceSelection(n,ann);this._remove(ann);this.remove(ann);ann.destroy();n.setMode(_4d);};p.setValue=function(_56){var obj=_6.xml.DomParser.parse(_56);var _58=this.node;this.load(obj,_58);this.zoom(this.zoomFactor*100);};p.load=function(obj,n){if(this.surface){this.destroy(true);}var _5b=obj.documentElement;this.size={w:parseFloat(_5b.getAttribute("width"),10),h:parseFloat(_5b.getAttribute("height"),10)};var g=_5b.childrenByName("g")[0];var img=g.childrenByName("image")[0];this.imageSrc=img.getAttribute("xlink:href");this.initialize(n);var ann=g.childrenByName("g");for(var i=0;i<ann.length;i++){this._loadAnnotation(ann[i]);}if(this._loadDeferred){this._loadDeferred.callback(this);this._loadDeferred=null;}this.onLoad();};p.onLoad=function(){};p.onClick=function(){};p._loadAnnotation=function(obj){var _61=obj.getAttribute("dojoxsketch:type")+"Annotation";if(ta[_61]){var a=new ta[_61](this,obj.id);a.initialize(obj);this.nextKey();a.setMode(ta.Annotation.Modes.View);this._add(a);return a;}return null;};p.onUndo=function(){};p.onBeforeUndo=function(){};p.onRedo=function(){};p.onBeforeRedo=function(){};p.undo=function(){if(this.history){this.onBeforeUndo();this.history.undo();this.onUndo();}};p.redo=function(){if(this.history){this.onBeforeRedo();this.history.redo();this.onRedo();}};p.serialize=function(){var s="<svg xmlns=\"http://www.w3.org/2000/svg\" "+"xmlns:xlink=\"http://www.w3.org/1999/xlink\" "+"xmlns:dojoxsketch=\"http://dojotoolkit.org/dojox/sketch\" "+"width=\""+this.size.w+"\" height=\""+this.size.h+"\">"+"<g>"+"<image xlink:href=\""+this.imageSrc+"\" x=\"0\" y=\"0\" width=\""+this.size.w+"\" height=\""+this.size.h+"\" />";for(var i=0;i<this.shapes.length;i++){s+=this.shapes[i].serialize();}s+="</g></svg>";return s;};p.getValue=p.serialize;})();}}};});