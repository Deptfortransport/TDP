/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dijit._editor.plugins.EnterKeyHandling"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dijit._editor.plugins.EnterKeyHandling"]){_4._hasResource["dijit._editor.plugins.EnterKeyHandling"]=true;_4.provide("dijit._editor.plugins.EnterKeyHandling");_4.declare("dijit._editor.plugins.EnterKeyHandling",_5._editor._Plugin,{blockNodeForEnter:"BR",constructor:function(_7){if(_7){_4.mixin(this,_7);}},setEditor:function(_8){this.editor=_8;if(this.blockNodeForEnter=="BR"){if(_4.isIE){_8.contentDomPreFilters.push(_4.hitch(this,"regularPsToSingleLinePs"));_8.contentDomPostFilters.push(_4.hitch(this,"singleLinePsToRegularPs"));_8.onLoadDeferred.addCallback(_4.hitch(this,"_fixNewLineBehaviorForIE"));}else{_8.onLoadDeferred.addCallback(_4.hitch(this,function(d){try{this.editor.document.execCommand("insertBrOnReturn",false,true);}catch(e){}return d;}));}}else{if(this.blockNodeForEnter){_4["require"]("dijit._editor.range");var h=_4.hitch(this,this.handleEnterKey);_8.addKeyHandler(13,0,0,h);_8.addKeyHandler(13,0,1,h);this.connect(this.editor,"onKeyPressed","onKeyPressed");}}},connect:function(o,f,tf){if(!this._connects){this._connects=[];}this._connects.push(_4.connect(o,f,this,tf));},destroy:function(){_4.forEach(this._connects,_4.disconnect);this._connects=[];},onKeyPressed:function(e){if(this._checkListLater){if(_4.withGlobal(this.editor.window,"isCollapsed",_5)){var _f=_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,["LI"]);if(!_f){_5._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var _10=_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,[this.blockNodeForEnter]);if(_10){_10.innerHTML=this.bogusHtmlContent;if(_4.isIE){var r=this.editor.document.selection.createRange();r.move("character",-1);r.select();}}else{alert("onKeyPressed: Can not find the new block node");}}else{if(_4.isMoz){if(_f.parentNode.parentNode.nodeName=="LI"){_f=_f.parentNode.parentNode;}}var fc=_f.firstChild;if(fc&&fc.nodeType==1&&(fc.nodeName=="UL"||fc.nodeName=="OL")){_f.insertBefore(fc.ownerDocument.createTextNode(" "),fc);var _13=_5.range.create();_13.setStart(_f.firstChild,0);var _14=_5.range.getSelection(this.editor.window,true);_14.removeAllRanges();_14.addRange(_13);}}}this._checkListLater=false;}if(this._pressedEnterInBlock){if(this._pressedEnterInBlock.previousSibling){this.removeTrailingBr(this._pressedEnterInBlock.previousSibling);}delete this._pressedEnterInBlock;}},bogusHtmlContent:"&nbsp;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){if(!this.blockNodeForEnter){return true;}var _16,_17,_18,doc=this.editor.document,br;if(e.shiftKey||this.blockNodeForEnter=="BR"){var _1b=_4.withGlobal(this.editor.window,"getParentElement",_5._editor.selection);var _1c=_5.range.getAncestor(_1b,this.blockNodes);if(_1c){if(!e.shiftKey&&_1c.tagName=="LI"){return true;}_16=_5.range.getSelection(this.editor.window);_17=_16.getRangeAt(0);if(!_17.collapsed){_17.deleteContents();}if(_5.range.atBeginningOfContainer(_1c,_17.startContainer,_17.startOffset)){if(e.shiftKey){br=doc.createElement("br");_18=_5.range.create();_1c.insertBefore(br,_1c.firstChild);_18.setStartBefore(br.nextSibling);_16.removeAllRanges();_16.addRange(_18);}else{_4.place(br,_1c,"before");}}else{if(_5.range.atEndOfContainer(_1c,_17.startContainer,_17.startOffset)){_18=_5.range.create();br=doc.createElement("br");if(e.shiftKey){_1c.appendChild(br);_1c.appendChild(doc.createTextNode(" "));_18.setStart(_1c.lastChild,0);}else{_4.place(br,_1c,"after");_18.setStartAfter(_1c);}_16.removeAllRanges();_16.addRange(_18);}else{return true;}}}else{_5._editor.RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>");}return false;}var _1d=true;_16=_5.range.getSelection(this.editor.window);_17=_16.getRangeAt(0);if(!_17.collapsed){_17.deleteContents();}var _1e=_5.range.getBlockAncestor(_17.endContainer,null,this.editor.editNode);var _1f=_1e.blockNode;if((this._checkListLater=(_1f&&(_1f.nodeName=="LI"||_1f.parentNode.nodeName=="LI")))){if(_4.isMoz){this._pressedEnterInBlock=_1f;}if(/^(?:\s|&nbsp;)$/.test(_1f.innerHTML)){_1f.innerHTML="";}return true;}if(!_1e.blockNode||_1e.blockNode===this.editor.editNode){_5._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);_1e={blockNode:_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,[this.blockNodeForEnter]),blockContainer:this.editor.editNode};if(_1e.blockNode){if(!(_1e.blockNode.textContent||_1e.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length){this.removeTrailingBr(_1e.blockNode);return false;}}else{_1e.blockNode=this.editor.editNode;}_16=_5.range.getSelection(this.editor.window);_17=_16.getRangeAt(0);}var _20=doc.createElement(this.blockNodeForEnter);_20.innerHTML=this.bogusHtmlContent;this.removeTrailingBr(_1e.blockNode);if(_5.range.atEndOfContainer(_1e.blockNode,_17.endContainer,_17.endOffset)){if(_1e.blockNode===_1e.blockContainer){_1e.blockNode.appendChild(_20);}else{_4.place(_20,_1e.blockNode,"after");}_1d=false;_18=_5.range.create();_18.setStart(_20,0);_16.removeAllRanges();_16.addRange(_18);if(this.editor.height){_20.scrollIntoView(false);}}else{if(_5.range.atBeginningOfContainer(_1e.blockNode,_17.startContainer,_17.startOffset)){_4.place(_20,_1e.blockNode,_1e.blockNode===_1e.blockContainer?"first":"before");if(_20.nextSibling&&this.editor.height){_20.nextSibling.scrollIntoView(false);}_1d=false;}else{if(_4.isMoz){this._pressedEnterInBlock=_1e.blockNode;}}}return _1d;},removeTrailingBr:function(_21){var _22=/P|DIV|LI/i.test(_21.tagName)?_21:_5._editor.selection.getParentOfType(_21,["P","DIV","LI"]);if(!_22){return;}if(_22.lastChild){if((_22.childNodes.length>1&&_22.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(_22.lastChild.nodeValue))||(_22.lastChild&&_22.lastChild.tagName=="BR")){_4.destroy(_22.lastChild);}}if(!_22.childNodes.length){_22.innerHTML=this.bogusHtmlContent;}},_fixNewLineBehaviorForIE:function(d){if(this.editor.document.__INSERTED_EDITIOR_NEWLINE_CSS===undefined){var _24="p{margin:0 !important;}";var _25=function(_26,doc,URI){if(!_26){return null;}if(!doc){doc=document;}var _29=doc.createElement("style");_29.setAttribute("type","text/css");var _2a=doc.getElementsByTagName("head")[0];if(!_2a){console.debug("No head tag in document, aborting styles");return null;}else{_2a.appendChild(_29);}if(_29.styleSheet){var _2b=function(){try{_29.styleSheet.cssText=_26;}catch(e){console.debug(e);}};if(_29.styleSheet.disabled){setTimeout(_2b,10);}else{_2b();}}else{var _2c=doc.createTextNode(_26);_29.appendChild(_2c);}return _29;};_25(_24,this.editor.document);this.editor.document.__INSERTED_EDITIOR_NEWLINE_CSS=true;return d;}return null;},regularPsToSingleLinePs:function(_2d,_2e){function _2f(el){function _31(_32){var _33=_32[0].ownerDocument.createElement("p");_32[0].parentNode.insertBefore(_33,_32[0]);_4.forEach(_32,function(_34){_33.appendChild(_34);});};var _35=0;var _36=[];var _37;while(_35<el.childNodes.length){_37=el.childNodes[_35];if(_37.nodeType==3||(_37.nodeType==1&&_37.nodeName!="BR"&&_4.style(_37,"display")!="block")){_36.push(_37);}else{var _38=_37.nextSibling;if(_36.length){_31(_36);_35=(_35+1)-_36.length;if(_37.nodeName=="BR"){_4.destroy(_37);}}_36=[];}_35++;}if(_36.length){_31(_36);}};function _39(el){var _3b=null;var _3c=[];var _3d=el.childNodes.length-1;for(var i=_3d;i>=0;i--){_3b=el.childNodes[i];if(_3b.nodeName=="BR"){var _3f=_3b.ownerDocument.createElement("p");_4.place(_3f,el,"after");if(_3c.length==0&&i!=_3d){_3f.innerHTML="&nbsp;";}_4.forEach(_3c,function(_40){_3f.appendChild(_40);});_4.destroy(_3b);_3c=[];}else{_3c.unshift(_3b);}}};var _41=[];var ps=_2d.getElementsByTagName("p");_4.forEach(ps,function(p){_41.push(p);});_4.forEach(_41,function(p){if((p.previousSibling)&&(p.previousSibling.nodeName=="P"||_4.style(p.previousSibling,"display")!="block")){var _45=p.parentNode.insertBefore(this.document.createElement("p"),p);_45.innerHTML=_2e?"":"&nbsp;";}_39(p);},this.editor);_2f(_2d);return _2d;},singleLinePsToRegularPs:function(_46){function _47(_48){var ps=_48.getElementsByTagName("p");var _4a=[];for(var i=0;i<ps.length;i++){var p=ps[i];var _4d=false;for(var k=0;k<_4a.length;k++){if(_4a[k]===p.parentNode){_4d=true;break;}}if(!_4d){_4a.push(p.parentNode);}}return _4a;};function _4f(_50){if(_50.nodeType!=1||_50.tagName!="P"){return _4.style(_50,"display")=="block";}else{if(!_50.childNodes.length||_50.innerHTML=="&nbsp;"){return true;}}return false;};var _51=_47(_46);for(var i=0;i<_51.length;i++){var _53=_51[i];var _54=null;var _55=_53.firstChild;var _56=null;while(_55){if(_55.nodeType!="1"||_55.tagName!="P"){_54=null;}else{if(_4f(_55)){_56=_55;_54=null;}else{if(_54==null){_54=_55;}else{if((!_54.lastChild||_54.lastChild.nodeName!="BR")&&(_55.firstChild)&&(_55.firstChild.nodeName!="BR")){_54.appendChild(this.editor.document.createElement("br"));}while(_55.firstChild){_54.appendChild(_55.firstChild);}_56=_55;}}}_55=_55.nextSibling;if(_56){_4.destroy(_56);_56=null;}}}return _46;}});}}};});