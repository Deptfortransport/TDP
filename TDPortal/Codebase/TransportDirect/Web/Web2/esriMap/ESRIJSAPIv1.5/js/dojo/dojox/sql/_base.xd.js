/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.sql._base"],["require","dojox.sql._crypto"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.sql._base"]){_4._hasResource["dojox.sql._base"]=true;_4.provide("dojox.sql._base");_4.require("dojox.sql._crypto");_4.mixin(_6.sql,{dbName:null,debug:(_4.exists("dojox.sql.debug")?_6.sql.debug:false),open:function(_7){if(this._dbOpen&&(!_7||_7==this.dbName)){return;}if(!this.dbName){this.dbName="dot_store_"+window.location.href.replace(/[^0-9A-Za-z_]/g,"_");if(this.dbName.length>63){this.dbName=this.dbName.substring(0,63);}}if(!_7){_7=this.dbName;}try{this._initDb();this.db.open(_7);this._dbOpen=true;}catch(exp){throw exp.message||exp;}},close:function(_8){if(_4.isIE){return;}if(!this._dbOpen&&(!_8||_8==this.dbName)){return;}if(!_8){_8=this.dbName;}try{this.db.close(_8);this._dbOpen=false;}catch(exp){throw exp.message||exp;}},_exec:function(_9){try{this._initDb();if(!this._dbOpen){this.open();this._autoClose=true;}var _a=null;var _b=null;var _c=null;var _d=_4._toArray(_9);_a=_d.splice(0,1)[0];if(this._needsEncrypt(_a)||this._needsDecrypt(_a)){_b=_d.splice(_d.length-1,1)[0];_c=_d.splice(_d.length-1,1)[0];}if(this.debug){this._printDebugSQL(_a,_d);}var _e;if(this._needsEncrypt(_a)){_e=new _6.sql._SQLCrypto("encrypt",_a,_c,_d,_b);return null;}else{if(this._needsDecrypt(_a)){_e=new _6.sql._SQLCrypto("decrypt",_a,_c,_d,_b);return null;}}var rs=this.db.execute(_a,_d);rs=this._normalizeResults(rs);if(this._autoClose){this.close();}return rs;}catch(exp){exp=exp.message||exp;console.debug("SQL Exception: "+exp);if(this._autoClose){try{this.close();}catch(e){console.debug("Error closing database: "+e.message||e);}}throw exp;}return null;},_initDb:function(){if(!this.db){try{this.db=google.gears.factory.create("beta.database","1.0");}catch(exp){_4.setObject("google.gears.denied",true);if(_6.off){_6.off.onFrameworkEvent("coreOperationFailed");}throw "Google Gears must be allowed to run";}}},_printDebugSQL:function(sql,_11){var msg="dojox.sql(\""+sql+"\"";for(var i=0;i<_11.length;i++){if(typeof _11[i]=="string"){msg+=", \""+_11[i]+"\"";}else{msg+=", "+_11[i];}}msg+=")";console.debug(msg);},_normalizeResults:function(rs){var _15=[];if(!rs){return [];}while(rs.isValidRow()){var row={};for(var i=0;i<rs.fieldCount();i++){var _18=rs.fieldName(i);var _19=rs.field(i);row[_18]=_19;}_15.push(row);rs.next();}rs.close();return _15;},_needsEncrypt:function(sql){return /encrypt\([^\)]*\)/i.test(sql);},_needsDecrypt:function(sql){return /decrypt\([^\)]*\)/i.test(sql);}});_4.declare("dojox.sql._SQLCrypto",null,{constructor:function(_1c,sql,_1e,_1f,_20){if(_1c=="encrypt"){this._execEncryptSQL(sql,_1e,_1f,_20);}else{this._execDecryptSQL(sql,_1e,_1f,_20);}},_execEncryptSQL:function(sql,_22,_23,_24){var _25=this._stripCryptoSQL(sql);var _26=this._flagEncryptedArgs(sql,_23);var _27=this;this._encrypt(_25,_22,_23,_26,function(_28){var _29=false;var _2a=[];var exp=null;try{_2a=_6.sql.db.execute(_25,_28);}catch(execError){_29=true;exp=execError.message||execError;}if(exp!=null){if(_6.sql._autoClose){try{_6.sql.close();}catch(e){}}_24(null,true,exp.toString());return;}_2a=_6.sql._normalizeResults(_2a);if(_6.sql._autoClose){_6.sql.close();}if(_6.sql._needsDecrypt(sql)){var _2c=_27._determineDecryptedColumns(sql);_27._decrypt(_2a,_2c,_22,function(_2d){_24(_2d,false,null);});}else{_24(_2a,false,null);}});},_execDecryptSQL:function(sql,_2f,_30,_31){var _32=this._stripCryptoSQL(sql);var _33=this._determineDecryptedColumns(sql);var _34=false;var _35=[];var exp=null;try{_35=_6.sql.db.execute(_32,_30);}catch(execError){_34=true;exp=execError.message||execError;}if(exp!=null){if(_6.sql._autoClose){try{_6.sql.close();}catch(e){}}_31(_35,true,exp.toString());return;}_35=_6.sql._normalizeResults(_35);if(_6.sql._autoClose){_6.sql.close();}this._decrypt(_35,_33,_2f,function(_37){_31(_37,false,null);});},_encrypt:function(sql,_39,_3a,_3b,_3c){this._totalCrypto=0;this._finishedCrypto=0;this._finishedSpawningCrypto=false;this._finalArgs=_3a;for(var i=0;i<_3a.length;i++){if(_3b[i]){var _3e=_3a[i];var _3f=i;this._totalCrypto++;_6.sql._crypto.encrypt(_3e,_39,_4.hitch(this,function(_40){this._finalArgs[_3f]=_40;this._finishedCrypto++;if(this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto){_3c(this._finalArgs);}}));}}this._finishedSpawningCrypto=true;},_decrypt:function(_41,_42,_43,_44){this._totalCrypto=0;this._finishedCrypto=0;this._finishedSpawningCrypto=false;this._finalResultSet=_41;for(var i=0;i<_41.length;i++){var row=_41[i];for(var _47 in row){if(_42=="*"||_42[_47]){this._totalCrypto++;var _48=row[_47];this._decryptSingleColumn(_47,_48,_43,i,function(_49){_44(_49);});}}}this._finishedSpawningCrypto=true;},_stripCryptoSQL:function(sql){sql=sql.replace(/DECRYPT\(\*\)/ig,"*");var _4b=sql.match(/ENCRYPT\([^\)]*\)/ig);if(_4b!=null){for(var i=0;i<_4b.length;i++){var _4d=_4b[i];var _4e=_4d.match(/ENCRYPT\(([^\)]*)\)/i)[1];sql=sql.replace(_4d,_4e);}}_4b=sql.match(/DECRYPT\([^\)]*\)/ig);if(_4b!=null){for(i=0;i<_4b.length;i++){var _4f=_4b[i];var _50=_4f.match(/DECRYPT\(([^\)]*)\)/i)[1];sql=sql.replace(_4f,_50);}}return sql;},_flagEncryptedArgs:function(sql,_52){var _53=new RegExp(/([\"][^\"]*\?[^\"]*[\"])|([\'][^\']*\?[^\']*[\'])|(\?)/ig);var _54;var _55=0;var _56=[];while((_54=_53.exec(sql))!=null){var _57=RegExp.lastMatch+"";if(/^[\"\']/.test(_57)){continue;}var _58=false;if(/ENCRYPT\([^\)]*$/i.test(RegExp.leftContext)){_58=true;}_56[_55]=_58;_55++;}return _56;},_determineDecryptedColumns:function(sql){var _5a={};if(/DECRYPT\(\*\)/i.test(sql)){_5a="*";}else{var _5b=/DECRYPT\((?:\s*\w*\s*\,?)*\)/ig;var _5c=_5b.exec(sql);while(_5c){var _5d=new String(RegExp.lastMatch);var _5e=_5d.replace(/DECRYPT\(/i,"");_5e=_5e.replace(/\)/,"");_5e=_5e.split(/\s*,\s*/);_4.forEach(_5e,function(_5f){if(/\s*\w* AS (\w*)/i.test(_5f)){_5f=_5f.match(/\s*\w* AS (\w*)/i)[1];}_5a[_5f]=true;});_5c=_5b.exec(sql);}}return _5a;},_decryptSingleColumn:function(_60,_61,_62,_63,_64){_6.sql._crypto.decrypt(_61,_62,_4.hitch(this,function(_65){this._finalResultSet[_63][_60]=_65;this._finishedCrypto++;if(this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto){_64(this._finalResultSet);}}));}});(function(){var _66=_6.sql;_6.sql=new Function("return dojox.sql._exec(arguments);");_4.mixin(_6.sql,_66);})();}}};});