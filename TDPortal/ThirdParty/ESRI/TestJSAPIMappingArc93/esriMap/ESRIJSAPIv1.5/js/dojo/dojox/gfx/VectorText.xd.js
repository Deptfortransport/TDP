/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.gfx.VectorText"],["require","dojox.gfx"],["require","dojox.xml.DomParser"],["require","dojox.html.metrics"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.gfx.VectorText"]){_4._hasResource["dojox.gfx.VectorText"]=true;_4.provide("dojox.gfx.VectorText");_4.require("dojox.gfx");_4.require("dojox.xml.DomParser");_4.require("dojox.html.metrics");(function(){_4.mixin(_6.gfx,{vectorFontFitting:{NONE:0,FLOW:1,FIT:2},defaultVectorText:{type:"vectortext",x:0,y:0,width:null,height:null,text:"",align:"start",decoration:"none",fitting:0,leading:1.5},defaultVectorFont:{type:"vectorfont",size:"10pt",family:null},_vectorFontCache:{},_svgFontCache:{},getVectorFont:function(_7){if(_6.gfx._vectorFontCache[_7]){return _6.gfx._vectorFontCache[_7];}return new _6.gfx.VectorFont(_7);}});_4.declare("dojox.gfx.VectorFont",null,{_entityRe:/&(quot|apos|lt|gt|amp|#x[^;]+|#\d+);/g,_decodeEntitySequence:function(_8){if(!_8.match(this._entityRe)){return;}var _9={amp:"&",apos:"'",quot:"\"",lt:"<",gt:">"};var r,_b="";while((r=this._entityRe.exec(_8))!==null){if(r[1].charAt(1)=="x"){_b+=String.fromCharCode(r[1].slice(2),16);}else{if(!isNaN(parseInt(r[1].slice(1),10))){_b+=String.fromCharCode(r[1].slice(1));}else{_b+=_9(r[1]);}}}return _b;},_parse:function(_c,_d){var _e=_6.gfx._svgFontCache[_d]||_6.xml.DomParser.parse(_c);var f=_e.documentElement.byName("font")[0],_10=_e.documentElement.byName("font-face")[0];var _11=parseFloat(_10.getAttribute("units-per-em")||1000,10);var _12={x:parseFloat(f.getAttribute("horiz-adv-x"),10),y:parseFloat(f.getAttribute("vert-adv-y")||0,10)};if(!_12.y){_12.y=_11;}var _13={horiz:{x:parseFloat(f.getAttribute("horiz-origin-x")||0,10),y:parseFloat(f.getAttribute("horiz-origin-y")||0,10)},vert:{x:parseFloat(f.getAttribute("vert-origin-x")||0,10),y:parseFloat(f.getAttribute("vert-origin-y")||0,10)}};var _14=_10.getAttribute("font-family"),_15=_10.getAttribute("font-style")||"all",_16=_10.getAttribute("font-variant")||"normal",_17=_10.getAttribute("font-weight")||"all",_18=_10.getAttribute("font-stretch")||"normal",_19=_10.getAttribute("unicode-range")||"U+0-10FFFF",_1a=_10.getAttribute("panose-1")||"0 0 0 0 0 0 0 0 0 0",_1b=_10.getAttribute("cap-height"),_1c=parseFloat(_10.getAttribute("ascent")||(_11-_13.vert.y),10),_1d=parseFloat(_10.getAttribute("descent")||_13.vert.y,10),_1e={};var _1f=_14;if(_10.byName("font-face-name")[0]){_1f=_10.byName("font-face-name")[0].getAttribute("name");}if(_6.gfx._vectorFontCache[_1f]){return;}_4.forEach(["alphabetic","ideographic","mathematical","hanging"],function(_20){var a=_10.getAttribute(_20);if(a!==null){_1e[_20]=parseFloat(a,10);}});var _22=parseFloat(_e.documentElement.byName("missing-glyph")[0].getAttribute("horiz-adv-x")||_12.x,10);var _23={},_24={},g=_e.documentElement.byName("glyph");_4.forEach(g,function(_26){var _27=_26.getAttribute("unicode"),_1f=_26.getAttribute("glyph-name"),_28=parseFloat(_26.getAttribute("horiz-adv-x")||_12.x,10),_29=_26.getAttribute("d");if(_27.match(this._entityRe)){_27=this._decodeEntitySequence(_27);}var o={code:_27,name:_1f,xAdvance:_28,path:_29};_23[_27]=o;_24[_1f]=o;},this);var _2b=_e.documentElement.byName("hkern");_4.forEach(_2b,function(_2c,i){var k=-parseInt(_2c.getAttribute("k"),10);var u1=_2c.getAttribute("u1"),g1=_2c.getAttribute("g1"),u2=_2c.getAttribute("u2"),g2=_2c.getAttribute("g2"),gl;if(u1){u1=this._decodeEntitySequence(u1);if(_23[u1]){gl=_23[u1];}}else{if(_24[g1]){gl=_24[g1];}}if(gl){if(!gl.kern){gl.kern={};}if(u2){u2=this._decodeEntitySequence(u2);gl.kern[u2]={x:k};}else{if(_24[g2]){gl.kern[_24[g2].code]={x:k};}}}},this);_4.mixin(this,{family:_14,name:_1f,style:_15,variant:_16,weight:_17,stretch:_18,range:_19,viewbox:{width:_11,height:_11},origin:_13,advance:_4.mixin(_12,{missing:{x:_22,y:_22}}),ascent:_1c,descent:_1d,baseline:_1e,glyphs:_23});_6.gfx._vectorFontCache[_1f]=this;_6.gfx._vectorFontCache[_d]=this;if(_1f!=_14&&!_6.gfx._vectorFontCache[_14]){_6.gfx._vectorFontCache[_14]=this;}if(!_6.gfx._svgFontCache[_d]){_6.gfx._svgFontCache[_d]=_e;}},_clean:function(){var _34=this.name,_35=this.family;_4.forEach(["family","name","style","variant","weight","stretch","range","viewbox","origin","advance","ascent","descent","baseline","glyphs"],function(_36){try{delete this[_36];}catch(e){}},this);if(_6.gfx._vectorFontCache[_34]){delete _6.gfx._vectorFontCache[_34];}if(_6.gfx._vectorFontCache[_35]){delete _6.gfx._vectorFontCache[_35];}return this;},constructor:function(url){this._defaultLeading=1.5;if(url!==undefined){this.load(url);}},load:function(url){this.onLoadBegin(url.toString());this._parse(_6.gfx._svgFontCache[url.toString()]||_4._getText(url.toString()),url.toString());this.onLoad(this);return this;},initialized:function(){return (this.glyphs!==null);},_round:function(n){return Math.round(1000*n)/1000;},_leading:function(_3a){return this.viewbox.height*(_3a||this._defaultLeading);},_normalize:function(str){return str.replace(/\s+/g,String.fromCharCode(32));},_getWidth:function(_3c){var w=0,_3e=0,_3f=null;_4.forEach(_3c,function(_40,i){_3e=_40.xAdvance;if(_3c[i]&&_40.kern&&_40.kern[_3c[i].code]){_3e+=_40.kern[_3c[i].code].x;}w+=_3e;_3f=_40;});if(_3f&&_3f.code==" "){w-=_3f.xAdvance;}return this._round(w);},_getLongestLine:function(_42){var _43=0,idx=0;_4.forEach(_42,function(_45,i){var max=Math.max(_43,this._getWidth(_45));if(max>_43){_43=max;idx=i;}},this);return {width:_43,index:idx,line:_42[idx]};},_trim:function(_48){var fn=function(arr){if(!arr.length){return;}if(arr[arr.length-1].code==" "){arr.splice(arr.length-1,1);}if(!arr.length){return;}if(arr[0].code==" "){arr.splice(0,1);}};if(_4.isArray(_48[0])){_4.forEach(_48,fn);}else{fn(_48);}return _48;},_split:function(_4b,_4c){var w=this._getWidth(_4b),_4e=Math.floor(w/_4c),_4f=[],cw=0,c=[],_52=false;for(var i=0,l=_4b.length;i<l;i++){if(_4b[i].code==" "){_52=true;}cw+=_4b[i].xAdvance;if(i+1<l&&_4b[i].kern&&_4b[i].kern[_4b[i+1].code]){cw+=_4b[i].kern[_4b[i+1].code].x;}if(cw>=_4e){var chr=_4b[i];while(_52&&chr.code!=" "&&i>=0){chr=c.pop();i--;}_4f.push(c);c=[];cw=0;_52=false;}c.push(_4b[i]);}if(c.length){_4f.push(c);}return this._trim(_4f);},_getSizeFactor:function(_56){_56+="";var _57=_6.html.metrics.getCachedFontMeasurements(),_58=this.viewbox.height,f=_57["1em"],_5a=parseFloat(_56,10);if(_56.indexOf("em")>-1){return this._round((_57["1em"]*_5a)/_58);}else{if(_56.indexOf("ex")>-1){return this._round((_57["1ex"]*_5a)/_58);}else{if(_56.indexOf("pt")>-1){return this._round(((_57["12pt"]/12)*_5a)/_58);}else{if(_56.indexOf("px")>-1){return this._round(((_57["16px"]/16)*_5a)/_58);}else{if(_56.indexOf("%")>-1){return this._round((_57["1em"]*(_5a/100))/_58);}else{f=_57[_56]||_57.medium;return this._round(f/_58);}}}}}},_getFitFactor:function(_5b,w,h,l){if(!h){return this._round(w/this._getWidth(_5b));}else{var _5f=this._getLongestLine(_5b).width,_60=(_5b.length*(this.viewbox.height*l))-((this.viewbox.height*l)-this.viewbox.height);return this._round(Math.min(w/_5f,h/_60));}},_getBestFit:function(_61,w,h,_64){var _65=32,_66=0,_67=_65;while(_65>0){var f=this._getFitFactor(this._split(_61,_65),w,h,_64);if(f>_66){_66=f;_67=_65;}_65--;}return {scale:_66,lines:this._split(_61,_67)};},_getBestFlow:function(_69,w,_6b){var _6c=[],cw=0,c=[],_6f=false;for(var i=0,l=_69.length;i<l;i++){if(_69[i].code==" "){_6f=true;}var tw=_69[i].xAdvance;if(i+1<l&&_69[i].kern&&_69[i].kern[_69[i+1].code]){tw+=_69[i].kern[_69[i+1].code].x;}cw+=_6b*tw;if(cw>=w){var chr=_69[i];while(_6f&&chr.code!=" "&&i>=0){chr=c.pop();i--;}_6c.push(c);c=[];cw=0;_6f=false;}c.push(_69[i]);}if(c.length){_6c.push(c);}return this._trim(_6c);},getWidth:function(_74,_75){return this._getWidth(_4.map(this._normalize(_74).split(""),function(chr){return this.glyphs[chr]||{xAdvance:this.advance.missing.x};},this))*(_75||1);},getLineHeight:function(_77){return this.viewbox.height*(_77||1);},getCenterline:function(_78){return (_78||1)*(this.viewbox.height/2);},getBaseline:function(_79){return (_79||1)*(this.viewbox.height+this.descent);},draw:function(_7a,_7b,_7c,_7d,_7e){if(!this.initialized()){throw new Error("dojox.gfx.VectorFont.draw(): we have not been initialized yet.");}var g=_7a.createGroup();if(_7b.x||_7b.y){_7a.applyTransform({dx:_7b.x||0,dy:_7b.y||0});}var _80=_4.map(this._normalize(_7b.text).split(""),function(chr){return this.glyphs[chr]||{path:null,xAdvance:this.advance.missing.x};},this);var _82=_7c.size,_83=_7b.fitting,_84=_7b.width,_85=_7b.height,_86=_7b.align,_87=_7b.leading||this._defaultLeading;if(_83){if((_83==_6.gfx.vectorFontFitting.FLOW&&!_84)||(_83==_6.gfx.vectorFontFitting.FIT&&(!_84||!_85))){_83=_6.gfx.vectorFontFitting.NONE;}}var _88,_89;switch(_83){case _6.gfx.vectorFontFitting.FIT:var o=this._getBestFit(_80,_84,_85,_87);_89=o.scale;_88=o.lines;break;case _6.gfx.vectorFontFitting.FLOW:_89=this._getSizeFactor(_82);_88=this._getBestFlow(_80,_84,_89);break;default:_89=this._getSizeFactor(_82);_88=[_80];}_88=_4.filter(_88,function(_8b){return _8b.length>0;});var cy=0,_8d=this._getLongestLine(_88).width;for(var i=0,l=_88.length;i<l;i++){var cx=0,_91=_88[i],_92=this._getWidth(_91),lg=g.createGroup();for(var j=0;j<_91.length;j++){var _95=_91[j];if(_95.path!==null){var p=lg.createPath(_95.path).setFill(_7d);if(_7e){p.setStroke(_7e);}p.setTransform([_6.gfx.matrix.flipY,_6.gfx.matrix.translate(cx,-this.viewbox.height-this.descent)]);}cx+=_95.xAdvance;if(j+1<_91.length&&_95.kern&&_95.kern[_91[j+1].code]){cx+=_95.kern[_91[j+1].code].x;}}var dx=0;if(_86=="middle"){dx=_8d/2-_92/2;}else{if(_86=="end"){dx=_8d-_92;}}lg.setTransform({dx:dx,dy:cy});cy+=this.viewbox.height*_87;}g.setTransform(_6.gfx.matrix.scale(_89));return g;},onLoadBegin:function(url){},onLoad:function(_99){}});})();}}};});