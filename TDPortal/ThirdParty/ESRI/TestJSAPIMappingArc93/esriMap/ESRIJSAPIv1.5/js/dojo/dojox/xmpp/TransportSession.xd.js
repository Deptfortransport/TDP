/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.xmpp.TransportSession"],["require","dojox.xmpp.util"],["require","dojo.io.script"],["require","dojo.io.iframe"],["require","dojox.data.dom"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.xmpp.TransportSession"]){_4._hasResource["dojox.xmpp.TransportSession"]=true;_4.provide("dojox.xmpp.TransportSession");_4.require("dojox.xmpp.util");_4.require("dojo.io.script");_4.require("dojo.io.iframe");_4.require("dojox.data.dom");_6.xmpp.TransportSession=function(_7){if(_7&&_4.isObject(_7)){_4.mixin(this,_7);if(this.useScriptSrcTransport){this.transportIframes=[];}}};_6.xmpp.TransportSession._iframeOnload=function(_8){var _9=_4.io.iframe.doc(_4.byId("xmpp-transport-"+_8));_9.write("<script>var isLoaded=true; var rid=0; var transmiting=false; function _BOSH_(msg) { transmiting=false; parent.dojox.xmpp.TransportSession.handleBOSH(msg, rid); } </script>");};_6.xmpp.TransportSession.handleBOSH=function(_a,_b){};_4.extend(_6.xmpp.TransportSession,{rid:0,hold:1,polling:1000,secure:false,wait:60,lang:"en",submitContentType:"text/xml; charset=utf=8",serviceUrl:"/httpbind",defaultResource:"dojoIm",domain:"imserver.com",sendTimeout:(this.wait+20)*1000,useScriptSrcTransport:false,keepAliveTimer:null,state:"NotReady",transmitState:"Idle",protocolPacketQueue:[],outboundQueue:[],outboundRequests:{},inboundQueue:[],deferredRequests:{},matchTypeIdAttribute:{},open:function(){this.status="notReady";this.rid=Math.round(Math.random()*1000000000);this.protocolPacketQueue=[];this.outboundQueue=[];this.outboundRequests={};this.inboundQueue=[];this.deferredRequests={};this.matchTypeIdAttribute={};this.keepAliveTimer=setTimeout(_4.hitch(this,"_keepAlive"),10000);if(this.useScriptSrcTransport){_4.connect(_6.xmpp.TransportSession,"handleBOSH",this,"processScriptSrc");this.transportIframes=[];for(var i=0;i<=this.hold;i++){var _d=_4.io.iframe.create("xmpp-transport-"+i,_6._scopeName+".xmpp.TransportSession._iframeOnload("+i+");");this.transportIframes.push(_d);if(i==0){_4.connect(_d,"onload",this,"_sendLogin");}}}else{this._sendLogin();}},_sendLogin:function(){var _e=this.rid++;var _f={content:this.submitContentType,hold:this.hold,rid:_e,to:this.domain,secure:this.secure,wait:this.wait,"xml:lang":this.lang,xmlns:_6.xmpp.xmpp.BODY_NS};var msg=_6.xmpp.util.createElement("body",_f,true);this.addToOutboundQueue(msg,_e);},processScriptSrc:function(msg,rid){var _13=_6.data.dom.createDocument(msg,"text/xml");if(_13){this.processDocument(_13,rid);}else{}},_keepAlive:function(){if(this.state=="wait"||this.isTerminated()){return;}this._dispatchPacket();this.keepAliveTimer=setTimeout(_4.hitch(this,"_keepAlive"),10000);},close:function(_14){var rid=this.rid++;var req={sid:this.sid,rid:rid,type:"terminate"};var _17=null;if(_14){_17=new _6.string.Builder(_6.xmpp.util.createElement("body",req,false));_17.append(_14);_17.append("</body>");}else{_17=new _6.string.Builder(_6.xmpp.util.createElement("body",req,false));}this.addToOutboundQueue(_17.toString(),rid);this.state=="Terminate";},dispatchPacket:function(msg,_19,_1a,_1b){if(msg){this.protocolPacketQueue.push(msg);}var def=new _4.Deferred();if(_19&&_1a){def.protocolMatchType=_19;def.matchId=_1a;def.matchProperty=_1b||"id";if(def.matchProperty!="id"){this.matchTypeIdAttribute[_19]=def.matchProperty;}}this.deferredRequests[def.protocolMatchType+"-"+def.matchId]=def;if(!this.dispatchTimer){this.dispatchTimer=setTimeout(_4.hitch(this,"_dispatchPacket"),600);}return def;},_dispatchPacket:function(){clearTimeout(this.dispatchTimer);delete this.dispatchTimer;if(!this.sid){console.debug("TransportSession::dispatchPacket() No SID, packet dropped.");return;}if(!this.authId){console.debug("TransportSession::dispatchPacket() No authId, packet dropped [FIXME]");return;}if(this.transmitState!="error"&&(this.protocolPacketQueue.length==0)&&(this.outboundQueue.length>0)){return;}if(this.state=="wait"||this.isTerminated()){return;}var req={sid:this.sid};if(this.protocolPacketQueue.length>0){req.rid=this.rid++;var _1e=new _6.string.Builder(_6.xmpp.util.createElement("body",req,false));_1e.append(this.processProtocolPacketQueue());_1e.append("</body>");delete this.lastPollTime;}else{if(this.lastPollTime){var now=new Date().getTime();if(now-this.lastPollTime<this.polling){this.dispatchTimer=setTimeout(_4.hitch(this,"_dispatchPacket"),this.polling-(now-this.lastPollTime)+10);return;}}req.rid=this.rid++;this.lastPollTime=new Date().getTime();var _1e=new _6.string.Builder(_6.xmpp.util.createElement("body",req,true));}this.addToOutboundQueue(_1e.toString(),req.rid);},redispatchPacket:function(rid){var env=this.outboundRequests[rid];this.sendXml(env,rid);},addToOutboundQueue:function(msg,rid){this.outboundQueue.push({msg:msg,rid:rid});this.outboundRequests[rid]=msg;this.sendXml(msg,rid);},removeFromOutboundQueue:function(rid){for(var i=0;i<this.outboundQueue.length;i++){if(rid==this.outboundQueue[i]["rid"]){this.outboundQueue.splice(i,1);break;}}delete this.outboundRequests[rid];},processProtocolPacketQueue:function(){var _26=new _6.string.Builder();for(var i=0;i<this.protocolPacketQueue.length;i++){_26.append(this.protocolPacketQueue[i]);}this.protocolPacketQueue=[];return _26.toString();},findOpenIframe:function(){for(var i=0;i<this.transportIframes.length;i++){var _29=this.transportIframes[i];var win=_29.contentWindow;if(win.isLoaded&&!win.transmiting){return _29;}}},sendXml:function(_2b,rid){if(this.isTerminated()){return;}this.transmitState="transmitting";if(this.useScriptSrcTransport){var _2d=this.findOpenIframe();var _2e=_4.io.iframe.doc(_2d);_2d.contentWindow.rid=rid;_2d.contentWindow.transmiting=true;_4.io.script.attach("rid-"+rid,this.serviceUrl+"?"+encodeURIComponent(_2b),_2e);}else{var def=_4.rawXhrPost({contentType:"text/xml",url:this.serviceUrl,postData:_2b,handleAs:"xml",error:_4.hitch(this,function(res,io){return this.processError(io.xhr.responseXML,io.xhr.status,rid);}),timeout:this.sendTimeout});def.addCallback(this,function(res){return this.processDocument(res,rid);});return def;}},processDocument:function(doc,rid){if(this.isTerminated()){return;}this.transmitState="idle";var _35=doc.firstChild;if(_35.nodeName!="body"){}if(this.outboundQueue.length<1){return;}var _36=this.outboundQueue[0]["rid"];if(rid==_36){this.removeFromOutboundQueue(rid);this.processResponse(_35,rid);this.processInboundQueue();}else{var gap=rid-_36;if(gap<this.hold+2){this.addToInboundQueue(doc,rid);}else{}}return doc;},processInboundQueue:function(){while(this.inboundQueue.length>0){var _38=this.inboundQueue.shift();this.processDocument(_38["doc"],_38["rid"]);}},addToInboundQueue:function(doc,rid){for(var i=0;i<this.inboundQueue.length;i++){if(rid<this.inboundQueue[i]["rid"]){continue;}this.inboundQueue.splice(i,0,{doc:doc,rid:rid});}},processResponse:function(_3c,rid){if(_3c.getAttribute("type")=="terminate"){var _3e=_3c.firstChild.firstChild;var _3f="";if(_3e.nodeName=="conflict"){_3f="conflict";}this.setState("Terminate",_3f);return;}if((this.state!="Ready")&&(this.state!="Terminate")){var sid=_3c.getAttribute("sid");if(sid){this.sid=sid;}else{throw new Error("No sid returned during xmpp session startup");}this.authId=_3c.getAttribute("authid");if(this.authId==""){if(this.authRetries--<1){console.error("Unable to obtain Authorization ID");this.terminateSession();}}this.wait=_3c.getAttribute("wait");if(_3c.getAttribute("polling")){this.polling=parseInt(_3c.getAttribute("polling"))*1000;}this.inactivity=_3c.getAttribute("inactivity");this.setState("Ready");}_4.forEach(_3c.childNodes,function(_41){this.processProtocolResponse(_41,rid);},this);if(this.transmitState=="idle"){this.dispatchPacket();}},processProtocolResponse:function(msg,rid){this.onProcessProtocolResponse(msg);var key=msg.nodeName+"-"+msg.getAttribute("id");var def=this.deferredRequests[key];if(def){def.callback(msg);delete this.deferredRequests[key];}},setState:function(_46,_47){if(this.state!=_46){if(this["on"+_46]){this["on"+_46](_46,this.state,_47);}this.state=_46;}},isTerminated:function(){return this.state=="Terminate";},processError:function(err,_49,rid){if(this.isTerminated()){return;}if(_49!=200){this.setState("Terminate",_4b);return;}if(err&&err.dojoType&&err.dojoType=="timeout"){}this.removeFromOutboundQueue(rid);if(err&&err.firstChild){if(err.firstChild.getAttribute("type")=="terminate"){var _4c=err.firstChild.firstChild;var _4b="";if(_4c&&_4c.nodeName=="conflict"){_4b="conflict";}this.setState("Terminate",_4b);return;}}this.transmitState="error";setTimeout(_4.hitch(this,function(){this.dispatchPacket();}),200);return true;},onTerminate:function(_4d,_4e,_4f){},onProcessProtocolResponse:function(msg){},onReady:function(_51,_52){}});}}};});