/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.form.FileUploader"],["require","dojox.embed.Flash"],["require","dojo.io.iframe"],["require","dojox.html.styles"],["require","dijit._Widget"],["require","dijit._Templated"],["require","dojox.embed.flashVars"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.form.FileUploader"]){_4._hasResource["dojox.form.FileUploader"]=true;_4.provide("dojox.form.FileUploader");_4.require("dojox.embed.Flash");_4.require("dojo.io.iframe");_4.require("dojox.html.styles");_4.require("dijit._Widget");_4.require("dijit._Templated");_4.require("dojox.embed.flashVars");_4.experimental("dojox.form.FileUploader");(function(){var _7=_4.config.uploaderPath||_4.moduleUrl("dojox.form","resources/uploader.swf");var _8=function(o1,o2){var o={},nm;for(nm in o1){if(_4.isObject(o1[nm])){o[nm]=_8({},o1[nm]);}else{o[nm]=o1[nm];}}for(nm in o2){if(_4.isObject(o2[nm])){if(_4.isObject(o[nm])){_8(o[nm],o2[nm]);}else{_8({},o2[nm]);}}else{o[nm]=o2[nm];}}return o;};var _d=function(_e){if(!_e||_e=="none"){return false;}return _e.replace(/:/g,"||").replace(/\./g,"^^").replace("url(","").replace(")","").replace(/'/g,"").replace(/"/g,"");};var _f=function(_10){var tn=_10.tagName.toLowerCase();return tn=="button"||tn=="input";};var _12=function(_13){var o={};o.ff=_4.style(_13,"fontFamily");o.ff=o.ff.replace(/\"|\'/g,"");o.fw=_4.style(_13,"fontWeight");o.fi=_4.style(_13,"fontStyle");o.fs=parseInt(_4.style(_13,"fontSize"),10);o.fc=new _4.Color(_4.style(_13,"color")).toHex();o.fc=parseInt(o.fc.substring(1,Infinity),16);o.lh=_4.style(_13,"lineHeight");o.ta=_4.style(_13,"textAlign");o.ta=o.ta=="start"||!o.ta?"left":o.ta;o.va=_f(_13)?"middle":o.lh==o.h?"middle":_4.style(_13,"verticalAlign");return o;};var _15=function(_16){var cn=_4.trim(_16.innerHTML);if(cn.indexOf("<")>-1){cn=escape(cn);}return cn;};var _18=function(_19){var o={};var dim=_4.contentBox(_19);var pad=_4._getPadExtents(_19);o.p=[pad.t,pad.w-pad.l,pad.h-pad.t,pad.l];o.w=dim.w+pad.w;o.h=dim.h+pad.h;o.d=_4.style(_19,"display");var clr=new _4.Color(_4.style(_19,"backgroundColor"));o.bc=clr.a==0?"#ffffff":clr.toHex();o.bc=parseInt(o.bc.substring(1,Infinity),16);var url=_d(_4.style(_19,"backgroundImage"));if(url){o.bi={url:url,rp:_4.style(_19,"backgroundRepeat"),pos:escape(_4.style(_19,"backgroundPosition"))};if(!o.bi.pos){var rx=_4.style(_19,"backgroundPositionX");var ry=_4.style(_19,"backgroundPositionY");rx=(rx=="left")?"0%":(rx=="right")?"100%":rx;ry=(ry=="top")?"0%":(ry=="bottom")?"100%":ry;o.bi.pos=escape(rx+" "+ry);}}return _8(o,_12(_19));};var _21=function(_22,_23,_24){var _25,_26;if(_24){_25=_4.place("<"+_22.tagName+"><span>"+_22.innerHTML+" "+_23+"</span></"+_22.tagName+">",_22.parentNode);var _27=_25.firstChild;_4.addClass(_27,_22.className);_4.addClass(_25,_23);_26=_18(_27);}else{_25=_4.place("<"+_22.tagName+">"+_22.innerHTML+"</"+_22.tagName+">",_22.parentNode);_4.addClass(_25,_22.className);_4.addClass(_25,_23);_25.id=_22.id;_26=_18(_25);}_4.destroy(_25);return _26;};var _28=function(ltr){return ltr.charCodeAt(0)<91;};_4.declare("dojox.form.FileUploader",[_5._Widget,_5._Templated],{uploadUrl:"",uploadOnChange:false,selectMultipleFiles:true,htmlFieldName:"uploadedfile",flashFieldName:"flashUploadFiles",fileMask:[],minFlashVersion:9,tabIndex:-1,showProgress:false,progressMessage:"Loading",progressBackgroundUrl:_4.moduleUrl("dijit","themes/tundra/images/buttonActive.png"),progressBackgroundColor:"#ededed",progressWidgetId:"",templateString:"<div><div dojoAttachPoint=\"progNode\"><div dojoAttachPoint=\"progTextNode\"></div></div><div dojoAttachPoint=\"insideNode\"></div></div>",log:function(){if(this.isDebug){console.log.apply(console,arguments);}},postMixInProperties:function(){this.fileList=[];this._subs=[];this._cons=[];this.fileInputs=[];this.fileCount=0;this.flashReady=false;this._disabled=false;this.uploaderType=((_6.embed.Flash.available>=this.minFlashVersion||this.force=="flash")&&this.force!="html")?"flash":"html";if(!this.swfPath){this.swfPath=_7;}this.getButtonStyle();},postCreate:function(){this.setButtonStyle();if(this.uploaderType=="flash"){this.uploaderType="flash";this.createFlashUploader();}else{this.uploaderType="html";this.createHtmlUploader();}if(this.fileListId){_4.connect(_4.byId(this.fileListId),"click",this,function(evt){var p=evt.target.parentNode.parentNode.parentNode;if(p.id&&p.id.indexOf("file_")>-1){this.removeFile(p.id.split("file_")[1]);}});}},getButtonStyle:function(){if(!this.srcNodeRef&&this.button&&this.button.domNode){this.isDijitButton=true;var cls=this.button.domNode.className+" dijitButtonNode";var txt=_15(_4.query(".dijitButtonText",this.button.domNode)[0]);var _2e="<button id=\""+this.button.id+"\" class=\""+cls+"\">"+txt+"</button>";this.srcNodeRef=_4.place(_2e,this.button.domNode,"after");this.button.destroy();this.hoverClass="dijitButtonHover";this.pressClass="dijitButtonActive";this.disabledClass="dijitButtonDisabled";}this.norm=_18(this.srcNodeRef);this.width=this.norm.w;this.height=this.norm.h;if(this.uploaderType=="flash"){if(this.hoverClass){this.over=_21(this.srcNodeRef,this.hoverClass,this.isDijitButton);}else{this.over=_8({},this.norm);}if(this.activeClass){this.down=_21(this.srcNodeRef,this.activeClass,this.isDijitButton);}else{this.down=_8({},this.norm);}if(this.disabledClass){this.dsbl=_21(this.srcNodeRef,this.disabledClass,this.isDijitButton);}else{this.dsbl=_8({},this.norm);}this.fhtml={cn:_15(this.srcNodeRef),nr:this.norm,ov:this.over,dn:this.down,ds:this.dsbl};}else{this.fhtml={cn:_15(this.srcNodeRef),nr:this.norm};}},setButtonStyle:function(){_4.style(this.domNode,{width:this.fhtml.nr.w+"px",height:(this.fhtml.nr.h)+"px",padding:"0px",lineHeight:"normal",position:"relative"});if(this.showProgress){this.progTextNode.innerHTML=this.progressMessage;_4.style(this.progTextNode,{width:this.fhtml.nr.w+"px",height:(this.fhtml.nr.h+0)+"px",padding:"0px",margin:"0px",left:"0px",lineHeight:(this.fhtml.nr.h+0)+"px",position:"absolute"});_4.style(this.progNode,{width:this.fhtml.nr.w+"px",height:(this.fhtml.nr.h+0)+"px",padding:"0px",margin:"0px",left:"0px",position:"absolute",display:"none",backgroundImage:"url("+this.progressBackgroundUrl+")",backgroundPosition:"bottom",backgroundRepeat:"repeat-x",backgroundColor:this.progressBackgroundColor});}_4.style(this.insideNode,{position:"absolute",top:"0px",left:"0px",display:""});_4.addClass(this.domNode,this.srcNodeRef.className);if(this.fhtml.nr.d.indexOf("inline")>-1){_4.addClass(this.domNode,"dijitInline");}try{this.insideNode.innerHTML=this.fhtml.cn;}catch(e){console.warn("IE inline node",this.domNode.outerHTML);if(this.uploaderType=="flash"){this.insideNode=this.insideNode.parentNode.removeChild(this.insideNode);_4.body().appendChild(this.insideNode);this.insideNode.innerHTML=this.fhtml.cn;var c=_4.connect(this,"onReady",this,function(){_4.disconnect(c);this.insideNode=this.insideNode.parentNode.removeChild(this.insideNode);this.domNode.appendChild(this.insideNode);});}else{this.insideNode.appendChild(document.createTextNode(this.fhtml.cn));}}this.flashDiv=this.insideNode;},onChange:function(_30){},onProgress:function(_31){},onComplete:function(_32){},onCancel:function(){this.log("Upload Canceled");},onError:function(_33){var _34=_33.type?_33.type.toUpperCase():"ERROR";var msg=_33.msg?_33.msg:_33;console.error("FLASH/ERROR/"+_34,msg);},onReady:function(){},submit:function(_36){var _37=_36?_4.formToObject(_36):null;this.upload(_37);return false;},upload:function(_38){if(!this.fileList.length){return false;}if(!this.uploadUrl){console.warn("uploadUrl not provided. Aborting.");return false;}if(!this.showProgress){this.attr("disabled",true);}else{}if(this.progressWidgetId){var _39=_5.byId(this.progressWidgetId).domNode;console.warn("PROGRESS BAR",_39,_4.style(_39,"display"));if(_4.style(_39,"display")=="none"){this.restoreProgDisplay="none";_4.style(_39,"display","block");}if(_4.style(_39,"visibility")=="hidden"){this.restoreProgDisplay="hidden";_4.style(_39,"visibility","visible");}}if(_38){this.postData=_38;}this.log("upload type:",this.uploaderType," - postData:",this.postData);for(var i=0;i<this.fileList.length;i++){var f=this.fileList[i];f.bytesLoaded=0;f.bytesTotal=f.size||100000;f.percent=0;}if(this.uploaderType=="flash"){this.uploadFlash();}else{this.uploadHTML();}return false;},removeFile:function(_3c,_3d){var i;for(i=0;i<this.fileList.length;i++){if(this.fileList[i].name==_3c){if(!_3d){this.fileList.splice(i,1);}break;}}if(this.uploaderType=="flash"){this.flashMovie.removeFile(_3c);}else{if(!_3d){_4.destroy(this.fileInputs[i]);this.fileInputs.splice(i,1);}}if(this.fileListId){_4.destroy("file_"+_3c);}},destroyAll:function(){console.warn("DEPRECATED for 1.5 - use destroy() instead");this.destroy();},destroy:function(){if(this.uploaderType=="flash"&&!this.flashMovie){this._cons.push(_4.connect(this,"onLoad",this,"destroy"));return;}_4.forEach(this._subs,function(s){_4.unsubscribe(s);});_4.forEach(this._cons,function(c){_4.disconnect(c);});if(this.scrollConnect){_4.disconnect(this.scrollConnect);}if(this.uploaderType=="flash"){this.flashObject.destroy();_4.destroy(this.flashDiv);}this.inherited(arguments);},hide:function(){console.warn("DEPRECATED for 1.5 - use dojo.style(domNode, 'display', 'none' instead");_4.style(this.domNode,"display","none");},show:function(){console.warn("DEPRECATED for 1.5 - use dojo.style(domNode, 'display', '') instead");_4.style(this.domNode,"display","");},disable:function(_41){console.warn("DEPRECATED: FileUploader.disable() - will be removed in 1.5. Use attr('disable', true) instead.");this.attr("disable",_41);},_displayProgress:function(_42){if(_42===true){if(this.uploaderType=="flash"){_4.style(this.insideNode,"left","-1000px");}else{_4.style(this.insideNode,"display","none");}_4.style(this.progNode,"display","");}else{if(_42===false){_4.style(this.insideNode,"display","");_4.style(this.insideNode,"left","0px");_4.style(this.progNode,"display","none");}else{var w=_42*this.fhtml.nr.w;_4.style(this.progNode,{width:w+"px"});}}},_animateProgress:function(){this._displayProgress(true);var _44=false;var c=_4.connect(this,"_complete",function(){_4.disconnect(c);_44=true;});var w=0;var _47=setInterval(_4.hitch(this,function(){w+=5;if(w>this.fhtml.nr.w){w=0;_44=true;}this._displayProgress(w/this.fhtml.nr.w);if(_44){clearInterval(_47);setTimeout(_4.hitch(this,function(){this._displayProgress(false);}),500);}}),50);},_error:function(evt){this.onError(evt);},_addToFileList:function(){if(this.fileListId){var str="";_4.forEach(this.fileList,function(d){str+="<table id=\"file_"+d.name+"\" class=\"fileToUpload\"><tr><td class=\"fileToUploadClose\"></td><td class=\"fileToUploadName\">"+d.name+"</td><td class=\"fileToUploadSize\">"+Math.ceil(d.size*0.001)+"kb</td></tr></table>";},this);_4.byId(this.fileListId).innerHTML=str;}},_change:function(_4b){if(_4.isIE){_4.forEach(_4b,function(f){f.name=f.name.split("\\")[f.name.split("\\").length-1];});}if(this.selectMultipleFiles){this.fileList=this.fileList.concat(_4b);}else{if(this.fileList[0]){this.removeFile(this.fileList[0].name);}this.fileList=_4b;}this._addToFileList();this.onChange(_4b);if(this.uploadOnChange){this.upload();}else{if(this.uploaderType=="html"&&this.selectMultipleFiles){this._buildFileInput();this._connectInput();}}},_complete:function(_4d){_4d=_4.isArray(_4d)?_4d:[_4d];_4.forEach(_4d,function(f){if(f.ERROR){console.error(f.ERROR);this._error(new Error(f.ERROR));}},this);_4.forEach(this.fileList,function(f){f.bytesLoaded=1;f.bytesTotal=1;f.percent=100;this._progress(f);},this);_4.forEach(this.fileList,function(f){this.removeFile(f.name,true);},this);this.onComplete(_4d);this.fileList=[];this._resetHTML();this.attr("disabled",false);if(this.restoreProgDisplay){setTimeout(_4.hitch(this,function(){_4.style(_5.byId(this.progressWidgetId).domNode,this.restoreProgDisplay=="none"?"display":"visibility",this.restoreProgDisplay);}),700);}},_progress:function(_51){var _52=0;var _53=0;for(var i=0;i<this.fileList.length;i++){var f=this.fileList[i];if(f.name==_51.name){f.bytesLoaded=_51.bytesLoaded;f.bytesTotal=_51.bytesTotal;f.percent=Math.ceil(f.bytesLoaded/f.bytesTotal*100);console.info(f.name,"percent:",f.percent);}_53+=Math.ceil(0.001*f.bytesLoaded);_52+=Math.ceil(0.001*f.bytesTotal);}var _56=Math.ceil(_53/_52*100);if(this.progressWidgetId){_5.byId(this.progressWidgetId).update({progress:_56+"%"});}if(this.showProgress){this._displayProgress(_56*0.01);}this.onProgress(this.fileList);},_getDisabledAttr:function(){return this._disabled;},_setDisabledAttr:function(_57){if(this._disabled==_57){return;}if(this.uploaderType=="flash"){if(!this.flashReady){var _fc=_4.connect(this,"onReady",this,function(){_4.disconnect(_fc);this._setDisabledAttr(_57);});return;}this._disabled=_57;this.flashMovie.doDisable(_57);if(_57){_4.addClass(this.domNode,this.disabledClass);}else{_4.removeClass(this.domNode,this.disabledClass);}}else{this._disabled=_57;if(_57){_4.addClass(this.domNode,this.disabledClass);_4.style(this._fileInput,"display","none");}else{_4.removeClass(this.domNode,this.disabledClass);_4.style(this._fileInput,"display","");}}},_onFlashBlur:function(){this.flashMovie.blur();if(!this.nextFocusObject&&this.tabIndex){var _59=_4.query("[tabIndex]");for(var i=0;i<_59.length;i++){if(_59[i].tabIndex>=Number(this.tabIndex)+1){this.nextFocusObject=_59[i];break;}}}this.nextFocusObject.focus();},_disconnect:function(){_4.forEach(this._cons,function(c){_4.disconnect(c);});},uploadHTML:function(){_4.destroy(this._fileInput);this._setHtmlPostData();if(this.showProgress){this._animateProgress();}_4.io.iframe.send({url:this.uploadUrl,form:this._formNode,handleAs:"json",handle:_4.hitch(this,function(_5c,_5d,_5e){this._complete(_5c);})});},createHtmlUploader:function(){this._buildForm();this._setFormStyle();this._buildFileInput();this._connectInput();this._styleContent();this.onReady();},_connectInput:function(){this._disconnect();this._cons.push(_4.connect(this._fileInput,"mouseover",this,function(evt){_4.addClass(this.domNode,this.hoverClass);this.onMouseOver(evt);}));this._cons.push(_4.connect(this._fileInput,"mouseout",this,function(evt){_4.removeClass(this.domNode,this.activeClass);_4.removeClass(this.domNode,this.hoverClass);this.onMouseOut(evt);this._checkHtmlCancel("off");}));this._cons.push(_4.connect(this._fileInput,"mousedown",this,function(evt){_4.addClass(this.domNode,this.activeClass);_4.removeClass(this.domNode,this.hoverClass);this.onMouseDown(evt);}));this._cons.push(_4.connect(this._fileInput,"mouseup",this,function(evt){_4.removeClass(this.domNode,this.activeClass);this.onMouseUp(evt);this.onClick(evt);this._checkHtmlCancel("up");}));this._cons.push(_4.connect(this._fileInput,"change",this,function(){this.log("html change");this._checkHtmlCancel("change");this._change([{name:this._fileInput.value,type:"",size:0}]);}));if(this.tabIndex>=0){_4.attr(this.domNode,"tabIndex",this.tabIndex);}},_checkHtmlCancel:function(_63){if(_63=="change"){this.dialogIsOpen=false;}if(_63=="up"){this.dialogIsOpen=true;}if(_63=="off"){if(this.dialogIsOpen){this.onCancel();}this.dialogIsOpen=false;}},_styleContent:function(){var o=this.fhtml.nr;_4.style(this.insideNode,{width:o.w+"px",height:o.va=="middle"?o.h+"px":"auto",lineHeight:o.va=="middle"?o.h+"px":"auto",textAlign:o.ta,paddingTop:o.p[0]+"px",paddingRight:o.p[1]+"px",paddingBottom:o.p[2]+"px",paddingLeft:o.p[3]+"px"});},_resetHTML:function(){if(this.uploaderType=="html"&&this._formNode){_4.query("*",this._formNode).forEach(function(n){_4.destroy(n);});this.fileCount=0;this._buildFileInput();this._connectInput();}},_buildForm:function(){if(this._formNode){return;}if(_4.isIE){this._formNode=document.createElement("<form enctype=\"multipart/form-data\" method=\"post\">");this._formNode.encoding="multipart/form-data";}else{this._formNode=document.createElement("form");this._formNode.setAttribute("enctype","multipart/form-data");}this._formNode.id=_5.getUniqueId("FileUploaderForm");this.domNode.appendChild(this._formNode);},_buildFileInput:function(){if(this._fileInput){this._disconnect();this._fileInput.id=this._fileInput.id+this.fileCount;_4.style(this._fileInput,"display","none");}this._fileInput=document.createElement("input");this.fileInputs.push(this._fileInput);var nm=this.htmlFieldName;var _id=this.id;if(this.selectMultipleFiles){nm+=this.fileCount;_id+=this.fileCount;this.fileCount++;}_4.attr(this._fileInput,{id:this.id,name:nm,type:"file"});_4.addClass(this._fileInput,"dijitFileInputReal");this._formNode.appendChild(this._fileInput);var _68=_4.marginBox(this._fileInput);_4.style(this._fileInput,{position:"relative",left:(this.fhtml.nr.w-_68.w)+"px",opacity:0});},_setFormStyle:function(){var _69=Math.max(2,Math.max(Math.ceil(this.fhtml.nr.w/60),Math.ceil(this.fhtml.nr.h/15)));_6.html.insertCssRule("#"+this._formNode.id+" input","font-size:"+_69+"em");_4.style(this.domNode,{overflow:"hidden",position:"relative"});_4.style(this.insideNode,"position","absolute");},_setHtmlPostData:function(){if(this.postData){for(var nm in this.postData){var f=document.createElement("input");_4.attr(f,"type","hidden");_4.attr(f,"name",nm);_4.attr(f,"value",this.postData[nm]);this._formNode.appendChild(f);}}},uploadFlash:function(){try{if(this.showProgress){this._displayProgress(true);var c=_4.connect(this,"_complete",this,function(){_4.disconnect(c);this._displayProgress(false);});}this.flashMovie.doUpload(this.postData);}catch(err){throw new Error("Sorry, the SWF failed to initialize."+err);}},createFlashUploader:function(){this.uploadUrl=this.uploadUrl.toString();if(this.uploadUrl){if(this.uploadUrl.toLowerCase().indexOf("http")<0&&this.uploadUrl.indexOf("/")!=0){var loc=window.location.href.split("/");loc.pop();loc=loc.join("/")+"/";this.uploadUrl=loc+this.uploadUrl;this.log("SWF Fixed - Relative loc:",loc," abs loc:",this.uploadUrl);}}else{}var w=this.fhtml.nr.w;var h=this.fhtml.nr.h;var _70={expressInstall:true,path:this.swfPath.uri||this.swfPath,width:w,height:h,allowScriptAccess:"always",allowNetworking:"all",vars:{uploadDataFieldName:this.flashFieldName,uploadUrl:this.uploadUrl,uploadOnSelect:this.uploadOnChange,deferredUploading:this.deferredUploading,selectMultipleFiles:this.selectMultipleFiles,id:this.id,isDebug:this.isDebug,devMode:this.devMode,flashButton:_6.embed.flashVars.serialize("fh",this.fhtml),fileMask:_6.embed.flashVars.serialize("fm",this.fileMask)},params:{scale:"noscale"}};this.flashObject=new _6.embed.Flash(_70,this.insideNode);console.log("start flash...");this.flashObject.onError=function(msg){console.warn("Flash Error:",msg);};this.flashObject.onReady=_4.hitch(this,function(){});this.flashObject.onLoad=_4.hitch(this,function(mov){this.flashMovie=mov;this.flashReady=true;this.onReady();});this._connectFlash();},_connectFlash:function(){this._doSub("/filesSelected","_change");this._doSub("/filesUploaded","_complete");this._doSub("/filesProgress","_progress");this._doSub("/filesError","_error");this._doSub("/filesCanceled","onCancel");this._doSub("/stageBlur","_onFlashBlur");this._doSub("/up","onMouseUp");this._doSub("/down","onMouseDown");this._doSub("/over","onMouseOver");this._doSub("/out","onMouseOut");this.connect(this.domNode,"focus",function(){this.flashMovie.focus();this.flashMovie.doFocus();_4.connect(document,"keydown",function(evt){console.log(evt.keyCode);});});if(this.tabIndex>=0){_4.attr(this.domNode,"tabIndex",this.tabIndex);}},_doSub:function(_74,_75){this._subs.push(_4.subscribe(this.id+_74,this,_75));}});})();}}};});