/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.xmpp.xmppSession"],["require","dojox.xmpp.TransportSession"],["require","dojox.xmpp.RosterService"],["require","dojox.xmpp.PresenceService"],["require","dojox.xmpp.UserService"],["require","dojox.xmpp.ChatService"],["require","dojox.xmpp.sasl"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.xmpp.xmppSession"]){_4._hasResource["dojox.xmpp.xmppSession"]=true;_4.provide("dojox.xmpp.xmppSession");_4.require("dojox.xmpp.TransportSession");_4.require("dojox.xmpp.RosterService");_4.require("dojox.xmpp.PresenceService");_4.require("dojox.xmpp.UserService");_4.require("dojox.xmpp.ChatService");_4.require("dojox.xmpp.sasl");_6.xmpp.xmpp={STREAM_NS:"http://etherx.jabber.org/streams",CLIENT_NS:"jabber:client",STANZA_NS:"urn:ietf:params:xml:ns:xmpp-stanzas",SASL_NS:"urn:ietf:params:xml:ns:xmpp-sasl",BIND_NS:"urn:ietf:params:xml:ns:xmpp-bind",BODY_NS:"http://jabber.org/protocol/httpbind",XHTML_BODY_NS:"http://www.w3.org/1999/xhtml",XHTML_IM_NS:"http://jabber.org/protocol/xhtml-im",INACTIVE:"Inactive",CONNECTED:"Connected",ACTIVE:"Active",TERMINATE:"Terminate",LOGIN_FAILURE:"LoginFailure",INVALID_ID:-1,NO_ID:0,error:{BAD_REQUEST:"bad-request",CONFLICT:"conflict",FEATURE_NOT_IMPLEMENTED:"feature-not-implemented",FORBIDDEN:"forbidden",GONE:"gone",INTERNAL_SERVER_ERROR:"internal-server-error",ITEM_NOT_FOUND:"item-not-found",ID_MALFORMED:"jid-malformed",NOT_ACCEPTABLE:"not-acceptable",NOT_ALLOWED:"not-allowed",NOT_AUTHORIZED:"not-authorized",SERVICE_UNAVAILABLE:"service-unavailable",SUBSCRIPTION_REQUIRED:"subscription-required",UNEXPECTED_REQUEST:"unexpected-request"}};_6.xmpp.xmppSession=function(_7){if(_7&&_4.isObject(_7)){_4.mixin(this,_7);}this.session=new _6.xmpp.TransportSession(_7);_4.connect(this.session,"onReady",this,"onTransportReady");_4.connect(this.session,"onTerminate",this,"onTransportTerminate");_4.connect(this.session,"onProcessProtocolResponse",this,"processProtocolResponse");};_4.extend(_6.xmpp.xmppSession,{roster:[],chatRegister:[],_iqId:Math.round(Math.random()*1000000000),open:function(_8,_9,_a){if(!_8){throw new Error("User id cannot be null");}else{this.jid=_8;if(_8.indexOf("@")==-1){this.jid=this.jid+"@"+this.domain;}}if(_9){this.password=_9;}if(_a){this.resource=_a;}this.session.open();},close:function(){this.state=_6.xmpp.xmpp.TERMINATE;this.session.close(_6.xmpp.util.createElement("presence",{type:"unavailable",xmlns:_6.xmpp.xmpp.CLIENT_NS},true));},processProtocolResponse:function(_b){var _c=_b.nodeName;var _d=_c.indexOf(":");if(_d>0){_c=_c.substring(_d+1);}switch(_c){case "iq":case "presence":case "message":case "features":this[_c+"Handler"](_b);break;default:if(_b.getAttribute("xmlns")==_6.xmpp.xmpp.SASL_NS){this.saslHandler(_b);}}},messageHandler:function(_e){switch(_e.getAttribute("type")){case "chat":this.chatHandler(_e);break;case "normal":default:this.simpleMessageHandler(_e);}},iqHandler:function(_f){if(_f.getAttribute("type")=="set"){this.iqSetHandler(_f);return;}else{if(_f.getAttribute("type")=="get"){return;}}},presenceHandler:function(msg){switch(msg.getAttribute("type")){case "subscribe":this.presenceSubscriptionRequest(msg.getAttribute("from"));break;case "subscribed":case "unsubscribed":break;case "error":this.processXmppError(msg);break;default:this.presenceUpdate(msg);break;}},featuresHandler:function(msg){var _12=[];var _13=false;if(msg.hasChildNodes()){for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];switch(n.nodeName){case "mechanisms":for(var x=0;x<n.childNodes.length;x++){_12.push(n.childNodes[x].firstChild.nodeValue);}break;case "bind":_13=true;break;}}}if(this.state==_6.xmpp.xmpp.CONNECTED&&_13){for(var i=0;i<_12.length;i++){if(_12[i]=="SUN-COMMS-CLIENT-PROXY-AUTH"){_6.xmpp.sasl.SunWebClientAuth(this);break;}else{if(_12[i]=="PLAIN"){_6.xmpp.sasl.SaslPlain(this);break;}else{console.error("No suitable auth mechanism found for: ",_12[i]);}}}delete this.password;}},saslHandler:function(msg){if(msg.nodeName=="success"){this.bindResource();return;}if(msg.hasChildNodes()){this.onLoginFailure(msg.firstChild.nodeName);}},chatHandler:function(msg){var _19={from:msg.getAttribute("from"),to:msg.getAttribute("to")};var _1a=null;for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];if(n.hasChildNodes()){switch(n.nodeName){case "thread":_19.chatid=n.firstChild.nodeValue;break;case "body":if(!n.getAttribute("xmlns")||(n.getAttribute("xmlns")=="")){_19.body=n.firstChild.nodeValue;}break;case "subject":_19.subject=n.firstChild.nodeValue;case "html":if(n.getAttribute("xmlns")==_6.xmpp.xmpp.XHTML_IM_NS){_19.xhtml=n.getElementsByTagName("body")[0];}break;case "x":break;default:}}}var _1d=-1;if(_19.chatid){for(var i=0;i<this.chatRegister.length;i++){var ci=this.chatRegister[i];if(ci&&ci.chatid==_19.chatid){_1d=i;break;}}}else{for(var i=0;i<this.chatRegister.length;i++){var ci=this.chatRegister[i];if(ci){if(ci.uid==this.getBareJid(_19.from)){_1d=i;}}}}if(_1d>-1&&_1a){var _1f=this.chatRegister[_1d];_1f.setState(_1a);if(_1f.firstMessage){if(_1a==_6.xmpp.chat.ACTIVE_STATE){_1f.useChatState=(_1a!=null)?true:false;_1f.firstMessage=false;}}}if((!_19.body||_19.body=="")&&!_19.xhtml){return;}if(_1d>-1){var _1f=this.chatRegister[_1d];_1f.recieveMessage(_19);}else{var _20=new _6.xmpp.ChatService();_20.uid=this.getBareJid(_19.from);_20.chatid=_19.chatid;_20.firstMessage=true;if(!_1a||_1a!=_6.xmpp.chat.ACTIVE_STATE){this.useChatState=false;}this.registerChatInstance(_20,_19);}},simpleMessageHandler:function(msg){},registerChatInstance:function(_22,_23){_22.setSession(this);this.chatRegister.push(_22);this.onRegisterChatInstance(_22,_23);_22.recieveMessage(_23,true);},iqSetHandler:function(msg){if(msg.hasChildNodes()){var fn=msg.firstChild;switch(fn.nodeName){case "query":if(fn.getAttribute("xmlns")=="jabber:iq:roster"){this.rosterSetHandler(fn);this.sendIqResult(msg.getAttribute("id"),msg.getAttribute("from"));}break;default:break;}}},sendIqResult:function(_26,to){var req={id:_26,to:to||this.domain,type:"result",from:this.jid+"/"+this.resource};this.dispatchPacket(_6.xmpp.util.createElement("iq",req,true));},rosterSetHandler:function(_29){for(var i=0;i<_29.childNodes.length;i++){var n=_29.childNodes[i];if(n.nodeName=="item"){var _2c=false;var _2d=-1;var _2e=null;var _2f=null;for(var x=0;x<this.roster.length;x++){var r=this.roster[x];if(n.getAttribute("jid")==r.jid){_2c=true;if(n.getAttribute("subscription")=="remove"){_2e={id:r.jid,name:r.name,groups:[]};for(var y=0;y<r.groups.length;y++){_2e.groups.push(r.groups[y]);}this.roster.splice(x,1);_2d=_6.xmpp.roster.REMOVED;}else{_2f=_4.clone(r);var _33=n.getAttribute("name");if(_33){this.roster[x].name=_33;}r.groups=[];if(n.getAttribute("subscription")){r.status=n.getAttribute("subscription");}r.substatus=_6.xmpp.presence.SUBSCRIPTION_SUBSTATUS_NONE;if(n.getAttribute("ask")=="subscribe"){r.substatus=_6.xmpp.presence.SUBSCRIPTION_REQUEST_PENDING;}for(var y=0;y<n.childNodes.length;y++){var _34=n.childNodes[y];if((_34.nodeName=="group")&&(_34.hasChildNodes())){var _35=_34.firstChild.nodeValue;r.groups.push(_35);}}_2e=r;_2d=_6.xmpp.roster.CHANGED;}break;}}if(!_2c&&(n.getAttribute("subscription")!="remove")){r=this.createRosterEntry(n);_2e=r;_2d=_6.xmpp.roster.ADDED;}switch(_2d){case _6.xmpp.roster.ADDED:this.onRosterAdded(_2e);break;case _6.xmpp.roster.REMOVED:this.onRosterRemoved(_2e);break;case _6.xmpp.roster.CHANGED:this.onRosterChanged(_2e,_2f);break;}}}},presenceUpdate:function(msg){if(msg.getAttribute("to")){var jid=this.getBareJid(msg.getAttribute("to"));if(jid!=this.jid){return;}}var _38=this.getResourceFromJid(msg.getAttribute("from"));if(!_38){return;}var p={from:this.getBareJid(msg.getAttribute("from")),resource:_38,show:_6.xmpp.presence.STATUS_ONLINE,priority:5,hasAvatar:false};if(msg.getAttribute("type")=="unavailable"){p.show=_6.xmpp.presence.STATUS_OFFLINE;}for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];if(n.hasChildNodes()){switch(n.nodeName){case "status":case "show":p[n.nodeName]=n.firstChild.nodeValue;break;case "status":p.priority=parseInt(n.firstChild.nodeValue);break;case "x":if(n.firstChild&&n.firstChild.firstChild&&n.firstChild.firstChild.nodeValue!=""){p.avatarHash=n.firstChild.firstChild.nodeValue;p.hasAvatar=true;}break;}}}this.onPresenceUpdate(p);},retrieveRoster:function(){var _3c={id:this.getNextIqId(),from:this.jid+"/"+this.resource,type:"get"};var req=new _6.string.Builder(_6.xmpp.util.createElement("iq",_3c,false));req.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:roster"},true));req.append("</iq>");var def=this.dispatchPacket(req,"iq",_3c.id);def.addCallback(this,"onRetrieveRoster");},getRosterIndex:function(jid){if(jid.indexOf("@")==-1){jid+="@"+this.domain;}for(var i=0;i<this.roster.length;i++){if(jid==this.roster[i].jid){return i;}}return -1;},createRosterEntry:function(_41){var re={name:_41.getAttribute("name"),jid:_41.getAttribute("jid"),groups:[],status:_6.xmpp.presence.SUBSCRIPTION_NONE,substatus:_6.xmpp.presence.SUBSCRIPTION_SUBSTATUS_NONE};if(!re.name){re.name=re.id;}for(var i=0;i<_41.childNodes.length;i++){var n=_41.childNodes[i];if(n.nodeName=="group"&&n.hasChildNodes()){re.groups.push(n.firstChild.nodeValue);}}if(_41.getAttribute("subscription")){re.status=_41.getAttribute("subscription");}if(_41.getAttribute("ask")=="subscribe"){re.substatus=_6.xmpp.presence.SUBSCRIPTION_REQUEST_PENDING;}return re;},bindResource:function(){var _45={xmlns:"jabber:client",id:this.getNextIqId(),type:"set"};var _46=new _6.string.Builder(_6.xmpp.util.createElement("iq",_45,false));_46.append(_6.xmpp.util.createElement("bind",{xmlns:_6.xmpp.xmpp.BIND_NS},false));if(this.resource){_46.append(_6.xmpp.util.createElement("resource"));_46.append(this.resource);_46.append("</resource>");}_46.append("</bind></iq>");var def=this.dispatchPacket(_46,"iq",_45.id);def.addCallback(this,"onBindResource");},getNextIqId:function(){return "im_"+this._iqId++;},presenceSubscriptionRequest:function(msg){this.onSubscriptionRequest(msg);},dispatchPacket:function(msg,_4a,_4b){if(this.state!="Terminate"){return this.session.dispatchPacket(msg,_4a,_4b);}else{}},setState:function(_4c,_4d){if(this.state!=_4c){if(this["on"+_4c]){this["on"+_4c](_4c,this.state,_4d);}this.state=_4c;}},search:function(_4e,_4f,_50){var req={id:this.getNextIqId(),"xml:lang":this.lang,type:"set",from:this.jid+"/"+this.resource,to:_4f};var _52=new _6.string.Builder(_6.xmpp.util.createElement("iq",req,false));_52.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:search"},false));_52.append(_6.xmpp.util.createElement(_50,{},false));_52.append(_4e);_52.append("</").append(_50).append(">");_52.append("</query></iq>");var def=this.dispatchPacket(_52.toString,"iq",req.id);def.addCallback(this,"_onSearchResults");},_onSearchResults:function(msg){if((msg.getAttribute("type")=="result")&&(msg.hasChildNodes())){this.onSearchResults([]);}},onLogin:function(){this.retrieveRoster();},onLoginFailure:function(msg){},onBindResource:function(msg){if(msg.getAttribute("type")=="result"){if((msg.hasChildNodes())&&(msg.firstChild.nodeName=="bind")){var _57=msg.firstChild;if((_57.hasChildNodes())&&(_57.firstChild.nodeName=="jid")){if(_57.firstChild.hasChildNodes()){var _58=_57.firstChild.firstChild.nodeValue;this.jid=this.getBareJid(_58);this.resource=this.getResourceFromJid(_58);}}}else{}this.onLogin();}else{if(msg.getAttribute("type")=="error"){var err=this.processXmppError(msg);this.onLoginFailure(err);}}return msg;},onSearchResults:function(_5a){},onRetrieveRoster:function(msg){if((msg.getAttribute("type")=="result")&&msg.hasChildNodes()){var _5c=msg.getElementsByTagName("query")[0];if(_5c.getAttribute("xmlns")=="jabber:iq:roster"){for(var i=0;i<_5c.childNodes.length;i++){if(_5c.childNodes[i].nodeName=="item"){this.roster[i]=this.createRosterEntry(_5c.childNodes[i]);}}}}else{if(msg.getAttribute("type")=="error"){}}this.setState(_6.xmpp.xmpp.ACTIVE);this.onRosterUpdated();return msg;},onRosterUpdated:function(){},onSubscriptionRequest:function(req){},onPresenceUpdate:function(p){},onTransportReady:function(){this.setState(_6.xmpp.xmpp.CONNECTED);this.rosterService=new _6.xmpp.RosterService(this);this.presenceService=new _6.xmpp.PresenceService(this);this.userService=new _6.xmpp.UserService(this);},onTransportTerminate:function(_60,_61,_62){this.setState(_6.xmpp.xmpp.TERMINATE,_62);},onConnected:function(){},onTerminate:function(_63,_64,_65){},onActive:function(){},onRegisterChatInstance:function(_66,_67){},onRosterAdded:function(ri){},onRosterRemoved:function(ri){},onRosterChanged:function(ri,_6b){},processXmppError:function(msg){var err={stanzaType:msg.nodeName,id:msg.getAttribute("id")};for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];switch(n.nodeName){case "error":err.errorType=n.getAttribute("type");for(var x=0;x<n.childNodes.length;x++){var cn=n.childNodes[x];if((cn.nodeName=="text")&&(cn.getAttribute("xmlns")==_6.xmpp.xmpp.STANZA_NS)&&cn.hasChildNodes()){err.message=cn.firstChild.nodeValue;}else{if((cn.getAttribute("xmlns")==_6.xmpp.xmpp.STANZA_NS)&&(!cn.hasChildNodes())){err.condition=cn.nodeName;}}}break;default:break;}}return err;},sendStanzaError:function(_72,to,id,_75,_76,_77){var req={type:"error"};if(to){req.to=to;}if(id){req.id=id;}var _79=new _6.string.Builder(_6.xmpp.util.createElement(_72,req,false));_79.append(_6.xmpp.util.createElement("error",{type:_75},false));_79.append(_6.xmpp.util.createElement("condition",{xmlns:_6.xmpp.xmpp.STANZA_NS},true));if(_77){var _7a={xmlns:_6.xmpp.xmpp.STANZA_NS,"xml:lang":this.lang};_79.append(_6.xmpp.util.createElement("text",_7a,false));_79.append(_77).append("</text>");}_79.append("</error></").append(_72).append(">");this.dispatchPacket(_79.toString());},getBareJid:function(jid){var i=jid.indexOf("/");if(i!=-1){return jid.substring(0,i);}return jid;},getResourceFromJid:function(jid){var i=jid.indexOf("/");if(i!=-1){return jid.substring((i+1),jid.length);}return "";}});}}};});