/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.jsonPathStore"],["require","dojox.jsonPath"],["require","dojo.date"],["require","dojo.date.locale"],["require","dojo.date.stamp"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.jsonPathStore"]){_4._hasResource["dojox.data.jsonPathStore"]=true;_4.provide("dojox.data.jsonPathStore");_4.require("dojox.jsonPath");_4.require("dojo.date");_4.require("dojo.date.locale");_4.require("dojo.date.stamp");_6.data.ASYNC_MODE=0;_6.data.SYNC_MODE=1;_4.declare("dojox.data.jsonPathStore",null,{mode:_6.data.ASYNC_MODE,metaLabel:"_meta",hideMetaAttributes:false,autoIdPrefix:"_auto_",autoIdentity:true,idAttribute:"_id",indexOnLoad:true,labelAttribute:"",url:"",_replaceRegex:/\'\]/gi,noRevert:false,constructor:function(_7){this.byId=this.fetchItemByIdentity;if(_7){_4.mixin(this,_7);}this._dirtyItems=[];this._autoId=0;this._referenceId=0;this._references={};this._fetchQueue=[];this.index={};var _8="("+this.metaLabel+"'])";this.metaRegex=new RegExp(_8);if(!this.data&&!this.url){this.setData({});}if(this.data&&!this.url){this.setData(this.data);delete this.data;}if(this.url){_4.xhrGet({url:_7.url,handleAs:"json",load:_4.hitch(this,"setData"),sync:this.mode});}},_loadData:function(_9){if(this._data){delete this._data;}if(_4.isString(_9)){this._data=_4.fromJson(_9);}else{this._data=_9;}if(this.indexOnLoad){this.buildIndex();}this._updateMeta(this._data,{path:"$"});this.onLoadData(this._data);},onLoadData:function(_a){while(this._fetchQueue.length>0){var _b=this._fetchQueue.shift();this.fetch(_b);}},setData:function(_c){this._loadData(_c);},buildIndex:function(_d,_e){if(!this.idAttribute){throw new Error("buildIndex requires idAttribute for the store");}_e=_e||this._data;var _f=_d;_d=_d||"$";_d+="[*]";var _10=this.fetch({query:_d,mode:_6.data.SYNC_MODE});for(var i=0;i<_10.length;i++){var _12,_13;if(_4.isObject(_10[i])){var _14=_10[i][this.metaLabel]["path"];if(_f){_12=_f.split("['");_13=_12[_12.length-1].replace(this._replaceRegex,"");if(!_4.isArray(_10[i])){this._addReference(_10[i],{parent:_e,attribute:_13});this.buildIndex(_14,_10[i]);}else{this.buildIndex(_14,_e);}}else{_12=_14.split("['");_13=_12[_12.length-1].replace(this._replaceRegex,"");this._addReference(_10[i],{parent:this._data,attribute:_13});this.buildIndex(_14,_10[i]);}}}},_correctReference:function(_15){if(this.index[_15[this.idAttribute]]&&(this.index[_15[this.idAttribute]][this.metaLabel]===_15[this.metaLabel])){return this.index[_15[this.idAttribute]];}return _15;},getValue:function(_16,_17){_16=this._correctReference(_16);return _16[_17];},getValues:function(_18,_19){_18=this._correctReference(_18);return _4.isArray(_18[_19])?_18[_19]:[_18[_19]];},getAttributes:function(_1a){_1a=this._correctReference(_1a);var res=[];for(var i in _1a){if(this.hideMetaAttributes&&(i==this.metaLabel)){continue;}res.push(i);}return res;},hasAttribute:function(_1d,_1e){_1d=this._correctReference(_1d);if(_1e in _1d){return true;}return false;},containsValue:function(_1f,_20,_21){_1f=this._correctReference(_1f);if(_1f[_20]&&_1f[_20]==_21){return true;}if(_4.isObject(_1f[_20])||_4.isObject(_21)){if(this._shallowCompare(_1f[_20],_21)){return true;}}return false;},_shallowCompare:function(a,b){if((_4.isObject(a)&&!_4.isObject(b))||(_4.isObject(b)&&!_4.isObject(a))){return false;}if(a["getFullYear"]||b["getFullYear"]){if((a["getFullYear"]&&!b["getFullYear"])||(b["getFullYear"]&&!a["getFullYear"])){return false;}else{if(!_4.date.compare(a,b)){return true;}return false;}}for(var i in b){if(_4.isObject(b[i])){if(!a[i]||!_4.isObject(a[i])){return false;}if(b[i]["getFullYear"]){if(!a[i]["getFullYear"]){return false;}if(_4.date.compare(a,b)){return false;}}else{if(!this._shallowCompare(a[i],b[i])){return false;}}}else{if(!b[i]||(a[i]!=b[i])){return false;}}}for(i in a){if(!b[i]){return false;}}return true;},isItem:function(_25){if(!_4.isObject(_25)||!_25[this.metaLabel]){return false;}if(this.requireId&&this._hasId&&!_25[this._id]){return false;}return true;},isItemLoaded:function(_26){_26=this._correctReference(_26);return this.isItem(_26);},loadItem:function(_27){return true;},_updateMeta:function(_28,_29){if(_28&&_28[this.metaLabel]){_4.mixin(_28[this.metaLabel],_29);return;}_28[this.metaLabel]=_29;},cleanMeta:function(_2a,_2b){_2a=_2a||this._data;if(_2a[this.metaLabel]){if(_2a[this.metaLabel].autoId){delete _2a[this.idAttribute];}delete _2a[this.metaLabel];}if(_4.isArray(_2a)){for(var i=0;i<_2a.length;i++){if(_4.isObject(_2a[i])||_4.isArray(_2a[i])){this.cleanMeta(_2a[i]);}}}else{if(_4.isObject(_2a)){for(i in _2a){if(_4.isObject(_2a[i])){this.cleanMeta(_2a[i]);}}}}},fetch:function(_2d){if(!this._data){this._fetchQueue.push(_2d);return _2d;}if(_4.isString(_2d)){_2e=_2d;_2d={query:_2e,mode:_6.data.SYNC_MODE};}var _2e;if(!_2d||!_2d.query){if(!_2d){var _2d={};}if(!_2d.query){_2d.query="$..*";_2e=_2d.query;}}if(_4.isObject(_2d.query)){if(_2d.query.query){_2e=_2d.query.query;}else{_2e=_2d.query="$..*";}if(_2d.query.queryOptions){_2d.queryOptions=_2d.query.queryOptions;}}else{_2e=_2d.query;}if(!_2d.mode){_2d.mode=this.mode;}if(!_2d.queryOptions){_2d.queryOptions={};}_2d.queryOptions.resultType="BOTH";var _2f=_6.jsonPath.query(this._data,_2e,_2d.queryOptions);var tmp=[];var _31=0;for(var i=0;i<_2f.length;i++){if(_2d.start&&i<_2d.start){continue;}if(_2d.count&&(_31>=_2d.count)){continue;}var _33=_2f[i]["value"];var _34=_2f[i]["path"];if(!_4.isObject(_33)){continue;}if(this.metaRegex.exec(_34)){continue;}this._updateMeta(_33,{path:_2f[i].path});if(this.autoIdentity&&!_33[this.idAttribute]){var _35=this.autoIdPrefix+this._autoId++;_33[this.idAttribute]=_35;_33[this.metaLabel].autoId=true;}if(_33[this.idAttribute]){this.index[_33[this.idAttribute]]=_33;}_31++;tmp.push(_33);}_2f=tmp;var _36=_2d.scope||_4.global;if("sort" in _2d){console.log("TODO::add support for sorting in the fetch");}if(_2d.mode==_6.data.SYNC_MODE){return _2f;}if(_2d.onBegin){_2d["onBegin"].call(_36,_2f.length,_2d);}if(_2d.onItem){for(var i=0;i<_2f.length;i++){_2d["onItem"].call(_36,_2f[i],_2d);}}if(_2d.onComplete){_2d["onComplete"].call(_36,_2f,_2d);}return _2d;},dump:function(_37){var _37=_37||{};var d=_37.data||this._data;if(!_37.suppressExportMeta&&_37.clone){_39=_4.clone(d);if(_39[this.metaLabel]){_39[this.metaLabel]["clone"]=true;}}else{var _39=d;}if(!_37.suppressExportMeta&&_39[this.metaLabel]){_39[this.metaLabel]["last_export"]=new Date().toString();}if(_37.cleanMeta){this.cleanMeta(_39);}switch(_37.type){case "raw":return _39;case "json":default:return _4.toJson(_39,_37.pretty||false);}},getFeatures:function(){return {"dojo.data.api.Read":true,"dojo.data.api.Identity":true,"dojo.data.api.Write":true,"dojo.data.api.Notification":true};},getLabel:function(_3a){_3a=this._correctReference(_3a);var _3b="";if(_4.isFunction(this.createLabel)){return this.createLabel(_3a);}if(this.labelAttribute){if(_4.isArray(this.labelAttribute)){for(var i=0;i<this.labelAttribute.length;i++){if(i>0){_3b+=" ";}_3b+=_3a[this.labelAttribute[i]];}return _3b;}else{return _3a[this.labelAttribute];}}return _3a.toString();},getLabelAttributes:function(_3d){_3d=this._correctReference(_3d);return _4.isArray(this.labelAttribute)?this.labelAttribute:[this.labelAttribute];},sort:function(a,b){console.log("TODO::implement default sort algo");},getIdentity:function(_40){if(this.isItem(_40)){return _40[this.idAttribute];}throw new Error("Id not found for item");},getIdentityAttributes:function(_41){return [this.idAttribute];},fetchItemByIdentity:function(_42){var id;if(_4.isString(_42)){id=_42;_42={identity:id,mode:_6.data.SYNC_MODE};}else{if(_42){id=_42["identity"];}if(!_42.mode){_42.mode=this.mode;}}if(this.index&&(this.index[id]||this.index["identity"])){if(_42.mode==_6.data.SYNC_MODE){return this.index[id];}if(_42.onItem){_42["onItem"].call(_42.scope||_4.global,this.index[id],_42);}return _42;}else{if(_42.mode==_6.data.SYNC_MODE){return false;}}if(_42.onError){_42["onItem"].call(_42.scope||_4.global,new Error("Item Not Found: "+id),_42);}return _42;},_makeItAnItem:function(_44,_45){var _46={};if(this.idAttribute&&!_44[this.idAttribute]){if(this.requireId){throw new Error("requireId is enabled, new items must have an id defined to be added");}if(this.autoIdentity){var _47=this.autoIdPrefix+this._autoId++;_44[this.idAttribute]=_47;_46.autoId=true;}}if(!_45&&!_45.attribute&&!this.idAttribute&&!_44[this.idAttribute]){throw new Error("Adding a new item requires, at a minimum, either the pInfo information, including the pInfo.attribute, or an id on the item in the field identified by idAttribute");}if(!_45.attribute){_45.attribute=_44[this.idAttribute];}if(_44[this.idAttribute]){this.index[_44[this.idAttribute]]=_44;}this._updateMeta(_44,_46);this._addReference(_44,{parent:_45.item,attribute:_45.attribute});this._setDirty(_44);if(_44[_45.attribute]&&_4.isArray(_44[_45.attribute])){for(var i=0;i<_44[_45.attribute].length;i++){this._makeItAnItem(_44[_45.attribute][i],{item:_44,attribute:_45.attribute});}}return _44;},newItem:function(_49,_4a){var _4b={item:this._data};if(_4a){if(_4a.parent){_4a.item=_4a.parent;}_4.mixin(_4b,_4a);}this._makeItAnItem(_49,_4b);_4b.oldValue=this._trimItem(_4b.item[_4b.attribute]);this._setDirty(_4b.item);if(_4.isArray(_4b.item[_4b.attribute])){_4b.item[_4b.attribute].push(_49);}else{_4b.item[_4b.attribute]=_49;}_4b.newValue=_4b.item[_4b.attribute];this.onNew(_49,_4b);if(_49[_4b.attribute]&&_4.isArray(_49[_4b.attribute])){for(var i=0;i<_49[_4b.attribute].length;i++){this.onNew(_49[_4b.attribute][i],{item:_49,attribute:_4b.attribute});}}return _49;},_addReference:function(_4d,_4e){var rid="_ref_"+this._referenceId++;if(!_4d[this.metaLabel]["referenceIds"]){_4d[this.metaLabel]["referenceIds"]=[];}_4d[this.metaLabel]["referenceIds"].push(rid);this._references[rid]=_4e;},deleteItem:function(_50){_50=this._correctReference(_50);console.log("Item: ",_50);if(this.isItem(_50)){while(_50[this.metaLabel]["referenceIds"].length>0){console.log("refs map: ",this._references);console.log("item to delete: ",_50);var rid=_50[this.metaLabel]["referenceIds"].pop();var _52=this._references[rid];console.log("deleteItem(): ",_52,_52.parent);var _53=_52.parent;var _54=_52.attribute;if(_53&&_53[_54]&&!_4.isArray(_53[_54])){this._setDirty(_53);this.unsetAttribute(_53,_54);delete _53[_54];}if(_4.isArray(_53[_54])){console.log("Parent is array");var _55=this._trimItem(_53[_54]);var _56=false;for(var i=0;i<_53[_54].length&&!_56;i++){if(_53[_54][i][this.metaLabel]===_50[this.metaLabel]){_56=true;}}if(_56){this._setDirty(_53);var del=_53[_54].splice(i-1,1);delete del;}var _59=this._trimItem(_53[_54]);this.onSet(_53,_54,_55,_59);}delete this._references[rid];}this.onDelete(_50);delete this.index[_50[this.idAttribute]];}},_setDirty:function(_5a){if(this.noRevert){return;}for(var i=0;i<this._dirtyItems.length;i++){if(_5a[this.idAttribute]==this._dirtyItems[i][this.idAttribute]){return;}}this._dirtyItems.push({item:_5a,old:this._trimItem(_5a)});this._updateMeta(_5a,{isDirty:true});},setValue:function(_5c,_5d,_5e){_5c=this._correctReference(_5c);this._setDirty(_5c);var old=_5c[_5d]|undefined;_5c[_5d]=_5e;this.onSet(_5c,_5d,old,_5e);},setValues:function(_60,_61,_62){_60=this._correctReference(_60);if(!_4.isArray(_62)){throw new Error("setValues expects to be passed an Array object as its value");}this._setDirty(_60);var old=_60[_61]||null;_60[_61]=_62;this.onSet(_60,_61,old,_62);},unsetAttribute:function(_64,_65){_64=this._correctReference(_64);this._setDirty(_64);var old=_64[_65];delete _64[_65];this.onSet(_64,_65,old,null);},save:function(_67){var _68=[];if(!_67){_67={};}while(this._dirtyItems.length>0){var _69=this._dirtyItems.pop()["item"];var t=this._trimItem(_69);var d;switch(_67.format){case "json":d=_4.toJson(t);break;case "raw":default:d=t;}_68.push(d);this._markClean(_69);}this.onSave(_68);},_markClean:function(_6c){if(_6c&&_6c[this.metaLabel]&&_6c[this.metaLabel]["isDirty"]){delete _6c[this.metaLabel]["isDirty"];}},revert:function(){while(this._dirtyItems.length>0){var d=this._dirtyItems.pop();this._mixin(d.item,d.old);}this.onRevert();},_mixin:function(_6e,_6f){var mix;if(_4.isObject(_6f)){if(_4.isArray(_6f)){while(_6e.length>0){_6e.pop();}for(var i=0;i<_6f.length;i++){if(_4.isObject(_6f[i])){if(_4.isArray(_6f[i])){mix=[];}else{mix={};if(_6f[i][this.metaLabel]&&_6f[i][this.metaLabel]["type"]&&_6f[i][this.metaLabel]["type"]=="reference"){_6e[i]=this.index[_6f[i][this.idAttribute]];continue;}}this._mixin(mix,_6f[i]);_6e.push(mix);}else{_6e.push(_6f[i]);}}}else{for(var i in _6e){if(i in _6f){continue;}delete _6e[i];}for(var i in _6f){if(_4.isObject(_6f[i])){if(_4.isArray(_6f[i])){mix=[];}else{if(_6f[i][this.metaLabel]&&_6f[i][this.metaLabel]["type"]&&_6f[i][this.metaLabel]["type"]=="reference"){_6e[i]=this.index[_6f[i][this.idAttribute]];continue;}mix={};}this._mixin(mix,_6f[i]);_6e[i]=mix;}else{_6e[i]=_6f[i];}}}}},isDirty:function(_72){_72=this._correctReference(_72);return _72&&_72[this.metaLabel]&&_72[this.metaLabel]["isDirty"];},_createReference:function(_73){var obj={};obj[this.metaLabel]={type:"reference"};obj[this.idAttribute]=_73[this.idAttribute];return obj;},_trimItem:function(_75){var _76;if(_4.isArray(_75)){_76=[];for(var i=0;i<_75.length;i++){if(_4.isArray(_75[i])){_76.push(this._trimItem(_75[i]));}else{if(_4.isObject(_75[i])){if(_75[i]["getFullYear"]){_76.push(_4.date.stamp.toISOString(_75[i]));}else{if(_75[i][this.idAttribute]){_76.push(this._createReference(_75[i]));}else{_76.push(this._trimItem(_75[i]));}}}else{_76.push(_75[i]);}}}return _76;}if(_4.isObject(_75)){_76={};for(var _78 in _75){if(!_75[_78]){_76[_78]=undefined;continue;}if(_4.isArray(_75[_78])){_76[_78]=this._trimItem(_75[_78]);}else{if(_4.isObject(_75[_78])){if(_75[_78]["getFullYear"]){_76[_78]=_4.date.stamp.toISOString(_75[_78]);}else{if(_75[_78][this.idAttribute]){_76[_78]=this._createReference(_75[_78]);}else{_76[_78]=this._trimItem(_75[_78]);}}}else{_76[_78]=_75[_78];}}}return _76;}},onSet:function(_79,_7a,_7b,_7c){},onNew:function(_7d,_7e){},onDelete:function(_7f){},onSave:function(_80){},onRevert:function(){}});_6.data.jsonPathStore.byId=_6.data.jsonPathStore.fetchItemByIdentity;}}};});