/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.off._common"],["require","dojo.gears"],["require","dojox.storage"],["require","dojox.sql"],["require","dojox.off.sync"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.off._common"]){_4._hasResource["dojox.off._common"]=true;_4.provide("dojox.off._common");_4.require("dojo.gears");_4.require("dojox.storage");_4.require("dojox.sql");_4.require("dojox.off.sync");_4.mixin(_6.off,{isOnline:false,NET_CHECK:5,STORAGE_NAMESPACE:"_dot",enabled:true,availabilityURL:_4.moduleUrl("dojox","off/network_check.txt"),goingOnline:false,coreOpFailed:false,doNetChecking:true,hasOfflineCache:null,browserRestart:false,_STORAGE_APP_NAME:window.location.href.replace(/[^0-9A-Za-z_]/g,"_"),_initializeCalled:false,_storageLoaded:false,_pageLoaded:false,onLoad:function(){},onNetwork:function(_7){},initialize:function(){this._initializeCalled=true;if(this._storageLoaded&&this._pageLoaded){this._onLoad();}},goOffline:function(){if((_6.off.sync.isSyncing)||(this.goingOnline)){return;}this.goingOnline=false;this.isOnline=false;},goOnline:function(_8){if(_6.off.sync.isSyncing||_6.off.goingOnline){return;}this.goingOnline=true;this.isOnline=false;this._isSiteAvailable(_8);},onFrameworkEvent:function(_9,_a){if(_9=="save"){if(_a.isCoreSave&&(_a.status==_6.storage.FAILED)){_6.off.coreOpFailed=true;_6.off.enabled=false;_6.off.onFrameworkEvent("coreOperationFailed");}}else{if(_9=="coreOperationFailed"){_6.off.coreOpFailed=true;_6.off.enabled=false;}}},_checkOfflineCacheAvailable:function(_b){this.hasOfflineCache=_4.gears.available;_b();},_onLoad:function(){_6.off.files.cache(_4.moduleUrl("dojo","dojo.js"));this._cacheDojoResources();_6.off.files.cache(_6.storage.manager.getResourceList());_6.off.files._slurp();this._checkOfflineCacheAvailable(_4.hitch(this,"_onOfflineCacheChecked"));},_onOfflineCacheChecked:function(){if(this.hasOfflineCache&&this.enabled){this._load(_4.hitch(this,"_finishStartingUp"));}else{if(this.hasOfflineCache&&!this.enabled){this._finishStartingUp();}else{this._keepCheckingUntilInstalled();}}},_keepCheckingUntilInstalled:function(){this._finishStartingUp();},_finishStartingUp:function(){if(!this.hasOfflineCache){this.onLoad();}else{if(this.enabled){this._startNetworkThread();this.goOnline(_4.hitch(this,function(){_6.off.onLoad();}));}else{if(this.coreOpFailed){this.onFrameworkEvent("coreOperationFailed");}else{this.onLoad();}}}},_onPageLoad:function(){this._pageLoaded=true;if(this._storageLoaded&&this._initializeCalled){this._onLoad();}},_onStorageLoad:function(){this._storageLoaded=true;if(!_6.storage.manager.isAvailable()&&_6.storage.manager.isInitialized()){this.coreOpFailed=true;this.enabled=false;}if(this._pageLoaded&&this._initializeCalled){this._onLoad();}},_isSiteAvailable:function(_c){_4.xhrGet({url:this._getAvailabilityURL(),handleAs:"text",timeout:this.NET_CHECK*1000,error:_4.hitch(this,function(_d){this.goingOnline=false;this.isOnline=false;if(_c){_c(false);}}),load:_4.hitch(this,function(_e){this.goingOnline=false;this.isOnline=true;if(_c){_c(true);}else{this.onNetwork("online");}})});},_startNetworkThread:function(){if(!this.doNetChecking){return;}window.setInterval(_4.hitch(this,function(){var d=_4.xhrGet({url:this._getAvailabilityURL(),handleAs:"text",timeout:this.NET_CHECK*1000,error:_4.hitch(this,function(err){if(this.isOnline){this.isOnline=false;try{if(typeof d.ioArgs.xhr.abort=="function"){d.ioArgs.xhr.abort();}}catch(e){}_6.off.sync.isSyncing=false;this.onNetwork("offline");}}),load:_4.hitch(this,function(_11){if(!this.isOnline){this.isOnline=true;this.onNetwork("online");}})});}),this.NET_CHECK*1000);},_getAvailabilityURL:function(){var url=this.availabilityURL.toString();if(url.indexOf("?")==-1){url+="?";}else{url+="&";}url+="browserbust="+new Date().getTime();return url;},_onOfflineCacheInstalled:function(){this.onFrameworkEvent("offlineCacheInstalled");},_cacheDojoResources:function(){var _13=true;_4.forEach(_4.query("script"),function(i){var src=i.getAttribute("src");if(!src){return;}if(src.indexOf("_base/_loader/bootstrap.js")!=-1){_13=false;}});if(!_13){_6.off.files.cache(_4.moduleUrl("dojo","_base.js").uri);_6.off.files.cache(_4.moduleUrl("dojo","_base/_loader/loader.js").uri);_6.off.files.cache(_4.moduleUrl("dojo","_base/_loader/bootstrap.js").uri);_6.off.files.cache(_4.moduleUrl("dojo","_base/_loader/hostenv_browser.js").uri);}for(var i=0;i<_4._loadedUrls.length;i++){_6.off.files.cache(_4._loadedUrls[i]);}},_save:function(){},_load:function(_17){_6.off.sync._load(_17);}});_6.storage.manager.addOnLoad(_4.hitch(_6.off,"_onStorageLoad"));_4.addOnLoad(_6.off,"_onPageLoad");}}};});