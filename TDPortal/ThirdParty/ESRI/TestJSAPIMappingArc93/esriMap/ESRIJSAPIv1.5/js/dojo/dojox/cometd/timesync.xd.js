/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.cometd.timesync"],["require","dojox.cometd._base"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.cometd.timesync"]){_4._hasResource["dojox.cometd.timesync"]=true;_4.provide("dojox.cometd.timesync");_4.require("dojox.cometd._base");_6.cometd.timesync=new function(){this._window=10;this._lags=[];this._offsets=[];this.lag=0;this.offset=0;this.samples=0;this.getServerTime=function(){return new Date().getTime()+this.offset;};this.getServerDate=function(){return new Date(this.getServerTime());};this.setTimeout=function(_7,_8){var ts=(_8 instanceof Date)?_8.getTime():(0+_8);var tc=ts-this.offset;var _b=tc-new Date().getTime();if(_b<=0){_b=1;}return setTimeout(_7,_b);};this._in=function(_c){var _d=_c.channel;if(_d&&_d.indexOf("/meta/")==0){if(_c.ext&&_c.ext.timesync){var _e=_c.ext.timesync;var _f=new Date().getTime();var l=(_f-_e.tc-_e.p)/2-_e.a;var o=_e.ts-_e.tc-l;this._lags.push(l);this._offsets.push(o);if(this._offsets.length>this._window){this._offsets.shift();this._lags.shift();}this.samples++;l=0;o=0;for(var i in this._offsets){l+=this._lags[i];o+=this._offsets[i];}this.offset=parseInt((o/this._offsets.length).toFixed());this.lag=parseInt((l/this._lags.length).toFixed());}}return _c;};this._out=function(msg){var _14=msg.channel;if(_14&&_14.indexOf("/meta/")==0){var now=new Date().getTime();if(!msg.ext){msg.ext={};}msg.ext.timesync={tc:now,l:this.lag,o:this.offset};}return msg;};};_6.cometd._extendInList.push(_4.hitch(_6.cometd.timesync,"_in"));_6.cometd._extendOutList.push(_4.hitch(_6.cometd.timesync,"_out"));}}};});