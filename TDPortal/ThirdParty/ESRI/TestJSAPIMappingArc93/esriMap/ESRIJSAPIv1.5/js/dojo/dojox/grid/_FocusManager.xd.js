/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.grid._FocusManager"],["require","dojox.grid.util"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.grid._FocusManager"]){_4._hasResource["dojox.grid._FocusManager"]=true;_4.provide("dojox.grid._FocusManager");_4.require("dojox.grid.util");_4.declare("dojox.grid._FocusManager",null,{constructor:function(_7){this.grid=_7;this.cell=null;this.rowIndex=-1;this._connects=[];this._connects.push(_4.connect(this.grid.domNode,"onfocus",this,"doFocus"));this._connects.push(_4.connect(this.grid.domNode,"onblur",this,"doBlur"));this._connects.push(_4.connect(this.grid.lastFocusNode,"onfocus",this,"doLastNodeFocus"));this._connects.push(_4.connect(this.grid.lastFocusNode,"onblur",this,"doLastNodeBlur"));this._connects.push(_4.connect(this.grid,"_onFetchComplete",this,"_delayedCellFocus"));this._connects.push(_4.connect(this.grid,"postrender",this,"_delayedHeaderFocus"));},destroy:function(){_4.forEach(this._connects,_4.disconnect);delete this.grid;delete this.cell;},_colHeadNode:null,_colHeadFocusIdx:null,tabbingOut:false,focusClass:"dojoxGridCellFocus",focusView:null,initFocusView:function(){this.focusView=this.grid.views.getFirstScrollingView()||this.focusView;this._initColumnHeaders();},isFocusCell:function(_8,_9){return (this.cell==_8)&&(this.rowIndex==_9);},isLastFocusCell:function(){if(this.cell){return (this.rowIndex==this.grid.rowCount-1)&&(this.cell.index==this.grid.layout.cellCount-1);}return false;},isFirstFocusCell:function(){if(this.cell){return (this.rowIndex==0)&&(this.cell.index==0);}return false;},isNoFocusCell:function(){return (this.rowIndex<0)||!this.cell;},isNavHeader:function(){return (!!this._colHeadNode);},getHeaderIndex:function(){if(this._colHeadNode){return _4.indexOf(this._findHeaderCells(),this._colHeadNode);}else{return -1;}},_focusifyCellNode:function(_a){var n=this.cell&&this.cell.getNode(this.rowIndex);if(n){_4.toggleClass(n,this.focusClass,_a);if(_a){var sl=this.scrollIntoView();try{if(!this.grid.edit.isEditing()){_6.grid.util.fire(n,"focus");if(sl){this.cell.view.scrollboxNode.scrollLeft=sl;}}}catch(e){}}}},_delayedCellFocus:function(){if(this.isNavHeader()){return;}var n=this.cell&&this.cell.getNode(this.rowIndex);if(n){try{if(!this.grid.edit.isEditing()){_4.toggleClass(n,this.focusClass,true);_6.grid.util.fire(n,"focus");}}catch(e){}}},_delayedHeaderFocus:function(){if(this.isNavHeader()){this.focusHeader();}},_initColumnHeaders:function(){this._connects.push(_4.connect(this.grid.viewsHeaderNode,"onblur",this,"doBlurHeader"));var _e=this._findHeaderCells();for(var i=0;i<_e.length;i++){this._connects.push(_4.connect(_e[i],"onfocus",this,"doColHeaderFocus"));this._connects.push(_4.connect(_e[i],"onblur",this,"doColHeaderBlur"));}},_findHeaderCells:function(){var _10=_4.query("th",this.grid.viewsHeaderNode);var _11=[];for(var i=0;i<_10.length;i++){var _13=_10[i];var _14=_4.hasAttr(_13,"tabindex");var _15=_4.attr(_13,"tabindex");if(_14&&_15<0){_11.push(_13);}}return _11;},scrollIntoView:function(){var _16=(this.cell?this._scrollInfo(this.cell):null);if(!_16||!_16.s){return null;}var rt=this.grid.scroller.findScrollTop(this.rowIndex);if(_16.n&&_16.sr){if(_16.n.offsetLeft+_16.n.offsetWidth>_16.sr.l+_16.sr.w){_16.s.scrollLeft=_16.n.offsetLeft+_16.n.offsetWidth-_16.sr.w;}else{if(_16.n.offsetLeft<_16.sr.l){_16.s.scrollLeft=_16.n.offsetLeft;}}}if(_16.r&&_16.sr){if(rt+_16.r.offsetHeight>_16.sr.t+_16.sr.h){this.grid.setScrollTop(rt+_16.r.offsetHeight-_16.sr.h);}else{if(rt<_16.sr.t){this.grid.setScrollTop(rt);}}}return _16.s.scrollLeft;},_scrollInfo:function(_18,_19){if(_18){var cl=_18,sbn=cl.view.scrollboxNode,_1c={w:sbn.clientWidth,l:sbn.scrollLeft,t:sbn.scrollTop,h:sbn.clientHeight},rn=cl.view.getRowNode(this.rowIndex);return {c:cl,s:sbn,sr:_1c,n:(_19?_19:_18.getNode(this.rowIndex)),r:rn};}return null;},_scrollHeader:function(_1e){var _1f=null;if(this._colHeadNode){var _20=this.grid.getCell(_1e);_1f=this._scrollInfo(_20,_20.getNode(0));}if(_1f&&_1f.s&&_1f.sr&&_1f.n){var _21=_1f.sr.l+_1f.sr.w;if(_1f.n.offsetLeft+_1f.n.offsetWidth>_21){_1f.s.scrollLeft=_1f.n.offsetLeft+_1f.n.offsetWidth-_1f.sr.w;}else{if(_1f.n.offsetLeft<_1f.sr.l){_1f.s.scrollLeft=_1f.n.offsetLeft;}else{if(_4.isIE<=7&&_20&&_20.view.headerNode){_20.view.headerNode.scrollLeft=_1f.s.scrollLeft;}}}}},styleRow:function(_22){return;},setFocusIndex:function(_23,_24){this.setFocusCell(this.grid.getCell(_24),_23);},setFocusCell:function(_25,_26){if(_25&&!this.isFocusCell(_25,_26)){this.tabbingOut=false;this._colHeadNode=this._colHeadFocusIdx=null;this.focusGridView();this._focusifyCellNode(false);this.cell=_25;this.rowIndex=_26;this._focusifyCellNode(true);}if(_4.isOpera){setTimeout(_4.hitch(this.grid,"onCellFocus",this.cell,this.rowIndex),1);}else{this.grid.onCellFocus(this.cell,this.rowIndex);}},next:function(){if(this.cell){var row=this.rowIndex,col=this.cell.index+1,cc=this.grid.layout.cellCount-1,rc=this.grid.rowCount-1;if(col>cc){col=0;row++;}if(row>rc){col=cc;row=rc;}if(this.grid.edit.isEditing()){var _2b=this.grid.getCell(col);if(!this.isLastFocusCell()&&!_2b.editable){this.cell=_2b;this.rowIndex=row;this.next();return;}}this.setFocusIndex(row,col);}},previous:function(){if(this.cell){var row=(this.rowIndex||0),col=(this.cell.index||0)-1;if(col<0){col=this.grid.layout.cellCount-1;row--;}if(row<0){row=0;col=0;}if(this.grid.edit.isEditing()){var _2e=this.grid.getCell(col);if(!this.isFirstFocusCell()&&!_2e.editable){this.cell=_2e;this.rowIndex=row;this.previous();return;}}this.setFocusIndex(row,col);}},move:function(_2f,_30){if(this.isNavHeader()){var _31=this._findHeaderCells();var _32=_4.indexOf(_31,this._colHeadNode);_32+=_30;if((_32>=0)&&(_32<_31.length)){this._colHeadNode=_31[_32];this._colHeadFocusIdx=_32;this._scrollHeader(_32);this._colHeadNode.focus();}}else{if(this.cell){var sc=this.grid.scroller,r=this.rowIndex,rc=this.grid.rowCount-1,row=Math.min(rc,Math.max(0,r+_2f));if(_2f){if(_2f>0){if(row>sc.getLastPageRow(sc.page)){this.grid.setScrollTop(this.grid.scrollTop+sc.findScrollTop(row)-sc.findScrollTop(r));}}else{if(_2f<0){if(row<=sc.getPageRow(sc.page)){this.grid.setScrollTop(this.grid.scrollTop-sc.findScrollTop(r)-sc.findScrollTop(row));}}}}var cc=this.grid.layout.cellCount-1,i=this.cell.index,col=Math.min(cc,Math.max(0,i+_30));this.setFocusIndex(row,col);if(_2f){this.grid.updateRow(r);}}}},previousKey:function(e){if(this.grid.edit.isEditing()){_4.stopEvent(e);this.previous();}else{if(!this.isNavHeader()){this.focusHeader();_4.stopEvent(e);}else{this.tabOut(this.grid.domNode);}}},nextKey:function(e){var _3c=this.grid.rowCount==0;if(e.target===this.grid.domNode){this.focusHeader();_4.stopEvent(e);}else{if(this.isNavHeader()){this._colHeadNode=this._colHeadFocusIdx=null;if(this.isNoFocusCell()&&!_3c){this.setFocusIndex(0,0);}else{if(this.cell&&!_3c){if(this.focusView&&!this.focusView.rowNodes[this.rowIndex]){this.grid.scrollToRow(this.rowIndex);}this.focusGrid();}else{this.tabOut(this.grid.lastFocusNode);}}}else{if(this.grid.edit.isEditing()){_4.stopEvent(e);this.next();}else{this.tabOut(this.grid.lastFocusNode);}}}},tabOut:function(_3d){this.tabbingOut=true;_3d.focus();},focusGridView:function(){_6.grid.util.fire(this.focusView,"focus");},focusGrid:function(_3e){this.focusGridView();this._focusifyCellNode(true);},focusHeader:function(){var _3f=this._findHeaderCells();if(!this._colHeadFocusIdx){if(this.isNoFocusCell()){this._colHeadFocusIdx=0;}else{this._colHeadFocusIdx=this.cell.index;}}this._colHeadNode=_3f[this._colHeadFocusIdx];if(this._colHeadNode){_6.grid.util.fire(this._colHeadNode,"focus");this._focusifyCellNode(false);}},doFocus:function(e){if(e&&e.target!=e.currentTarget){_4.stopEvent(e);return;}if(!this.tabbingOut){this.focusHeader();}this.tabbingOut=false;_4.stopEvent(e);},doBlur:function(e){_4.stopEvent(e);},doBlurHeader:function(e){_4.stopEvent(e);},doLastNodeFocus:function(e){if(this.tabbingOut){this._focusifyCellNode(false);}else{if(this.grid.rowCount>0){if(this.isNoFocusCell()){this.setFocusIndex(0,0);}this._focusifyCellNode(true);}else{this.focusHeader();}}this.tabbingOut=false;_4.stopEvent(e);},doLastNodeBlur:function(e){_4.stopEvent(e);},doColHeaderFocus:function(e){_4.toggleClass(e.target,this.focusClass,true);this._scrollHeader(this.getHeaderIndex());},doColHeaderBlur:function(e){_4.toggleClass(e.target,this.focusClass,false);}});}}};});