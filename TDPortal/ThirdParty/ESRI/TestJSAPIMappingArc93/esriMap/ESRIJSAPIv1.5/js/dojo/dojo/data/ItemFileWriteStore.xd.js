/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojo.data.ItemFileWriteStore"],["require","dojo.data.ItemFileReadStore"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojo.data.ItemFileWriteStore"]){_4._hasResource["dojo.data.ItemFileWriteStore"]=true;_4.provide("dojo.data.ItemFileWriteStore");_4.require("dojo.data.ItemFileReadStore");_4.declare("dojo.data.ItemFileWriteStore",_4.data.ItemFileReadStore,{constructor:function(_7){this._features["dojo.data.api.Write"]=true;this._features["dojo.data.api.Notification"]=true;this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};if(!this._datatypeMap["Date"].serialize){this._datatypeMap["Date"].serialize=function(_8){return _4.date.stamp.toISOString(_8,{zulu:true});};}if(_7&&(_7.referenceIntegrity===false)){this.referenceIntegrity=false;}this._saveInProgress=false;},referenceIntegrity:true,_assert:function(_9){if(!_9){throw new Error("assertion failed in ItemFileWriteStore");}},_getIdentifierAttribute:function(){var _a=this.getFeatures()["dojo.data.api.Identity"];return _a;},newItem:function(_b,_c){this._assert(!this._saveInProgress);if(!this._loadFinished){this._forceLoad();}if(typeof _b!="object"&&typeof _b!="undefined"){throw new Error("newItem() was passed something other than an object");}var _d=null;var _e=this._getIdentifierAttribute();if(_e===Number){_d=this._arrayOfAllItems.length;}else{_d=_b[_e];if(typeof _d==="undefined"){throw new Error("newItem() was not passed an identity for the new item");}if(_4.isArray(_d)){throw new Error("newItem() was not passed an single-valued identity");}}if(this._itemsByIdentity){this._assert(typeof this._itemsByIdentity[_d]==="undefined");}this._assert(typeof this._pending._newItems[_d]==="undefined");this._assert(typeof this._pending._deletedItems[_d]==="undefined");var _f={};_f[this._storeRefPropName]=this;_f[this._itemNumPropName]=this._arrayOfAllItems.length;if(this._itemsByIdentity){this._itemsByIdentity[_d]=_f;_f[_e]=[_d];}this._arrayOfAllItems.push(_f);var _10=null;if(_c&&_c.parent&&_c.attribute){_10={item:_c.parent,attribute:_c.attribute,oldValue:undefined};var _11=this.getValues(_c.parent,_c.attribute);if(_11&&_11.length>0){var _12=_11.slice(0,_11.length);if(_11.length===1){_10.oldValue=_11[0];}else{_10.oldValue=_11.slice(0,_11.length);}_12.push(_f);this._setValueOrValues(_c.parent,_c.attribute,_12,false);_10.newValue=this.getValues(_c.parent,_c.attribute);}else{this._setValueOrValues(_c.parent,_c.attribute,_f,false);_10.newValue=_f;}}else{_f[this._rootItemPropName]=true;this._arrayOfTopLevelItems.push(_f);}this._pending._newItems[_d]=_f;for(var key in _b){if(key===this._storeRefPropName||key===this._itemNumPropName){throw new Error("encountered bug in ItemFileWriteStore.newItem");}var _14=_b[key];if(!_4.isArray(_14)){_14=[_14];}_f[key]=_14;if(this.referenceIntegrity){for(var i=0;i<_14.length;i++){var val=_14[i];if(this.isItem(val)){this._addReferenceToMap(val,_f,key);}}}}this.onNew(_f,_10);return _f;},_removeArrayElement:function(_17,_18){var _19=_4.indexOf(_17,_18);if(_19!=-1){_17.splice(_19,1);return true;}return false;},deleteItem:function(_1a){this._assert(!this._saveInProgress);this._assertIsItem(_1a);var _1b=_1a[this._itemNumPropName];var _1c=this.getIdentity(_1a);if(this.referenceIntegrity){var _1d=this.getAttributes(_1a);if(_1a[this._reverseRefMap]){_1a["backup_"+this._reverseRefMap]=_4.clone(_1a[this._reverseRefMap]);}_4.forEach(_1d,function(_1e){_4.forEach(this.getValues(_1a,_1e),function(_1f){if(this.isItem(_1f)){if(!_1a["backupRefs_"+this._reverseRefMap]){_1a["backupRefs_"+this._reverseRefMap]=[];}_1a["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(_1f),attr:_1e});this._removeReferenceFromMap(_1f,_1a,_1e);}},this);},this);var _20=_1a[this._reverseRefMap];if(_20){for(var _21 in _20){var _22=null;if(this._itemsByIdentity){_22=this._itemsByIdentity[_21];}else{_22=this._arrayOfAllItems[_21];}if(_22){for(var _23 in _20[_21]){var _24=this.getValues(_22,_23)||[];var _25=_4.filter(_24,function(_26){return !(this.isItem(_26)&&this.getIdentity(_26)==_1c);},this);this._removeReferenceFromMap(_1a,_22,_23);if(_25.length<_24.length){this._setValueOrValues(_22,_23,_25,true);}}}}}}this._arrayOfAllItems[_1b]=null;_1a[this._storeRefPropName]=null;if(this._itemsByIdentity){delete this._itemsByIdentity[_1c];}this._pending._deletedItems[_1c]=_1a;if(_1a[this._rootItemPropName]){this._removeArrayElement(this._arrayOfTopLevelItems,_1a);}this.onDelete(_1a);return true;},setValue:function(_27,_28,_29){return this._setValueOrValues(_27,_28,_29,true);},setValues:function(_2a,_2b,_2c){return this._setValueOrValues(_2a,_2b,_2c,true);},unsetAttribute:function(_2d,_2e){return this._setValueOrValues(_2d,_2e,[],true);},_setValueOrValues:function(_2f,_30,_31,_32){this._assert(!this._saveInProgress);this._assertIsItem(_2f);this._assert(_4.isString(_30));this._assert(typeof _31!=="undefined");var _33=this._getIdentifierAttribute();if(_30==_33){throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");}var _34=this._getValueOrValues(_2f,_30);var _35=this.getIdentity(_2f);if(!this._pending._modifiedItems[_35]){var _36={};for(var key in _2f){if((key===this._storeRefPropName)||(key===this._itemNumPropName)||(key===this._rootItemPropName)){_36[key]=_2f[key];}else{if(key===this._reverseRefMap){_36[key]=_4.clone(_2f[key]);}else{_36[key]=_2f[key].slice(0,_2f[key].length);}}}this._pending._modifiedItems[_35]=_36;}var _38=false;if(_4.isArray(_31)&&_31.length===0){_38=delete _2f[_30];_31=undefined;if(this.referenceIntegrity&&_34){var _39=_34;if(!_4.isArray(_39)){_39=[_39];}for(var i=0;i<_39.length;i++){var _3b=_39[i];if(this.isItem(_3b)){this._removeReferenceFromMap(_3b,_2f,_30);}}}}else{var _3c;if(_4.isArray(_31)){var _3d=_31;_3c=_31.slice(0,_31.length);}else{_3c=[_31];}if(this.referenceIntegrity){if(_34){var _39=_34;if(!_4.isArray(_39)){_39=[_39];}var map={};_4.forEach(_39,function(_3f){if(this.isItem(_3f)){var id=this.getIdentity(_3f);map[id.toString()]=true;}},this);_4.forEach(_3c,function(_41){if(this.isItem(_41)){var id=this.getIdentity(_41);if(map[id.toString()]){delete map[id.toString()];}else{this._addReferenceToMap(_41,_2f,_30);}}},this);for(var rId in map){var _44;if(this._itemsByIdentity){_44=this._itemsByIdentity[rId];}else{_44=this._arrayOfAllItems[rId];}this._removeReferenceFromMap(_44,_2f,_30);}}else{for(var i=0;i<_3c.length;i++){var _3b=_3c[i];if(this.isItem(_3b)){this._addReferenceToMap(_3b,_2f,_30);}}}}_2f[_30]=_3c;_38=true;}if(_32){this.onSet(_2f,_30,_34,_31);}return _38;},_addReferenceToMap:function(_45,_46,_47){var _48=this.getIdentity(_46);var _49=_45[this._reverseRefMap];if(!_49){_49=_45[this._reverseRefMap]={};}var _4a=_49[_48];if(!_4a){_4a=_49[_48]={};}_4a[_47]=true;},_removeReferenceFromMap:function(_4b,_4c,_4d){var _4e=this.getIdentity(_4c);var _4f=_4b[this._reverseRefMap];var _50;if(_4f){for(_50 in _4f){if(_50==_4e){delete _4f[_50][_4d];if(this._isEmpty(_4f[_50])){delete _4f[_50];}}}if(this._isEmpty(_4f)){delete _4b[this._reverseRefMap];}}},_dumpReferenceMap:function(){var i;for(i=0;i<this._arrayOfAllItems.length;i++){var _52=this._arrayOfAllItems[i];if(_52&&_52[this._reverseRefMap]){console.log("Item: ["+this.getIdentity(_52)+"] is referenced by: "+_4.toJson(_52[this._reverseRefMap]));}}},_getValueOrValues:function(_53,_54){var _55=undefined;if(this.hasAttribute(_53,_54)){var _56=this.getValues(_53,_54);if(_56.length==1){_55=_56[0];}else{_55=_56;}}return _55;},_flatten:function(_57){if(this.isItem(_57)){var _58=_57;var _59=this.getIdentity(_58);var _5a={_reference:_59};return _5a;}else{if(typeof _57==="object"){for(var _5b in this._datatypeMap){var _5c=this._datatypeMap[_5b];if(_4.isObject(_5c)&&!_4.isFunction(_5c)){if(_57 instanceof _5c.type){if(!_5c.serialize){throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+_5b+"]");}return {_type:_5b,_value:_5c.serialize(_57)};}}else{if(_57 instanceof _5c){return {_type:_5b,_value:_57.toString()};}}}}return _57;}},_getNewFileContentString:function(){var _5d={};var _5e=this._getIdentifierAttribute();if(_5e!==Number){_5d.identifier=_5e;}if(this._labelAttr){_5d.label=this._labelAttr;}_5d.items=[];for(var i=0;i<this._arrayOfAllItems.length;++i){var _60=this._arrayOfAllItems[i];if(_60!==null){var _61={};for(var key in _60){if(key!==this._storeRefPropName&&key!==this._itemNumPropName&&key!==this._reverseRefMap&&key!==this._rootItemPropName){var _63=key;var _64=this.getValues(_60,_63);if(_64.length==1){_61[_63]=this._flatten(_64[0]);}else{var _65=[];for(var j=0;j<_64.length;++j){_65.push(this._flatten(_64[j]));_61[_63]=_65;}}}}_5d.items.push(_61);}}var _67=true;return _4.toJson(_5d,_67);},_isEmpty:function(_68){var _69=true;if(_4.isObject(_68)){var i;for(i in _68){_69=false;break;}}else{if(_4.isArray(_68)){if(_68.length>0){_69=false;}}}return _69;},save:function(_6b){this._assert(!this._saveInProgress);this._saveInProgress=true;var _6c=this;var _6d=function(){_6c._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};_6c._saveInProgress=false;if(_6b&&_6b.onComplete){var _6e=_6b.scope||_4.global;_6b.onComplete.call(_6e);}};var _6f=function(err){_6c._saveInProgress=false;if(_6b&&_6b.onError){var _71=_6b.scope||_4.global;_6b.onError.call(_71,err);}};if(this._saveEverything){var _72=this._getNewFileContentString();this._saveEverything(_6d,_6f,_72);}if(this._saveCustom){this._saveCustom(_6d,_6f);}if(!this._saveEverything&&!this._saveCustom){_6d();}},revert:function(){this._assert(!this._saveInProgress);var _73;for(_73 in this._pending._modifiedItems){var _74=this._pending._modifiedItems[_73];var _75=null;if(this._itemsByIdentity){_75=this._itemsByIdentity[_73];}else{_75=this._arrayOfAllItems[_73];}_74[this._storeRefPropName]=this;_75[this._storeRefPropName]=null;var _76=_75[this._itemNumPropName];this._arrayOfAllItems[_76]=_74;if(_75[this._rootItemPropName]){var i;for(i=0;i<this._arrayOfTopLevelItems.length;i++){var _78=this._arrayOfTopLevelItems[i];if(this.getIdentity(_78)==_73){this._arrayOfTopLevelItems[i]=_74;break;}}}if(this._itemsByIdentity){this._itemsByIdentity[_73]=_74;}}var _79;for(_73 in this._pending._deletedItems){_79=this._pending._deletedItems[_73];_79[this._storeRefPropName]=this;var _7a=_79[this._itemNumPropName];if(_79["backup_"+this._reverseRefMap]){_79[this._reverseRefMap]=_79["backup_"+this._reverseRefMap];delete _79["backup_"+this._reverseRefMap];}this._arrayOfAllItems[_7a]=_79;if(this._itemsByIdentity){this._itemsByIdentity[_73]=_79;}if(_79[this._rootItemPropName]){this._arrayOfTopLevelItems.push(_79);}}for(_73 in this._pending._deletedItems){_79=this._pending._deletedItems[_73];if(_79["backupRefs_"+this._reverseRefMap]){_4.forEach(_79["backupRefs_"+this._reverseRefMap],function(_7b){var _7c;if(this._itemsByIdentity){_7c=this._itemsByIdentity[_7b.id];}else{_7c=this._arrayOfAllItems[_7b.id];}this._addReferenceToMap(_7c,_79,_7b.attr);},this);delete _79["backupRefs_"+this._reverseRefMap];}}for(_73 in this._pending._newItems){var _7d=this._pending._newItems[_73];_7d[this._storeRefPropName]=null;this._arrayOfAllItems[_7d[this._itemNumPropName]]=null;if(_7d[this._rootItemPropName]){this._removeArrayElement(this._arrayOfTopLevelItems,_7d);}if(this._itemsByIdentity){delete this._itemsByIdentity[_73];}}this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};return true;},isDirty:function(_7e){if(_7e){var _7f=this.getIdentity(_7e);return new Boolean(this._pending._newItems[_7f]||this._pending._modifiedItems[_7f]||this._pending._deletedItems[_7f]).valueOf();}else{if(!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)){return true;}return false;}},onSet:function(_80,_81,_82,_83){},onNew:function(_84,_85){},onDelete:function(_86){},close:function(_87){if(this.clearOnClose){if(!this.isDirty()){this.inherited(arguments);}else{if(this._jsonFileUrl!==""){throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");}}}}});}}};});