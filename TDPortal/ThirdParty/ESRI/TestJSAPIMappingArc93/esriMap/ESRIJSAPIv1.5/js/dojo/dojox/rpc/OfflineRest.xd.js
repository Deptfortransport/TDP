/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.rpc.OfflineRest"],["require","dojox.data.ClientFilter"],["require","dojox.rpc.Rest"],["require","dojox.storage"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.rpc.OfflineRest"]){_4._hasResource["dojox.rpc.OfflineRest"]=true;_4.provide("dojox.rpc.OfflineRest");_4.require("dojox.data.ClientFilter");_4.require("dojox.rpc.Rest");_4.require("dojox.storage");(function(){var _7=_6.rpc.Rest;var _8="dojox_rpc_OfflineRest";var _9;var _a=_7._index;_6.storage.manager.addOnLoad(function(){_9=_6.storage.manager.available;for(var i in _a){_c(_a[i],i);}});var _d;function _e(_f){return _f.replace(/[^0-9A-Za-z_]/g,"_");};function _c(_10,id){if(_9&&!_d&&(id||(_10&&_10.__id))){_6.storage.put(_e(id||_10.__id),typeof _10=="object"?_6.json.ref.toJson(_10):_10,function(){},_8);}};function _12(_13){return _13 instanceof Error&&(_13.status==503||_13.status>12000||!_13.status);};function _14(){if(_9){var _15=_6.storage.get("dirty",_8);if(_15){for(var _16 in _15){_17(_16,_15);}}}};var _18;function _19(){_18.sendChanges();_18.downloadChanges();};var _1a=setInterval(_19,15000);_4.connect(document,"ononline",_19);_18=_6.rpc.OfflineRest={turnOffAutoSync:function(){clearInterval(_1a);},sync:_19,sendChanges:_14,downloadChanges:function(){},addStore:function(_1b,_1c){_18.stores.push(_1b);_1b.fetch({queryOptions:{cache:true},query:_1c,onComplete:function(_1d,_1e){_1b._localBaseResults=_1d;_1b._localBaseFetch=_1e;}});}};_18.stores=[];var _1f=_7._get;_7._get=function(_20,id){try{_14();if(window.navigator&&navigator.onLine===false){throw new Error();}var dfd=_1f(_20,id);}catch(e){dfd=new _4.Deferred();dfd.errback(e);}var _23=_6.rpc._sync;dfd.addCallback(function(_24){_c(_24,_20.servicePath+id);return _24;});dfd.addErrback(function(_25){if(_9){if(_12(_25)){var _26={};var _27=function(id,_29){if(_26[id]){return _29;}var _2a=_4.fromJson(_6.storage.get(_e(id),_8))||_29;_26[id]=_2a;for(var i in _2a){var val=_2a[i];if(val&&val.$ref){_2a[i]=_27(val.$ref,val);}}if(_2a instanceof Array){for(i=0;i<_2a.length;i++){if(_2a[i]===undefined){_2a.splice(i--,1);}}}return _2a;};_d=true;var _2d=_27(_20.servicePath+id);if(!_2d){return _25;}_d=false;return _2d;}else{return _25;}}else{if(_23){return new Error("Storage manager not loaded, can not continue");}dfd=new _4.Deferred();dfd.addCallback(arguments.callee);_6.storage.manager.addOnLoad(function(){dfd.callback();});return dfd;}});return dfd;};var _2e=_7._change;_7._change=function(_2f,_30,id,_32){if(!_9){return _2e.apply(this,arguments);}var _33=_30.servicePath+id;if(_2f=="delete"){_6.storage.remove(_e(_33),_8);}else{_6.storage.put(_e(_6.rpc.JsonRest._contentId),_32,function(){},_8);}var _34=_30._store;if(_34){_34.updateResultSet(_34._localBaseResults,_34._localBaseFetch);_6.storage.put(_e(_30.servicePath+_34._localBaseFetch.query),_6.json.ref.toJson(_34._localBaseResults),function(){},_8);}var _35=_6.storage.get("dirty",_8)||{};if(_2f=="put"||_2f=="delete"){var _36=_33;}else{_36=0;for(var i in _35){if(!isNaN(parseInt(i))){_36=i;}}_36++;}_35[_36]={method:_2f,id:_33,content:_32};return _17(_36,_35);};function _17(_38,_39){var _3a=_39[_38];var _3b=_6.rpc.JsonRest.getServiceAndId(_3a.id);var _3c=_2e(_3a.method,_3b.service,_3b.id,_3a.content);_39[_38]=_3a;_6.storage.put("dirty",_39,function(){},_8);_3c.addBoth(function(_3d){if(_12(_3d)){return null;}var _3e=_6.storage.get("dirty",_8)||{};delete _3e[_38];_6.storage.put("dirty",_3e,function(){},_8);return _3d;});return _3c;};_4.connect(_a,"onLoad",_c);_4.connect(_a,"onUpdate",_c);})();}}};});