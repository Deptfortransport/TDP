/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.ItemExplorer"],["require","dijit.Tree"],["require","dijit.Dialog"],["require","dijit.Menu"],["require","dijit.form.ValidationTextBox"],["require","dijit.form.Textarea"],["require","dijit.form.Button"],["require","dijit.form.CheckBox"],["require","dijit.form.FilteringSelect"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.ItemExplorer"]){_4._hasResource["dojox.data.ItemExplorer"]=true;_4.provide("dojox.data.ItemExplorer");_4.require("dijit.Tree");_4.require("dijit.Dialog");_4.require("dijit.Menu");_4.require("dijit.form.ValidationTextBox");_4.require("dijit.form.Textarea");_4.require("dijit.form.Button");_4.require("dijit.form.CheckBox");_4.require("dijit.form.FilteringSelect");(function(){var _7=function(_8,_9,_a){var _b=_8.getValues(_9,_a);if(_b.length<2){_b=_8.getValue(_9,_a);}return _b;};_4.declare("dojox.data.ItemExplorer",_5.Tree,{useSelect:false,refSelectSearchAttr:null,constructor:function(_c){_4.mixin(this,_c);var _d=this;var _e={};var _f=this.rootModelNode={value:_e,id:"root"};this._modelNodeIdMap={};this._modelNodePropMap={};var _10=1;this.model={getRoot:function(_11){_11(_f);},mayHaveChildren:function(_12){return _12.value&&typeof _12.value=="object"&&!(_12.value instanceof Date);},getChildren:function(_13,_14,_15){var _16,_17,_18=_13.value;var _19=[];if(_18==_e){_14([]);return;}var _1a=_d.store&&_d.store.isItem(_18,true);if(_1a&&!_d.store.isItemLoaded(_18)){_d.store.loadItem({item:_18,onItem:function(_1b){_18=_1b;_1c();}});}else{_1c();}function _1c(){if(_1a){_16=_d.store.getAttributes(_18);_17=_18;}else{if(_18&&typeof _18=="object"){_17=_13.value;_16=[];for(var i in _18){if(_18.hasOwnProperty(i)&&i!="__id"&&i!="__clientId"){_16.push(i);}}}}if(_16){for(var key,k=0;key=_16[k++];){_19.push({property:key,value:_1a?_7(_d.store,_18,key):_18[key],parent:_17});}_19.push({addNew:true,parent:_17,parentNode:_13});}_14(_19);};},getIdentity:function(_20){if(!_20.id){if(_20.addNew){_20.property="--addNew";}_20.id=_10++;if(_d.store){if(_d.store.isItem(_20.value)){var _21=_d.store.getIdentity(_20.value);(_d._modelNodeIdMap[_21]=_d._modelNodeIdMap[_21]||[]).push(_20);}if(_20.parent){_21=_d.store.getIdentity(_20.parent)+"."+_20.property;(_d._modelNodePropMap[_21]=_d._modelNodePropMap[_21]||[]).push(_20);}}}return _20.id;},getLabel:function(_22){return _22===_f?"Object Properties":_22.addNew?(_22.parent instanceof Array?"Add new value":"Add new property"):_22.property+": "+(_22.value instanceof Array?"("+_22.value.length+" elements)":_22.value);},onChildrenChange:function(_23){},onChange:function(_24){}};},postCreate:function(){this.inherited(arguments);_4.connect(this,"onClick",function(_25,_26){this.lastFocused=_26;if(_25.addNew){this._addProperty();}else{this._editProperty();}});var _27=new _5.Menu({targetNodeIds:[this.rootNode.domNode],id:"contextMenu"});_4.connect(_27,"_openMyself",this,function(e){var _29=_5.getEnclosingWidget(e.target);if(_29){var _2a=_29.item;if(this.store.isItem(_2a.value,true)&&!_2a.parent){_27.getChildren().forEach(function(_2b){_2b.attr("disabled",(_2b.label!="Add"));});this.lastFocused=_29;}else{if(_2a.value&&typeof _2a.value=="object"&&!(_2a.value instanceof Date)){_27.getChildren().forEach(function(_2c){_2c.attr("disabled",(_2c.label!="Add")&&(_2c.label!="Delete"));});this.lastFocused=_29;}else{if(_2a.property&&_4.indexOf(this.store.getIdentityAttributes(),_2a.property)>=0){this.focusNode(_29);alert("Cannot modify an Identifier node.");}else{if(_2a.addNew){this.focusNode(_29);}else{_27.getChildren().forEach(function(_2d){_2d.attr("disabled",(_2d.label!="Edit")&&(_2d.label!="Delete"));});this.lastFocused=_29;}}}}}});_27.addChild(new _5.MenuItem({label:"Add",onClick:_4.hitch(this,"_addProperty")}));_27.addChild(new _5.MenuItem({label:"Edit",onClick:_4.hitch(this,"_editProperty")}));_27.addChild(new _5.MenuItem({label:"Delete",onClick:_4.hitch(this,"_destroyProperty")}));_27.startup();},store:null,setStore:function(_2e){this.store=_2e;var _2f=this;if(this._editDialog){this._editDialog.destroyRecursive();delete this._editDialog;}_4.connect(_2e,"onSet",function(_30,_31,_32,_33){var _34,i,_36=_2f.store.getIdentity(_30);_34=_2f._modelNodeIdMap[_36];if(_34&&(_32===undefined||_33===undefined||_32 instanceof Array||_33 instanceof Array||typeof _32=="object"||typeof _33=="object")){for(i=0;i<_34.length;i++){(function(_37){_2f.model.getChildren(_37,function(_38){_2f.model.onChildrenChange(_37,_38);});})(_34[i]);}}_34=_2f._modelNodePropMap[_36+"."+_31];if(_34){for(i=0;i<_34.length;i++){_34[i].value=_33;_2f.model.onChange(_34[i]);}}});this.rootNode.setChildItems([]);},setItem:function(_39){(this._modelNodeIdMap={})[this.store.getIdentity(_39)]=[this.rootModelNode];this._modelNodePropMap={};this.rootModelNode.value=_39;var _3a=this;this.model.getChildren(this.rootModelNode,function(_3b){_3a.rootNode.setChildItems(_3b);});},refreshItem:function(){this.setItem(this.rootModelNode.value);},_createEditDialog:function(){this._editDialog=new _5.Dialog({title:"Edit Property",execute:_4.hitch(this,"_updateItem"),preload:true});this._editDialog.placeAt(_4.body());this._editDialog.startup();var _3c=_4.doc.createElement("div");var _3d=_4.doc.createElement("label");_4.attr(_3d,"for","property");_4.style(_3d,"fontWeight","bold");_4.attr(_3d,"innerHTML","Property:");_3c.appendChild(_3d);var _3e=new _5.form.ValidationTextBox({name:"property",value:"",required:true,disabled:true}).placeAt(_3c);_3c.appendChild(_4.doc.createElement("br"));_3c.appendChild(_4.doc.createElement("br"));var _3f=new _5.form.RadioButton({name:"itemType",value:"value",onClick:_4.hitch(this,function(){this._enableFields("value");})}).placeAt(_3c);var _40=_4.doc.createElement("label");_4.attr(_40,"for","value");_4.attr(_40,"innerHTML","Value (JSON):");_3c.appendChild(_40);var _41=_4.doc.createElement("div");_4.addClass(_41,"value");var _42=new _5.form.Textarea({name:"jsonVal"}).placeAt(_41);_3c.appendChild(_41);var _43=new _5.form.RadioButton({name:"itemType",value:"reference",onClick:_4.hitch(this,function(){this._enableFields("reference");})}).placeAt(_3c);var _44=_4.doc.createElement("label");_4.attr(_44,"for","_reference");_4.attr(_44,"innerHTML","Reference (ID):");_3c.appendChild(_44);_3c.appendChild(_4.doc.createElement("br"));var _45=_4.doc.createElement("div");_4.addClass(_45,"reference");if(this.useSelect){var _46=new _5.form.FilteringSelect({name:"_reference",store:this.store,searchAttr:this.refSelectSearchAttr||this.store.getIdentityAttributes()[0],required:false,value:null,pageSize:10}).placeAt(_45);}else{var _47=new _5.form.ValidationTextBox({name:"_reference",value:"",promptMessage:"Enter the ID of the item to reference",isValid:_4.hitch(this,function(_48){return true;})}).placeAt(_45);}_3c.appendChild(_45);_3c.appendChild(_4.doc.createElement("br"));_3c.appendChild(_4.doc.createElement("br"));var _49=document.createElement("div");_49.setAttribute("dir","rtl");var _4a=new _5.form.Button({type:"reset",label:"Cancel"}).placeAt(_49);_4a.onClick=_4.hitch(this._editDialog,"onCancel");var _4b=new _5.form.Button({type:"submit",label:"OK"}).placeAt(_49);_3c.appendChild(_49);this._editDialog.attr("content",_3c);},_enableFields:function(_4c){switch(_4c){case "reference":_4.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(_4d){_5.getEnclosingWidget(_4d).attr("disabled",true);});_4.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(_4e){_5.getEnclosingWidget(_4e).attr("disabled",false);});break;case "value":_4.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(_4f){_5.getEnclosingWidget(_4f).attr("disabled",false);});_4.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(_50){_5.getEnclosingWidget(_50).attr("disabled",true);});break;}},_updateItem:function(_51){var _52,_53,val,_55,_56=this._editDialog.attr("title")=="Edit Property";var _57=this._editDialog;var _58=this.store;function _59(){try{var _5a,_5b=[];var _5c=_51.property;if(_56){while(!_58.isItem(_53.parent,true)){_52=_52.getParent();_5b.push(_53.property);_53=_52.item;}if(_5b.length==0){_58.setValue(_53.parent,_53.property,val);}else{_55=_7(_58,_53.parent,_53.property);if(_55 instanceof Array){_55=_55.concat();}_5a=_55;while(_5b.length>1){_5a=_5a[_5b.pop()];}_5a[_5b]=val;_58.setValue(_53.parent,_53.property,_55);}}else{if(_58.isItem(_5d,true)){if(!_58.isItemLoaded(_5d)){_58.loadItem({item:_5d,onItem:function(_5e){if(_5e instanceof Array){_5c=_5e.length;}_58.setValue(_5e,_5c,val);}});}else{if(_5d instanceof Array){_5c=_5d.length;}_58.setValue(_5d,_5c,val);}}else{if(_53.value instanceof Array){_5b.push(_53.value.length);}else{_5b.push(_51.property);}while(!_58.isItem(_53.parent,true)){_52=_52.getParent();_5b.push(_53.property);_53=_52.item;}_55=_7(_58,_53.parent,_53.property);_5a=_55;while(_5b.length>1){_5a=_5a[_5b.pop()];}_5a[_5b]=val;_58.setValue(_53.parent,_53.property,_55);}}}catch(e){alert(e);}};if(_57.validate()){_52=this.lastFocused;_53=_52.item;var _5d=_53.value;if(_53.addNew){_5d=_52.item.parent;_52=_52.getParent();_53=_52.item;}val=null;switch(_51.itemType){case "reference":this.store.fetchItemByIdentity({identity:_51._reference,onItem:function(_5f){val=_5f;_59();},onError:function(){alert("The id could not be found");}});break;case "value":var _60=_51.jsonVal;val=_4.fromJson(_60);if(typeof val=="function"){val.toString=function(){return _60;};}_59();break;}}else{_57.show();}},_editProperty:function(){var _61=_4.mixin({},this.lastFocused.item);if(!this._editDialog){this._createEditDialog();}else{this._editDialog.reset();}if(_4.indexOf(this.store.getIdentityAttributes(),_61.property)>=0){alert("Cannot Edit an Identifier!");}else{this._editDialog.attr("title","Edit Property");_5.getEnclosingWidget(_4.query("input",this._editDialog.containerNode)[0]).attr("disabled",true);if(this.store.isItem(_61.value,true)){if(_61.parent){_61.itemType="reference";this._enableFields(_61.itemType);_61._reference=this.store.getIdentity(_61.value);this._editDialog.attr("value",_61);this._editDialog.show();}}else{if(_61.value&&typeof _61.value=="object"&&!(_61.value instanceof Date)){}else{_61.itemType="value";this._enableFields(_61.itemType);_61.jsonVal=typeof _61.value=="function"?_61.value.toString():_61.value instanceof Date?"new Date(\""+_61.value+"\")":_4.toJson(_61.value);this._editDialog.attr("value",_61);this._editDialog.show();}}}},_destroyProperty:function(){var _62=this.lastFocused;var _63=_62.item;var _64=[];while(!this.store.isItem(_63.parent,true)||_63.parent instanceof Array){_62=_62.getParent();_64.push(_63.property);_63=_62.item;}if(_4.indexOf(this.store.getIdentityAttributes(),_63.property)>=0){alert("Cannot Delete an Identifier!");}else{try{if(_64.length>0){var _65,_66=_7(this.store,_63.parent,_63.property);_65=_66;while(_64.length>1){_65=_65[_64.pop()];}if(_4.isArray(_65)){_65.splice(_64,1);}else{delete _65[_64];}this.store.setValue(_63.parent,_63.property,_66);}else{this.store.unsetAttribute(_63.parent,_63.property);}}catch(e){alert(e);}}},_addProperty:function(){var _67=this.lastFocused.item;var _68=_67.value;var _69=_4.hitch(this,function(){var _6a=null;if(!this._editDialog){this._createEditDialog();}else{this._editDialog.reset();}if(_68 instanceof Array){_6a=_68.length;_5.getEnclosingWidget(_4.query("input",this._editDialog.containerNode)[0]).attr("disabled",true);}else{_5.getEnclosingWidget(_4.query("input",this._editDialog.containerNode)[0]).attr("disabled",false);}this._editDialog.attr("title","Add Property");this._enableFields("value");this._editDialog.attr("value",{itemType:"value",property:_6a});this._editDialog.show();});if(_67.addNew){_67=this.lastFocused.getParent().item;_68=this.lastFocused.item.parent;}if(_67.property&&_4.indexOf(this.store.getIdentityAttributes(),_67.property)>=0){alert("Cannot add properties to an ID node!");}else{if(this.store.isItem(_68,true)&&!this.store.isItemLoaded(_68)){this.store.loadItem({item:_68,onItem:function(_6b){_68=_6b;_69();}});}else{_69();}}}});})();}}};});