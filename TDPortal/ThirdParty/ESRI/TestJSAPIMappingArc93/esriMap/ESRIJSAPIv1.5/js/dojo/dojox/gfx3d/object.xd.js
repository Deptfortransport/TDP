/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.gfx3d.object"],["require","dojox.gfx"],["require","dojox.gfx3d.lighting"],["require","dojox.gfx3d.scheduler"],["require","dojox.gfx3d.vector"],["require","dojox.gfx3d.gradient"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.gfx3d.object"]){_4._hasResource["dojox.gfx3d.object"]=true;_4.provide("dojox.gfx3d.object");_4.require("dojox.gfx");_4.require("dojox.gfx3d.lighting");_4.require("dojox.gfx3d.scheduler");_4.require("dojox.gfx3d.vector");_4.require("dojox.gfx3d.gradient");var _7=function(o,x){if(arguments.length>1){o=x;}var e={};for(var i in o){if(i in e){continue;}}};_4.declare("dojox.gfx3d.Object",null,{constructor:function(){this.object=null;this.matrix=null;this.cache=null;this.renderer=null;this.parent=null;this.strokeStyle=null;this.fillStyle=null;this.shape=null;},setObject:function(_c){this.object=_6.gfx.makeParameters(this.object,_c);return this;},setTransform:function(_d){this.matrix=_6.gfx3d.matrix.clone(_d?_6.gfx3d.matrix.normalize(_d):_6.gfx3d.identity,true);return this;},applyRightTransform:function(_e){return _e?this.setTransform([this.matrix,_e]):this;},applyLeftTransform:function(_f){return _f?this.setTransform([_f,this.matrix]):this;},applyTransform:function(_10){return _10?this.setTransform([this.matrix,_10]):this;},setFill:function(_11){this.fillStyle=_11;return this;},setStroke:function(_12){this.strokeStyle=_12;return this;},toStdFill:function(_13,_14){return (this.fillStyle&&typeof this.fillStyle["type"]!="undefined")?_13[this.fillStyle.type](_14,this.fillStyle.finish,this.fillStyle.color):this.fillStyle;},invalidate:function(){this.renderer.addTodo(this);},destroy:function(){if(this.shape){var p=this.shape.getParent();if(p){p.remove(this.shape);}this.shape=null;}},render:function(_16){throw "Pure virtual function, not implemented";},draw:function(_17){throw "Pure virtual function, not implemented";},getZOrder:function(){return 0;},getOutline:function(){return null;}});_4.declare("dojox.gfx3d.Scene",_6.gfx3d.Object,{constructor:function(){this.objects=[];this.todos=[];this.schedule=_6.gfx3d.scheduler.zOrder;this._draw=_6.gfx3d.drawer.conservative;},setFill:function(_18){this.fillStyle=_18;_4.forEach(this.objects,function(_19){_19.setFill(_18);});return this;},setStroke:function(_1a){this.strokeStyle=_1a;_4.forEach(this.objects,function(_1b){_1b.setStroke(_1a);});return this;},render:function(_1c,_1d){var m=_6.gfx3d.matrix.multiply(_1c,this.matrix);if(_1d){this.todos=this.objects;}_4.forEach(this.todos,function(_1f){_1f.render(m,_1d);});},draw:function(_20){this.objects=this.schedule(this.objects);this._draw(this.todos,this.objects,this.renderer);},addTodo:function(_21){if(_4.every(this.todos,function(_22){return _22!=_21;})){this.todos.push(_21);this.invalidate();}},invalidate:function(){this.parent.addTodo(this);},getZOrder:function(){var _23=0;_4.forEach(this.objects,function(_24){_23+=_24.getZOrder();});return (this.objects.length>1)?_23/this.objects.length:0;}});_4.declare("dojox.gfx3d.Edges",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultEdges);},setObject:function(_25,_26){this.object=_6.gfx.makeParameters(this.object,(_25 instanceof Array)?{points:_25,style:_26}:_25);return this;},getZOrder:function(){var _27=0;_4.forEach(this.cache,function(_28){_27+=_28.z;});return (this.cache.length>1)?_27/this.cache.length:0;},render:function(_29){var m=_6.gfx3d.matrix.multiply(_29,this.matrix);this.cache=_4.map(this.object.points,function(_2b){return _6.gfx3d.matrix.multiplyPoint(m,_2b);});},draw:function(){var c=this.cache;if(this.shape){this.shape.setShape("");}else{this.shape=this.renderer.createPath();}var p=this.shape.setAbsoluteMode("absolute");if(this.object.style=="strip"||this.object.style=="loop"){p.moveTo(c[0].x,c[0].y);_4.forEach(c.slice(1),function(_2e){p.lineTo(_2e.x,_2e.y);});if(this.object.style=="loop"){p.closePath();}}else{for(var i=0;i<this.cache.length;){p.moveTo(c[i].x,c[i].y);i++;p.lineTo(c[i].x,c[i].y);i++;}}p.setStroke(this.strokeStyle);}});_4.declare("dojox.gfx3d.Orbit",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultOrbit);},render:function(_30){var m=_6.gfx3d.matrix.multiply(_30,this.matrix);var _32=[0,Math.PI/4,Math.PI/3];var _33=_6.gfx3d.matrix.multiplyPoint(m,this.object.center);var _34=_4.map(_32,function(_35){return {x:this.center.x+this.radius*Math.cos(_35),y:this.center.y+this.radius*Math.sin(_35),z:this.center.z};},this.object);_34=_4.map(_34,function(_36){return _6.gfx3d.matrix.multiplyPoint(m,_36);});var _37=_6.gfx3d.vector.normalize(_34);_34=_4.map(_34,function(_38){return _6.gfx3d.vector.substract(_38,_33);});var A={xx:_34[0].x*_34[0].y,xy:_34[0].y*_34[0].y,xz:1,yx:_34[1].x*_34[1].y,yy:_34[1].y*_34[1].y,yz:1,zx:_34[2].x*_34[2].y,zy:_34[2].y*_34[2].y,zz:1,dx:0,dy:0,dz:0};var B=_4.map(_34,function(_3b){return -Math.pow(_3b.x,2);});var X=_6.gfx3d.matrix.multiplyPoint(_6.gfx3d.matrix.invert(A),B[0],B[1],B[2]);var _3d=Math.atan2(X.x,1-X.y)/2;var _3e=_4.map(_34,function(_3f){return _6.gfx.matrix.multiplyPoint(_6.gfx.matrix.rotate(-_3d),_3f.x,_3f.y);});var a=Math.pow(_3e[0].x,2);var b=Math.pow(_3e[0].y,2);var c=Math.pow(_3e[1].x,2);var d=Math.pow(_3e[1].y,2);var rx=Math.sqrt((a*d-b*c)/(d-b));var ry=Math.sqrt((a*d-b*c)/(a-c));this.cache={cx:_33.x,cy:_33.y,rx:rx,ry:ry,theta:_3d,normal:_37};},draw:function(_46){if(this.shape){this.shape.setShape(this.cache);}else{this.shape=this.renderer.createEllipse(this.cache);}this.shape.applyTransform(_6.gfx.matrix.rotateAt(this.cache.theta,this.cache.cx,this.cache.cy)).setStroke(this.strokeStyle).setFill(this.toStdFill(_46,this.cache.normal));}});_4.declare("dojox.gfx3d.Path3d",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultPath3d);this.segments=[];this.absolute=true;this.last={};this.path="";},_collectArgs:function(_47,_48){for(var i=0;i<_48.length;++i){var t=_48[i];if(typeof (t)=="boolean"){_47.push(t?1:0);}else{if(typeof (t)=="number"){_47.push(t);}else{if(t instanceof Array){this._collectArgs(_47,t);}else{if("x" in t&&"y" in t){_47.push(t.x);_47.push(t.y);}}}}}},_validSegments:{m:3,l:3,z:0},_pushSegment:function(_4b,_4c){var _4d=this._validSegments[_4b.toLowerCase()],_4e;if(typeof (_4d)=="number"){if(_4d){if(_4c.length>=_4d){_4e={action:_4b,args:_4c.slice(0,_4c.length-_4c.length%_4d)};this.segments.push(_4e);}}else{_4e={action:_4b,args:[]};this.segments.push(_4e);}}},moveTo:function(){var _4f=[];this._collectArgs(_4f,arguments);this._pushSegment(this.absolute?"M":"m",_4f);return this;},lineTo:function(){var _50=[];this._collectArgs(_50,arguments);this._pushSegment(this.absolute?"L":"l",_50);return this;},closePath:function(){this._pushSegment("Z",[]);return this;},render:function(_51){var m=_6.gfx3d.matrix.multiply(_51,this.matrix);var _53="";var _54=this._validSegments;_4.forEach(this.segments,function(_55){_53+=_55.action;for(var i=0;i<_55.args.length;i+=_54[_55.action.toLowerCase()]){var pt=_6.gfx3d.matrix.multiplyPoint(m,_55.args[i],_55.args[i+1],_55.args[i+2]);_53+=" "+pt.x+" "+pt.y;}});this.cache=_53;},_draw:function(){return this.parent.createPath(this.cache);}});_4.declare("dojox.gfx3d.Triangles",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultTriangles);},setObject:function(_58,_59){if(_58 instanceof Array){this.object=_6.gfx.makeParameters(this.object,{points:_58,style:_59});}else{this.object=_6.gfx.makeParameters(this.object,_58);}return this;},render:function(_5a){var m=_6.gfx3d.matrix.multiply(_5a,this.matrix);var c=_4.map(this.object.points,function(_5d){return _6.gfx3d.matrix.multiplyPoint(m,_5d);});this.cache=[];var _5e=c.slice(0,2);var _5f=c[0];if(this.object.style=="strip"){_4.forEach(c.slice(2),function(_60){_5e.push(_60);_5e.push(_5e[0]);this.cache.push(_5e);_5e=_5e.slice(1,3);},this);}else{if(this.object.style=="fan"){_4.forEach(c.slice(2),function(_61){_5e.push(_61);_5e.push(_5f);this.cache.push(_5e);_5e=[_5f,_61];},this);}else{for(var i=0;i<c.length;){this.cache.push([c[i],c[i+1],c[i+2],c[i]]);i+=3;}}}},draw:function(_63){this.cache=_6.gfx3d.scheduler.bsp(this.cache,function(it){return it;});if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}_4.forEach(this.cache,function(_65){this.shape.createPolyline(_65).setStroke(this.strokeStyle).setFill(this.toStdFill(_63,_6.gfx3d.vector.normalize(_65)));},this);},getZOrder:function(){var _66=0;_4.forEach(this.cache,function(_67){_66+=(_67[0].z+_67[1].z+_67[2].z)/3;});return (this.cache.length>1)?_66/this.cache.length:0;}});_4.declare("dojox.gfx3d.Quads",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultQuads);},setObject:function(_68,_69){this.object=_6.gfx.makeParameters(this.object,(_68 instanceof Array)?{points:_68,style:_69}:_68);return this;},render:function(_6a){var m=_6.gfx3d.matrix.multiply(_6a,this.matrix),i;var c=_4.map(this.object.points,function(_6e){return _6.gfx3d.matrix.multiplyPoint(m,_6e);});this.cache=[];if(this.object.style=="strip"){var _6f=c.slice(0,2);for(i=2;i<c.length;){_6f=_6f.concat([c[i],c[i+1],_6f[0]]);this.cache.push(_6f);_6f=_6f.slice(2,4);i+=2;}}else{for(i=0;i<c.length;){this.cache.push([c[i],c[i+1],c[i+2],c[i+3],c[i]]);i+=4;}}},draw:function(_70){this.cache=_6.gfx3d.scheduler.bsp(this.cache,function(it){return it;});if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}for(var x=0;x<this.cache.length;x++){this.shape.createPolyline(this.cache[x]).setStroke(this.strokeStyle).setFill(this.toStdFill(_70,_6.gfx3d.vector.normalize(this.cache[x])));}},getZOrder:function(){var _73=0;for(var x=0;x<this.cache.length;x++){var i=this.cache[x];_73+=(i[0].z+i[1].z+i[2].z+i[3].z)/4;}return (this.cache.length>1)?_73/this.cache.length:0;}});_4.declare("dojox.gfx3d.Polygon",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultPolygon);},setObject:function(_76){this.object=_6.gfx.makeParameters(this.object,(_76 instanceof Array)?{path:_76}:_76);return this;},render:function(_77){var m=_6.gfx3d.matrix.multiply(_77,this.matrix);this.cache=_4.map(this.object.path,function(_79){return _6.gfx3d.matrix.multiplyPoint(m,_79);});this.cache.push(this.cache[0]);},draw:function(_7a){if(this.shape){this.shape.setShape({points:this.cache});}else{this.shape=this.renderer.createPolyline({points:this.cache});}this.shape.setStroke(this.strokeStyle).setFill(this.toStdFill(_7a,_6.gfx3d.matrix.normalize(this.cache)));},getZOrder:function(){var _7b=0;for(var x=0;x<this.cache.length;x++){_7b+=this.cache[x].z;}return (this.cache.length>1)?_7b/this.cache.length:0;},getOutline:function(){return this.cache.slice(0,3);}});_4.declare("dojox.gfx3d.Cube",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultCube);this.polygons=[];},setObject:function(_7d){this.object=_6.gfx.makeParameters(this.object,_7d);},render:function(_7e){var a=this.object.top;var g=this.object.bottom;var b={x:g.x,y:a.y,z:a.z};var c={x:g.x,y:g.y,z:a.z};var d={x:a.x,y:g.y,z:a.z};var e={x:a.x,y:a.y,z:g.z};var f={x:g.x,y:a.y,z:g.z};var h={x:a.x,y:g.y,z:g.z};var _87=[a,b,c,d,e,f,g,h];var m=_6.gfx3d.matrix.multiply(_7e,this.matrix);var p=_4.map(_87,function(_8a){return _6.gfx3d.matrix.multiplyPoint(m,_8a);});a=p[0];b=p[1];c=p[2];d=p[3];e=p[4];f=p[5];g=p[6];h=p[7];this.cache=[[a,b,c,d,a],[e,f,g,h,e],[a,d,h,e,a],[d,c,g,h,d],[c,b,f,g,c],[b,a,e,f,b]];},draw:function(_8b){this.cache=_6.gfx3d.scheduler.bsp(this.cache,function(it){return it;});var _8d=this.cache.slice(3);if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}for(var x=0;x<_8d.length;x++){this.shape.createPolyline(_8d[x]).setStroke(this.strokeStyle).setFill(this.toStdFill(_8b,_6.gfx3d.vector.normalize(_8d[x])));}},getZOrder:function(){var top=this.cache[0][0];var _90=this.cache[1][2];return (top.z+_90.z)/2;}});_4.declare("dojox.gfx3d.Cylinder",_6.gfx3d.Object,{constructor:function(){this.object=_4.clone(_6.gfx3d.defaultCylinder);},render:function(_91){var m=_6.gfx3d.matrix.multiply(_91,this.matrix);var _93=[0,Math.PI/4,Math.PI/3];var _94=_6.gfx3d.matrix.multiplyPoint(m,this.object.center);var _95=_4.map(_93,function(_96){return {x:this.center.x+this.radius*Math.cos(_96),y:this.center.y+this.radius*Math.sin(_96),z:this.center.z};},this.object);_95=_4.map(_95,function(_97){return _6.gfx3d.vector.substract(_6.gfx3d.matrix.multiplyPoint(m,_97),_94);});var A={xx:_95[0].x*_95[0].y,xy:_95[0].y*_95[0].y,xz:1,yx:_95[1].x*_95[1].y,yy:_95[1].y*_95[1].y,yz:1,zx:_95[2].x*_95[2].y,zy:_95[2].y*_95[2].y,zz:1,dx:0,dy:0,dz:0};var B=_4.map(_95,function(_9a){return -Math.pow(_9a.x,2);});var X=_6.gfx3d.matrix.multiplyPoint(_6.gfx3d.matrix.invert(A),B[0],B[1],B[2]);var _9c=Math.atan2(X.x,1-X.y)/2;var _9d=_4.map(_95,function(_9e){return _6.gfx.matrix.multiplyPoint(_6.gfx.matrix.rotate(-_9c),_9e.x,_9e.y);});var a=Math.pow(_9d[0].x,2);var b=Math.pow(_9d[0].y,2);var c=Math.pow(_9d[1].x,2);var d=Math.pow(_9d[1].y,2);var rx=Math.sqrt((a*d-b*c)/(d-b));var ry=Math.sqrt((a*d-b*c)/(a-c));if(rx<ry){var t=rx;rx=ry;ry=t;_9c-=Math.PI/2;}var top=_6.gfx3d.matrix.multiplyPoint(m,_6.gfx3d.vector.sum(this.object.center,{x:0,y:0,z:this.object.height}));var _a7=this.fillStyle.type=="constant"?this.fillStyle.color:_6.gfx3d.gradient(this.renderer.lighting,this.fillStyle,this.object.center,this.object.radius,Math.PI,2*Math.PI,m);if(isNaN(rx)||isNaN(ry)||isNaN(_9c)){rx=this.object.radius,ry=0,_9c=0;}this.cache={center:_94,top:top,rx:rx,ry:ry,theta:_9c,gradient:_a7};},draw:function(){var c=this.cache,v=_6.gfx3d.vector,m=_6.gfx.matrix,_ab=[c.center,c.top],_ac=v.substract(c.top,c.center);if(v.dotProduct(_ac,this.renderer.lighting.incident)>0){_ab=[c.top,c.center];_ac=v.substract(c.center,c.top);}var _ad=this.renderer.lighting[this.fillStyle.type](_ac,this.fillStyle.finish,this.fillStyle.color),d=Math.sqrt(Math.pow(c.center.x-c.top.x,2)+Math.pow(c.center.y-c.top.y,2));if(this.shape){this.shape.clear();}else{this.shape=this.renderer.createGroup();}this.shape.createPath("").moveTo(0,-c.rx).lineTo(d,-c.rx).lineTo(d,c.rx).lineTo(0,c.rx).arcTo(c.ry,c.rx,0,true,true,0,-c.rx).setFill(c.gradient).setStroke(this.strokeStyle).setTransform([m.translate(_ab[0]),m.rotate(Math.atan2(_ab[1].y-_ab[0].y,_ab[1].x-_ab[0].x))]);if(c.rx>0&&c.ry>0){this.shape.createEllipse({cx:_ab[1].x,cy:_ab[1].y,rx:c.rx,ry:c.ry}).setFill(_ad).setStroke(this.strokeStyle).applyTransform(m.rotateAt(c.theta,_ab[1]));}}});_4.declare("dojox.gfx3d.Viewport",_6.gfx.Group,{constructor:function(){this.dimension=null;this.objects=[];this.todos=[];this.renderer=this;this.schedule=_6.gfx3d.scheduler.zOrder;this.draw=_6.gfx3d.drawer.conservative;this.deep=false;this.lights=[];this.lighting=null;},setCameraTransform:function(_af){this.camera=_6.gfx3d.matrix.clone(_af?_6.gfx3d.matrix.normalize(_af):_6.gfx3d.identity,true);this.invalidate();return this;},applyCameraRightTransform:function(_b0){return _b0?this.setCameraTransform([this.camera,_b0]):this;},applyCameraLeftTransform:function(_b1){return _b1?this.setCameraTransform([_b1,this.camera]):this;},applyCameraTransform:function(_b2){return this.applyCameraRightTransform(_b2);},setLights:function(_b3,_b4,_b5){this.lights=(_b3 instanceof Array)?{sources:_b3,ambient:_b4,specular:_b5}:_b3;var _b6={x:0,y:0,z:1};this.lighting=new _6.gfx3d.lighting.Model(_b6,this.lights.sources,this.lights.ambient,this.lights.specular);this.invalidate();return this;},addLights:function(_b7){return this.setLights(this.lights.sources.concat(_b7));},addTodo:function(_b8){if(_4.every(this.todos,function(_b9){return _b9!=_b8;})){this.todos.push(_b8);}},invalidate:function(){this.deep=true;this.todos=this.objects;},setDimensions:function(dim){if(dim){var w=_4.isString(dim.width)?parseInt(dim.width):dim.width;var h=_4.isString(dim.height)?parseInt(dim.height):dim.height;var trs=this.rawNode.style;trs.height=h;trs.width=w;this.dimension={width:w,height:h};}else{this.dimension=null;}},render:function(){if(!this.todos.length){return;}var m=_6.gfx3d.matrix;for(var x=0;x<this.todos.length;x++){this.todos[x].render(_6.gfx3d.matrix.normalize([m.cameraRotateXg(180),m.cameraTranslate(0,this.dimension.height,0),this.camera]),this.deep);}this.objects=this.schedule(this.objects);this.draw(this.todos,this.objects,this);this.todos=[];this.deep=false;}});_6.gfx3d.Viewport.nodeType=_6.gfx.Group.nodeType;_6.gfx3d._creators={createEdges:function(_c0,_c1){return this.create3DObject(_6.gfx3d.Edges,_c0,_c1);},createTriangles:function(_c2,_c3){return this.create3DObject(_6.gfx3d.Triangles,_c2,_c3);},createQuads:function(_c4,_c5){return this.create3DObject(_6.gfx3d.Quads,_c4,_c5);},createPolygon:function(_c6){return this.create3DObject(_6.gfx3d.Polygon,_c6);},createOrbit:function(_c7){return this.create3DObject(_6.gfx3d.Orbit,_c7);},createCube:function(_c8){return this.create3DObject(_6.gfx3d.Cube,_c8);},createCylinder:function(_c9){return this.create3DObject(_6.gfx3d.Cylinder,_c9);},createPath3d:function(_ca){return this.create3DObject(_6.gfx3d.Path3d,_ca);},createScene:function(){return this.create3DObject(_6.gfx3d.Scene);},create3DObject:function(_cb,_cc,_cd){var obj=new _cb();this.adopt(obj);if(_cc){obj.setObject(_cc,_cd);}return obj;},adopt:function(obj){obj.renderer=this.renderer;obj.parent=this;this.objects.push(obj);this.addTodo(obj);return this;},abandon:function(obj,_d1){for(var i=0;i<this.objects.length;++i){if(this.objects[i]==obj){this.objects.splice(i,1);}}obj.parent=null;return this;},setScheduler:function(_d3){this.schedule=_d3;},setDrawer:function(_d4){this.draw=_d4;}};_4.extend(_6.gfx3d.Viewport,_6.gfx3d._creators);_4.extend(_6.gfx3d.Scene,_6.gfx3d._creators);delete _6.gfx3d._creators;_4.extend(_6.gfx.Surface,{createViewport:function(){var _d5=this.createObject(_6.gfx3d.Viewport,null,true);_d5.setDimensions(this.getDimensions());return _d5;}});}}};});