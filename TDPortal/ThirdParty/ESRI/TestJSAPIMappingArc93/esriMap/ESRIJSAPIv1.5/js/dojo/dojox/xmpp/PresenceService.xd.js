/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.xmpp.PresenceService"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.xmpp.PresenceService"]){_4._hasResource["dojox.xmpp.PresenceService"]=true;_4.provide("dojox.xmpp.PresenceService");_6.xmpp.presence={UPDATE:201,SUBSCRIPTION_REQUEST:202,SUBSCRIPTION_SUBSTATUS_NONE:204,SUBSCRIPTION_NONE:"none",SUBSCRIPTION_FROM:"from",SUBSCRIPTION_TO:"to",SUBSCRIPTION_BOTH:"both",SUBSCRIPTION_REQUEST_PENDING:"pending",STATUS_ONLINE:"online",STATUS_AWAY:"away",STATUS_CHAT:"chat",STATUS_DND:"dnd",STATUS_EXTENDED_AWAY:"xa",STATUS_OFFLINE:"offline",STATUS_INVISIBLE:"invisible"};_4.declare("dojox.xmpp.PresenceService",null,{constructor:function(_7){this.session=_7;this.isInvisible=false;this.avatarHash=null;this.presence=null;this.restrictedContactjids={};},publish:function(_8){this.presence=_8;this._setPresence();},sendAvatarHash:function(_9){this.avatarHash=_9;this._setPresence();},_setPresence:function(){var _a=this.presence;var p={xmlns:"jabber:client"};if(_a&&_a.to){p.to=_a.to;}if(_a.show&&_a.show==_6.xmpp.presence.STATUS_OFFLINE){p.type="unavailable";}if(_a.show&&_a.show==_6.xmpp.presence.STATUS_INVISIBLE){this._setInvisible();this.isInvisible=true;return;}if(this.isInvisible){this._setVisible();}var _c=new _6.string.Builder(_6.xmpp.util.createElement("presence",p,false));if(_a.show&&_a.show!=_6.xmpp.presence.STATUS_OFFLINE){_c.append(_6.xmpp.util.createElement("show",{},false));_c.append(_a.show);_c.append("</show>");}if(_a.status){_c.append(_6.xmpp.util.createElement("status",{},false));_c.append(_a.status);_c.append("</status>");}if(this.avatarHash){_c.append(_6.xmpp.util.createElement("x",{xmlns:"vcard-temp:x:update"},false));_c.append(_6.xmpp.util.createElement("photo",{},false));_c.append(this.avatarHash);_c.append("</photo>");_c.append("</x>");}if(_a.priority&&_a.show!=_6.xmpp.presence.STATUS_OFFLINE){if(_a.priority>127||_a.priority<-128){_a.priority=5;}_c.append(_6.xmpp.util.createElement("priority",{},false));_c.append(_a.priority);_c.append("</priority>");}_c.append("</presence>");this.session.dispatchPacket(_c.toString());},toggleBlockContact:function(_d){if(!this.restrictedContactjids[_d]){this.restrictedContactjids[_d]=this._createRestrictedJid();}this.restrictedContactjids[_d].blocked=!this.restrictedContactjids[_d].blocked;this._updateRestricted();return this.restrictedContactjids;},toggleContactInvisiblity:function(_e){if(!this.restrictedContactjids[_e]){this.restrictedContactjids[_e]=this._createRestrictedJid();}this.restrictedContactjids[_e].invisible=!this.restrictedContactjids[_e].invisible;this._updateRestricted();return this.restrictedContactjids;},_createRestrictedJid:function(){return {invisible:false,blocked:false};},_updateRestricted:function(){var _f={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"};var req=new _6.string.Builder(_6.xmpp.util.createElement("iq",_f,false));req.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},false));req.append(_6.xmpp.util.createElement("list",{name:"iwcRestrictedContacts"},false));var _11=1;for(var jid in this.restrictedContactjids){var _13=this.restrictedContactjids[jid];if(_13.blocked||_13.invisible){req.append(_6.xmpp.util.createElement("item",{value:_6.xmpp.util.encodeJid(jid),action:"deny",order:_11++},false));if(_13.blocked){req.append(_6.xmpp.util.createElement("message",{},true));}if(_13.invisible){req.append(_6.xmpp.util.createElement("presence-out",{},true));}req.append("</item>");}else{delete this.restrictedContactjids[jid];}}req.append("</list>");req.append("</query>");req.append("</iq>");var _14=new _6.string.Builder(_6.xmpp.util.createElement("iq",_f,false));_14.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},false));_14.append(_6.xmpp.util.createElement("active",{name:"iwcRestrictedContacts"},true));_14.append("</query>");_14.append("</iq>");this.session.dispatchPacket(req.toString());this.session.dispatchPacket(_14.toString());},_setVisible:function(){var _15={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"};var req=new _6.string.Builder(_6.xmpp.util.createElement("iq",_15,false));req.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},false));req.append(_6.xmpp.util.createElement("active",{},true));req.append("</query>");req.append("</iq>");this.session.dispatchPacket(req.toString());},_setInvisible:function(){var _17={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"};var req=new _6.string.Builder(_6.xmpp.util.createElement("iq",_17,false));req.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},false));req.append(_6.xmpp.util.createElement("list",{name:"invisible"},false));req.append(_6.xmpp.util.createElement("item",{action:"deny",order:"1"},false));req.append(_6.xmpp.util.createElement("presence-out",{},true));req.append("</item>");req.append("</list>");req.append("</query>");req.append("</iq>");_17={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"};var _19=new _6.string.Builder(_6.xmpp.util.createElement("iq",_17,false));_19.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},false));_19.append(_6.xmpp.util.createElement("active",{name:"invisible"},true));_19.append("</query>");_19.append("</iq>");this.session.dispatchPacket(req.toString());this.session.dispatchPacket(_19.toString());},_manageSubscriptions:function(_1a,_1b){if(!_1a){return;}if(_1a.indexOf("@")==-1){_1a+="@"+this.session.domain;}var req=_6.xmpp.util.createElement("presence",{to:_1a,type:_1b},true);this.session.dispatchPacket(req);},subscribe:function(_1d){this._manageSubscriptions(_1d,"subscribe");},approveSubscription:function(_1e){this._manageSubscriptions(_1e,"subscribed");},unsubscribe:function(_1f){this._manageSubscriptions(_1f,"unsubscribe");},declineSubscription:function(_20){this._manageSubscriptions(_20,"unsubscribed");},cancelSubscription:function(_21){this._manageSubscriptions(_21,"unsubscribed");}});}}};});